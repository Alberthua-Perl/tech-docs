<html>
<head>
  <title>Kubernetes v1.13.4 HA 集群搭建配置</title>
  <basefont face="JetBrains Mono NL" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/605627 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: JetBrains Mono NL;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1096"/>

<div>
<span><div><span style="font-size: 14pt; color: rgb(45, 79, 201); font-weight: bold;">Kubernetes v1.13.4 HA集群搭建配置</span></div><div><span style="font-size: 11pt;"><img src="Kubernetes v1.13.4 HA集群搭建配置_files/docker.png" type="image/png" data-filename="docker.png" width="245"/></span></div><div><span style="font-size: 11pt; font-weight: bold;">文档说明：</span></div><div><ul><li><div><span style="font-size: 11pt;">该Kubernetes HA集群将etcd数据库分别运行于三个master节点上。</span></div></li><li><div><span style="font-size: 11pt;">该Kubernetes版本中kubeadm与CoreDNS已为GA状态。</span></div></li><li><div><span style="font-size: 11pt;">该Kubernetes集群中未使用ipvs。</span></div></li></ul><div><br/></div><div><font style="font-size: 11pt;"><span style="font-size: 11pt; font-weight: bold;">生产环境建议：</span></font></div><ul><li><div><span style="font-size: 11pt;">生产环境中建议将高可用HA etcd数据库集群运行于Kubernetes集群外，降低master</span></div></li></ul><div><span style="font-size: 11pt;">     节点</span><span style="font-size: 11pt;">负载，</span><span style="font-size: 11pt;">并且确保数据安全性！</span></div><ul><li><div><span style="font-size: 11pt;">生产环境中也可使用二进制的方式部署高可用HA集群，安装灵活性更高，版本升级或</span></div></li></ul><div><span style="font-size: 11pt;">     回退更</span><span style="font-size: 11pt;">方便。</span></div><div><br/></div></div><div><span style="font-size: 11pt; font-weight: bold;">集群资源与架构说明：</span></div><div><ul><li><div><span style="font-size: 11pt;">OS版本：CentOS Linux release 7.6.1810 (Core) 最小化安装 </span></div></li><li><div><span style="font-size: 11pt;">Kubernetes版本：1.13.4</span></div></li></ul></div><div><span style="font-size: 11pt;">     kubeadm版本：1.13.4</span></div><div><span style="font-size: 11pt;">     kubelet版本：1.13.4</span></div><div><span style="font-size: 11pt;">     kubectl版本：1.13.4</span></div><div><span style="font-size: 11pt;">     Docker版本：18.06.1-ce</span></div><div><ul><li><div><span style="font-size: 11pt;">集群各节点硬件资源与角色：</span></div></li></ul><div><span style="font-size: 11pt;">     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/Image.png" type="image/png" data-filename="Image.png" width="576"/></span></div></div><div><br/></div><div><span style="font-size: 11pt;"><span style="font-size: 11pt; font-weight: bold;">集群物理网络拓扑与Overlay网络连接：</span></span></div><div><span style="font-size: 11pt;">     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/kubernetes-ha-install（1）.jpg" type="image/jpeg" data-filename="kubernetes-ha-install（1）.jpg" width="495"/></span></div><div><br/></div><div><span style="font-size: 11pt; font-weight: bold;">集群逻辑架构：</span></div><div><span style="font-size: 11pt;">     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/kubernetes-ha-install（1）.png" type="image/png" data-filename="kubernetes-ha-install（1）.png" width="494"/></span></div><div><br/></div><div><br/></div><div><span style="font-size: 11pt; font-weight: bold;">集群部署介绍：</span></div><div><ul><li><div><span style="font-size: 11pt;">部署高可用集群必须先添加第一个master节点，再添加其他master节点组成高可用HA。</span></div></li><li><div><span style="font-size: 11pt;">最后添加其他worker node工作节点。</span></div></li></ul></div><div><br/></div><div><span style="font-size: 11pt; font-weight: bold;">kubeadm功能概述：</span></div><div><ul><li><div><span style="font-size: 11pt; font-weight: bold;">kubeadm 1.13.4已进入GA（general availability）状态，可用于部署高可用</span><span style="font-size: 11pt; font-weight: bold;">集群。</span><span style="font-size: 11pt;">       </span></div></li><li><div><span style="font-size: 11pt;">kubeadm init：</span></div></li></ul><div><span style="font-size: 11pt;">     初始化启动Kubernetes master节点</span></div><ul><li><div><span style="font-size: 11pt;">kubeadm join：</span></div></li></ul><div><span style="font-size: 11pt;">     启动节点将其加入集群，成为worker node工作节点或HA master节点。</span></div><ul><li><div><span style="font-size: 11pt;">kubeadm upgrade：</span></div></li></ul><div><span style="font-size: 11pt;">     平滑升级Kubernetes集群至新版本</span></div><ul><li><div><span style="font-size: 11pt;">kubeadm config：</span></div></li></ul><div><span style="font-size: 11pt;">     若使用v1.7.x或者更低版本的kubeadm初始化集群，需对集群做配置以</span><span style="font-size: 11pt;">使用</span></div><div><span style="font-size: 11pt;">     kubeadm </span><span style="font-size: 11pt;">upgrade命令。</span></div><ul><li><div><span style="font-size: 11pt;"><span style="font-size: 11pt; font-weight: bold;">kubeadm token</span>：</span></div></li></ul><div><span style="font-size: 11pt;">     管理bootstrap时生成的token</span></div><ul><li><div><span style="font-size: 11pt;">kubeadm reset：</span></div></li></ul><div><span style="font-size: 11pt;">     重置由kubeadm配置的节点，使其能重新执行kubeadm init或kubeadm join。</span></div><ul><li><div><span style="font-size: 11pt;">kubeadm version：</span></div></li></ul><div><span style="font-size: 11pt;">     查看kubeadm版本</span></div><ul><li><div><span style="font-size: 11pt;">kubeadm alpha：</span></div></li></ul><div><span style="font-size: 11pt;">     预览一组可用的新功能以便从社区搜集反馈      </span></div><div><br/></div><div><span style="font-size: 11pt; font-weight: bold;">OS基础环境配置：以下配置完成后，重启所有节点确保其生效。</span></div><div><ul><li><div><span style="font-size: 11pt;">所有节点关闭SELinux，并且开机禁用SELinux。</span></div></li></ul><div><span style="font-size: 11pt;">     root@all-nodes:</span></div><div><span style="font-size: 11pt;">     $ sed -i 's/^SELINUX=enforcing$/SELINUX=disabled/' /etc/selinux/config</span></div></div><div><ul><li><div><span style="font-size: 11pt;">所有节点关闭firewalld.service服务，并且禁用开机自启动。</span></div></li></ul><div><span style="font-size: 11pt;">     root@all-nodes:</span></div><div><span style="font-size: 11pt;">   </span> <span style="font-size: 11pt;"> </span><span style="font-size: 11pt;">$</span> <span style="font-size: 11pt;">systemctl stop firewalld.service &amp;&amp; \</span></div></div><div><span style="font-size: 11pt;">       systemctl disable firewalld.service</span></div><div><ul><li><div><span style="font-size: 11pt;">所有节点关闭NetworkManager.service服务，并且禁用开机自启动。</span></div></li></ul><div><span style="font-size: 11pt;">     root@all-nodes:</span></div><div><span style="font-size: 11pt;">     $ systemctl stop NetworkManager.service &amp;&amp; \</span></div></div><div><span style="font-size: 11pt;">       systemctl disable NetworkManager.service</span></div><div><br/></div><div><ul><li><div><span style="font-size: 11pt;">所有节点禁用Swap设备：</span></div></li></ul><div><span style="font-size: 11pt;">     1.</span> <span style="font-size: 11pt; font-weight: bold;">kubeadm默认会预先检查当前主机是否禁用了Swap设备，如果启动了Swap设备将导致</span></div><div><span style="font-size: 11pt; font-weight: bold;">        安装</span><span style="font-size: 11pt; font-weight: bold;">不能正常进行。</span></div></div><div><span style="font-size: 11pt;">     2. 编辑/etc/fstab文件，注释swap类型设备。       </span></div><div><br/></div><div><ul><li><div><span style="font-size: 11pt;">所有节点配置系统内核参数：</span></div></li></ul><div><span style="font-size: 11pt;">     root@all-nodes:</span></div><div><span style="font-size: 11pt;">     # vim /etc/sysctl.d/k8s.conf</span></div></div><div><span style="font-size: 11pt; font-weight: bold;">       vm.swappiness = 0</span></div><div><span style="font-size: 11pt; font-weight: bold;">       net.ipv4.ip_forward = 1</span></div><div><span style="font-size: 11pt; font-weight: bold;">       <span style="font-size: 11pt;"><span style="font-size: 11pt; font-weight: bold; color: rgb(250, 122, 0); font-style: italic;">net.bridge.bridge-nf-call-iptables = 1</span></span></span></div><div><span style="font-size: 11pt;"><span style="font-size: 11pt;"><span style="font-size: 11pt; color: rgb(250, 122, 0); font-style: italic; font-weight: bold;">       net.bridge.bridge-nf-call-ip6tables = 1</span></span></span></div><div><span style="font-size: 11pt;"><span style="font-size: 11pt;"><br/></span></span></div><div><span style="font-size: 11pt;"><span style="font-size: 11pt; color: rgb(0, 0, 255); font-weight: bold;">     * 注意：</span></span><span style="font-size: 11pt; font-weight: bold;">Linux bridge与</span><span style="font-size: 11pt; font-weight: bold;">iptables</span><span style="font-size: 11pt; font-weight: bold;">之间的关系</span></div><div><span style="font-size: 11pt; font-weight: bold;">       </span><span style="font-size: 11pt;">1.</span> <span style="font-size: 11pt;">Linux</span>透明防火墙（transparent firewall）又称桥接模式防火墙</div><div>         （bridge firewall），即在网桥设备上加入防火墙功能。</div><div>       2. docker-ce-18.09.0必须支持内核参数：</div><div>          <span style="font-weight: bold;">net.bridge.bridge-nf-call-iptables = 1</span></div><div>          <span style="font-weight: bold;">net.bridge.bridge-nf-call-ip6tables = 1</span></div><div><span style="font-weight: bold;">          </span><span style="font-weight: bold;"><img src="Kubernetes v1.13.4 HA集群搭建配置_files/1.JPG" type="image/jpeg" data-filename="1.JPG" width="460"/></span></div><div><span style="font-weight: bold;">          </span><span style="font-weight: bold;"><img src="Kubernetes v1.13.4 HA集群搭建配置_files/2.JPG" type="image/jpeg" data-filename="2.JPG" width="460"/></span></div><div>       </div><div>       3. 默认情况下，数据包经由网桥（工作于数据链路层）直接转发，iptables配置的</div><div>          转发策略（工作于网络层）不对数据包生效。</div><div>       4. 当以上内核参数开启状态下，经由网桥转发的数据包将通过iptables的 <span style="font-weight: bold; font-style: italic; color: rgb(250, 122, 0);">filter</span> 表</div><div>          中 <span style="font-weight: bold; font-style: italic; color: rgb(250, 122, 0);">FORWARD</span> 链规则进行匹配，匹配的数据包才能转发。</div><div>       5. <span style="font-weight: bold;">当以上内核参数开启状态下，iptables的filter表中FORWARD链规则又为DROP时，</span></div><div><span style="font-weight: bold;">    </span><span style="font-weight: bold;">     </span> <span style="font-weight: bold;">数据包依然不能直接经由网桥转发，将被丢弃！</span>     </div><div><br/></div><div><ul><li><div><span style="font-size: 11pt;">加载Linux透明防火墙内核模块：</span></div></li></ul><div><span style="font-size: 11pt;">     root@all-nodes:</span></div><div><span style="font-size: 11pt;">     <span style="font-size: 11pt; font-weight: bold;">$</span><span style="font-size: 11pt; font-weight: bold;"> modprobe br_netfilter</span></span></div></div><div><span style="font-size: 11pt;">     $ lsmod | grep br_netfilter</span></div><div><br/></div><div><ul><li><div><span style="font-size: 11pt;">所有节点配置/etc/hosts文件：</span></div></li></ul><div><span style="font-size: 11pt;">     root@all-nodes:</span></div><div><span style="font-size: 11pt;">     $ cat /etc/hosts</span></div></div><div><span style="font-size: 11pt;">     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/Image [1].png" type="image/png" data-filename="Image.png" width="379"/></span></div><div><br/></div><div><ul><li><div><span style="font-size: 11pt;">所有节点配置NTP时间服务器：</span></div></li></ul><div><span style="font-size: 11pt;">     1. 该测试环境中使用ntpd服务，以及上游阿里云NTP时间服务器（</span><span style="font-size: 11pt; font-weight: bold;">ntp1.aliyun.com</span><span style="font-size: 11pt;">）。</span></div></div><div><span style="font-size: 11pt;">     2. 使用ntpdate命令直接同步时间。</span></div><div><span style="font-size: 11pt;">        root@all-nodes:</span></div><div><span style="font-size: 11pt;">        $ ntpdate</span> <a href="http://ntp1.aliyun.com/" style="font-size: 11pt; color: rgb(0, 0, 0);">ntp1.aliyun.com</a></div><div><span style="font-size: 11pt;">        $ echo &quot;ntp1.aliyun.com&quot;</span> <span style="font-size: 11pt; font-family: &quot;DejaVu Sans Mono&quot;;">&gt;&gt;</span> <span style="font-size: 11pt;">/etc/ntp.conf</span></div><div><span style="font-size: 11pt;">        $ systemctl start ntpd.service &amp;&amp; systemctl enable ntpd.service</span></div><div><br/></div><div><ul><li><div><span style="font-size: 11pt;">所有节点安装相关依赖软件包：</span></div></li></ul><div><span style="font-size: 14.6667px;">     root@all-nodes:</span></div></div></div><div><span style="font-size: 11pt;">     </span><span style="font-size: 11pt; font-weight: bold;">$</span><span style="font-size: 11pt;"> </span><span style="font-size: 11pt; font-weight: bold;">yum install -y \</span></div><div><span style="font-size: 11pt;"><span style="font-size: 11pt; font-weight: bold;">       conntrack-tools libseccomp libtool-ltdl net-tools wget curl psmics</span></span></div><div><br/></div><div><span style="font-size: 11pt; font-weight: bold;">安装与配置Keepalived：</span></div><div><ul><li><div><span style="font-size: 11pt;">Keepalived为HAProxy提供VIP（172.25.250.86）在三个HAProxy master节点之间</span></div></li></ul><div><span style="font-size: 11pt;">     提供</span><span style="font-size: 11pt;">主备，</span><span style="font-size: 11pt;">降低当其中一个</span><span style="font-size: 11pt;">HAProxy失效时对Kubernetes master节点的影响。</span></div></div><div><ul><li><div><span style="font-size: 11pt;">三个master节点分别安装Keepalived：以在kube-master0上安装为例</span></div></li></ul><div><span style="font-size: 11pt;">     root@kube-master0:</span></div><div><span style="font-size: 11pt;">     $ yum install -y keepalived</span></div></div><div><br/></div><div><ul><li><div><span style="font-size: 11pt;">三个master节点配置Keepalived：<span style="font-size: 11pt;">以在kube-master0上安装为例，该节点配置为</span></span></div></li></ul><div><span style="font-size: 11pt;"><span style="font-size: 11pt;">     MASTER。</span></span></div><div><span style="font-size: 11pt;">     root@kube-master0:</span></div><div><span style="font-size: 11pt;">     $ vim /etc/keepalived/keepalived.conf</span></div><div><span style="font-size: 11pt;">     <span style="font-size: 11pt; font-weight: bold;">// kube-master0节点的priority值为250，其余两节点该值为100。</span></span></div><div><span style="font-size: 11pt;">     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/1 [1].JPG" type="image/jpeg" data-filename="1.JPG" width="497"/></span></div></div><div><br/></div><div><span style="font-size: 11pt;">     $ vim /etc/keepalived/check_haproxy.sh</span></div><div><span style="font-size: 11pt;">     // 该脚本在再次启动HAProxy失败的情况下，停止Keepalived服务，由其余两节点选举</span></div><div><span style="font-size: 11pt;">        成为</span><span style="font-size: 11pt;">MASTER接管服务。</span></div><div><span style="font-size: 11pt;">     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/2 [1].JPG" type="image/jpeg" data-filename="2.JPG" width="496"/></span></div><div><br/></div><div><span style="font-size: 11pt;">     $ systemctl enable keepalived.service</span></div><div><span style="font-size: 11pt;">     $ systemctl start keepalived.service</span></div><div><span style="font-size: 11pt;">     $ systemctl status keepalived.service</span></div><div><span style="font-size: 11pt;">     $ ip address show eth1</span></div><div><span style="font-size: 11pt;">     // <span style="font-size: 11pt;">当关掉当前节点的Keepalived服务后将进行VIP漂移，将会推选state为BACKUP的节点</span></span></div><div><span style="font-size: 11pt;"><span style="font-size: 11pt;">        的</span></span><span style="font-size: 11pt;"><span style="font-size: 11pt;">某</span></span><span style="font-size: 11pt;"><span style="font-size: 11pt;">一节点为新的MASTER，</span></span><span style="font-size: 11pt;">可以在那台节点上查看网口中具有VIP。</span></div><div><span style="font-size: 11pt;">     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/Image [2].png" type="image/png" data-filename="Image.png" width="496"/></span></div><div><br/></div><div><span style="font-size: 11pt; font-weight: bold;">安装与配置HAProxy：</span></div><div><ul><li><div><span style="font-size: 11pt;">此处的HAProxy为kube-apiserver提供反向代理，HAProxy将所有请求轮询转发到</span></div></li></ul><div><span style="font-size: 11pt;">     每个master</span><span style="font-size: 11pt;">节点上。</span></div><ul><li><div><span style="font-size: 11pt;">相对于仅仅使用单个Kubernetes master节点承载流量，这种方式更加合理、健壮。</span></div></li><li><div><span style="font-size: 11pt;">三个master节点分别安装HAProxy：以在kube-master0上安装为例</span></div></li></ul><div><span style="font-size: 11pt;">     root@kube-master0:   </span></div><div><span style="font-size: 11pt;">     $ yum install -y haproxy</span></div></div><div><br/></div><div><ul><li><div><span style="font-size: 11pt;">三个master节点配置HAProxy：以在kube-master0上安装为例</span></div></li></ul><div><span style="font-size: 11pt;">     root@kube-master0:</span></div></div><div><span style="font-size: 11pt;">     $ vim /etc/haproxy/haproxy.conf</span></div><div><span style="font-size: 11pt;">     // 该配置文件中添加以下内容，</span><span style="font-size: 11pt;">HAProxy在其余两个master节点上的配置都相同。</span></div><div><span style="font-size: 11pt;">     </span><span style="font-size: 11pt; color: rgb(255, 0, 0); font-weight: bold;">// 每个高可用HA master节点接受不同的请求，其后端etcd数据库数据如何保持一致?</span></div><div><span style="font-size: 11pt;">     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/Image [3].png" type="image/png" data-filename="Image.png" width="497"/></span></div><div><br/></div><div><span style="font-size: 11pt;">     $ systemctl enable haproxy.service</span></div><div><span style="font-size: 11pt;">     $ systemctl start haproxy.service</span></div><div><span style="font-size: 11pt;">     $ systemctl status haproxy.service</span></div><div><span style="font-size: 11pt;">     $<span style="font-size: 11pt; font-weight: bold;"> netstat -tunlp | egrep &quot;16443|1080&quot;</span></span></div><div><span style="font-size: 11pt;">     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/8.JPG" type="image/jpeg" data-filename="8.JPG" width="496"/></span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">安装Docker容器引擎：</span></div><div><ul><li><div>所有节点必须安装Docker容器引擎以支持Pod运行。</div></li><li><div>所有节点配置Docker yum源：<span style="font-size: 11pt;">以在kube-master0上配置为例</span></div></li></ul><div>     root@kube-master0:</div></div><div>     <span style="font-weight: bold;">$</span><span style="font-weight: bold;"> yum-config-manager \</span></div><div><span style="font-weight: bold;">       --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></div><div>     // 安装Docker可以从官方yum源下载对应版本，不过由于官方下载速度比较慢，所以推荐</div><div>        用阿里镜像源。</div><div><br/></div><div><ul><li><div><span style="font-size: 11pt;">所有节点安装Docker：</span><span style="font-size: 11pt;">以在kube-master0上安装为例</span></div></li></ul><div><span style="font-size: 11pt;">     root@kube-master0:</span></div></div><div><span style="font-size: 11pt;">     $<span style="font-size: 11pt; font-weight: bold;"> yum list docker-ce --showduplicates | sort -r</span></span></div><div><span style="font-size: 11pt;">     $ yum install -y docker-ce-18.06.1.ce-3.el7</span></div><div><span style="font-size: 11pt;">     $ vim /usr/lib/systemd/system/docker.service</span></div><div><span style="font-size: 11pt;">       </span><span style="font-size: 11pt; font-weight: bold;">ExecStart=/usr/bin/dockerd</span> <span style="font-size: 11pt;"><span style="font-size: 11pt; color: rgb(250, 122, 0); font-style: italic; font-weight: bold;">--graph /k8s/docker</span></span></div><div><span style="font-size: 11pt;">     // 修改Docker根目录为/k8s/docker，应先将其挂载至较大空间的存储设备。</span></div><div><span style="font-size: 11pt;">     $ systemctl daemon-reload</span></div><div><span style="font-size: 11pt;">     $ systemctl start docker.service</span></div><div><br/></div><div><ul><li><div><span style="font-size: 11pt;">确认iptables</span></div></li></ul><div>     1. Docker自v1.13.x版本开始默认将iptables的filter表中FORWARD链策略配置为DROP，这样</div><div>        会引起集群中跨Node的Pod无法通信，需将其配置为ACCEPT:</div><div>        <span style="color: rgb(0, 0, 255); font-weight: bold;">$ sudo iptables --policy FORWARD ACCEPT</span></div></div><div>     2. 但这里通过安装Docker <span style="font-size: 11pt;">18.06.1-ce</span>，发现默认策略又改回了ACCEPT，因此无需更改。    </div><div>        <img src="Kubernetes v1.13.4 HA集群搭建配置_files/Image [4].png" type="image/png" data-filename="Image.png" width="554"/></div><div><br/></div><div><span style="font-weight: bold;">安装kubeadm与kubelet：</span></div><div><ul><li><div>所有节点安装kubeadm、kubelet与kubectl软件包。</div></li><li><div>kubeadm：</div></li></ul><div>     初始化Kubernetes集群的指令</div><ul><li><div>kubelet：</div></li></ul><div>     Kubernetes集群中每个节点上启动Pod、与kube-apiserver通信的组件。</div><ul><li><div>kubectl：</div></li></ul><div>     与Kubernetes集群通信的CLI工具</div><ul><li><div>所有节点配置国内可用的yum源：<span style="font-size: 11pt;">以在kube-master0上配置为例</span></div></li></ul><div>     root@kube-master0:</div></div><div>     $ vim /etc/yum.repos.d/kubernetes.repo</div><div>       [kubernetes]</div><div>       name=Kubernetes 1.13.4</div><div>       baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</div><div>       enabled=1</div><div>       gpgcheck=0</div><div>       repo_gpgcheck=0</div><div>       gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg \</div><div>              https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</div><div><br/></div><div><ul><li><div><span style="font-size: 11pt;">所有节点安装kubelet、kubectl与kubeadm：以在kube-master0上安装为例</span></div></li></ul><div>     root@kube-master0:</div></div><div>     $ yum list kubelet --showduplicates | sort -r</div><div>     $ yum install -y kubelet-1.13.4-0</div><div>     $ systemctl enable kubelet.service</div><div>     $ systemctl start kubelet.service</div><div>     $ yum list kubectl --showduplicates | sort -r</div><div>     $ yum install -y kubectl-1.13.4-0</div><div>     $ yum list kubeadm --showduplicates | sort -r</div><div>     $ yum install -y kubeadm-1.13.4-0 </div><div>     </div><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">*</span><span style="color: rgb(0, 0, 255); font-weight: bold;"> 注意：</span></div><div>       1. <span style="font-weight: bold;">注意以上软件包的安装顺序，一定不要先安装kubeadm！</span></div><div>       2. 因为kubeadm会自动安装最新版本的kubelet与kubectl，导致版本不一致问题。  </div><div>       3. 若检查kubelet状态时为failed状态，等master节点初始化完成后即可显示正常。    </div><div><br/></div><div><span style="font-weight: bold;">初始化第一个Kubernetes HA master节点：</span></div><div><ul><li><div><span style="font-weight: bold;">初始化第一个Kubernetes HA master节点需要绑定VIP，因此必须先查看VIP在哪台</span></div></li></ul><div><span style="font-weight: bold;">     master</span><span style="font-weight: bold;">节点上。</span></div><ul><li><div>该VIP在kube-master0节点上，因此初始化kube-master0节点。</div></li><li><div>创建kubeadm的YAML配置文件并初始化master节点：</div></li></ul><div>     root@kube-master0:</div></div><div>     $ vim kubeadm-config.yaml</div><div>     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/Image [5].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><div>     $<span style="font-weight: bold;"> kubeadm init --config kubeadm-config.yaml</span></div><div>     // 使用日志中的kubeadm join命令将其余节点添加入集群中</div><div>     // 完整安装日志与截图如下所示：</div><div>     <a href="Kubernetes v1.13.4 HA集群搭建配置_files/kubeadm-init-ha-master.log"><img src="Kubernetes v1.13.4 HA集群搭建配置_files/df57ed6420e162b67964ed7f0f8fea3d.png" alt="kubeadm-init-ha-master.log"></a></div><div>     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/kube_init_master .JPG" type="image/jpeg" data-filename="kube_init_master .JPG" width="497"/></div><div><br/></div><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>       <span style="font-weight: bold;">$ kubeadm config print init-defaults</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; font-weight: bold;">&gt;</span> <span style="font-weight: bold;">kubeadm-config-template.yaml</span></div><div>       // 导出kubeadm-config.yaml集群部署配置文件模板（需根据kubeadm版本的不同）   </div><div><br/></div><div><ul><li><div>配置kubectl环境变量与查看资源状态：</div></li></ul><div>     root@kube-master0:</div></div><div>     <span style="font-weight: bold;">$</span><span style="font-weight: bold;"> mkdir -p $HOME/.kube </span></div><div><span style="font-weight: bold;">     $ cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span></div><div><span style="font-weight: bold;">     $ chown $(id -u):$(id -g) $HOME/.kube/config</span></div><div><br/></div><div>     $ kubectl get nodes</div><div>     // 查看Kubernetes集群节点状态</div><div>     // 由于集群内未部署CNI网络插件，因此kube-master0节点为<span style="font-weight: bold;">NotReady状态</span>。</div><div><br/></div><div>     <span style="font-weight: bold;">$</span><span style="font-weight: bold;"> kubectl get pods --namespace=kube-system</span></div><div>     // 查看kube-system命名空间中的Pod状态</div><div>    </div><div><span style="color: rgb(0, 0, 255); font-weight: bold;">     * 注意：</span></div><div>       1. <span style="font-weight: bold;">由于集群内未部署CNI网络插件（Flannel或Calico），coredns Pod始终处于Pending</span></div><div><span style="font-weight: bold;">          状态，直至CNI网络插件部署完成后，该Pod将为Running状态！</span></div><div>       2. 部署Calico网络插件时，各Pod的状态变化：</div><div>       <img src="Kubernetes v1.13.4 HA集群搭建配置_files/1 [2].JPG" type="image/jpeg" data-filename="1.JPG" width="482"/></div><div>       <img src="Kubernetes v1.13.4 HA集群搭建配置_files/2 [2].JPG" type="image/jpeg" data-filename="2.JPG" width="483"/></div><div>       <img src="Kubernetes v1.13.4 HA集群搭建配置_files/3.JPG" type="image/jpeg" data-filename="3.JPG" width="483"/></div><div><br/></div><div><span style="font-weight: bold;">安装CNI网络插件：</span></div><div><ul><li><div><span style="font-size: 11pt;">创建Flannel网络插件的YAML文件：</span></div></li></ul><div><span style="font-size: 11pt;">     root@kube-master0:</span></div></div><div><span style="font-size: 11pt;">     $ vim kube-flannel.yaml</span></div><div><span style="font-size: 11pt;">     // 指定Flannel网络插件使用eth1网卡接口，在172.25.250.0/24网段上使用Overlay</span></div><div><span style="font-size: 11pt;">        网络</span><span style="font-size: 11pt;">供Pod跨节点间通信。</span></div><div><span style="font-size: 11pt;">     // 完整YAML定义文件与截图如下所示：</span></div><div><span style="font-size: 11pt;">     </span><a href="Kubernetes v1.13.4 HA集群搭建配置_files/kube-flannel_1.13.4.yaml"><img src="Kubernetes v1.13.4 HA集群搭建配置_files/7a43f83e52c9a040eb20fca0bc7a84cf.png" alt="kube-flannel_1.13.4.yaml"></a></div><div><span style="font-size: 11pt;">     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/Image [6].png" type="image/png" data-filename="Image.png" width="441"/></span></div><div><span style="font-size: 11pt;">     </span><img src="Kubernetes v1.13.4 HA集群搭建配置_files/Image [7].png" type="image/png" data-filename="Image.png" width="442"/></div><div><br/></div><div><span style="font-size: 11pt;">     <span style="font-size: 11pt; color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></span><span style="font-size: 11pt;">关于多网卡主机安装flannel的问题</span></div><div><span style="font-size: 11pt;">       1. <span style="font-size: 11pt; font-weight: bold;">由于flannel使用默认路由的网卡接口，导致使用了外网网卡接口，将致使Pod</span></span></div><div><span style="font-size: 11pt;"><span style="font-size: 11pt; font-weight: bold;">          之间</span></span><span style="font-size: 11pt;"><span style="font-size: 11pt; font-weight: bold;">无法</span></span><span style="font-size: 11pt; font-weight: bold;">访问。</span></div><div><span style="font-size: 11pt;">       2. 所以需要指定使用相应的网卡接口，在command参数增加 </span><span style="font-size: 11pt; font-weight: bold;"><span style="font-size: 11pt; font-weight: bold; color: rgb(250, 122, 0); font-style: italic;">--iface=eth1</span> </span><span style="font-size: 11pt;">即可。</span></div><div><br/></div><div><ul><li><div><span style="font-size: 14.6667px;">创建Flannel相关的资源：</span></div></li></ul><div><span style="font-size: 14.6667px;">     root@kube-master0:</span></div></div><div><span style="font-size: 14.6667px;">     <span style="font-size: 14.6667px; font-weight: bold;">$</span><span style="font-size: 14.6667px; font-weight: bold;"> kubectl apply -f kube-flannel.yaml</span></span></div><div><span style="font-size: 14.6667px;"><span style="font-size: 14.6667px; font-weight: bold;">    </span><span style="font-size: 14.6667px; font-weight: bold;"> </span>// flannel资源只需在kube-master0节点上创建</span></div><div><span style="font-size: 14.6667px;">     $ kubectl get pods --namespace=kube-system</span></div><div><span style="font-size: 14.6667px;">     // 查看kube-system命名空间中的Pod状态，coredns Pod已进入Running状态。</span></div><div><br/></div><div><span style="font-size: 14.6667px;"><span style="font-size: 14.6667px; font-weight: bold;">加入集群：</span></span></div><div><ul><li><div><span style="font-size: 11pt;">分发证书至其余两个master节点：</span></div></li></ul><div><span style="font-size: 11pt;">     root@kube-master0:</span></div></div><div><span style="font-size: 11pt;">     <span style="font-size: 11pt; font-weight: bold;">$</span><span style="font-size: 11pt; font-weight: bold;"> vim sync_kube_certs.sh</span></span></div><div><span style="font-size: 11pt;">     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/Image [8].png" type="image/png" data-filename="Image.png" width="496"/> </span></div><div><br/></div><div><ul><li><div><span style="font-size: 14.6667px;">添加其余两个master节点：</span></div></li></ul><div><span style="font-size: 14.6667px;">     分别在kube-master1与kube-master2节点上运行如下命令，将其添加为HA master节点。</span></div></div><div><span style="font-size: 14.6667px;">     root@kube-master{1,2}: </span></div><div><span style="font-size: 14.6667px;">     <span style="font-size: 14.6667px; font-weight: bold;">$</span></span><span style="font-size: 14.6667px;"> </span><span style="font-size: 14.6667px; font-weight: bold;">kubeadm join</span> <span style="font-weight: bold;">master.lab.example.com:16443</span><span style="font-size: 14.6667px; font-weight: bold;"> \</span></div><div><span style="font-size: 14.6667px; font-weight: bold;">       --token brtjrh.k4jxfu4h57nlu6zt </span><span style="font-size: 14.6667px; font-weight: bold;">--discovery-token-ca-cert-hash \             </span></div><div><span style="font-size: 14.6667px;"><span style="font-size: 14.6667px; font-weight: bold;">       sha256:5518be649fe9762f303a20a06293ddd3cac9a776ce16a64a6dca19b6da18dac2 \</span></span></div><div><span style="font-size: 14.6667px;"><span style="font-size: 14.6667px; font-weight: bold;">       </span><span style="font-size: 14.6667px; color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">--experimental-control-plane</span></span></div><div><span style="font-size: 14.6667px;"><span style="font-size: 14.6667px;"><span style="font-size: 14.6667px; color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">     </span>// --experimental-control-plane选项：添加HA master节点，不同kubeadm版本中该</span></span></div><div><span style="font-size: 14.6667px;"><span style="font-size: 14.6667px;">        选项</span></span><span style="font-size: 14.6667px;">可能不同。</span></div><div><span style="font-size: 14.6667px;"><span style="font-size: 14.6667px;">     // 完整安装日志与截图如下所示：</span></span></div><div><span style="font-size: 14.6667px;"><span style="font-size: 14.6667px;">     </span></span><a href="Kubernetes v1.13.4 HA集群搭建配置_files/kubeadm-join-ha-master.log"><img src="Kubernetes v1.13.4 HA集群搭建配置_files/7a9131e4c54ac22c3236adef701abab8.png" alt="kubeadm-join-ha-master.log"></a></div><div><span style="font-size: 11pt;">     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/kube join  master1.JPG" type="image/jpeg" data-filename="kube join  master1.JPG" width="496"/></span></div><div><br/></div><div><ul><li><div><span style="font-size: 14.6667px;">重置由kubeadm配置的master节点</span></div></li></ul></div><div><span style="font-size: 11pt;">     root@kube-master</span><span style="font-size: 11pt; font-style: italic;">X</span><span style="font-size: 11pt;">:</span></div><div><span style="font-size: 11pt;">     <span style="font-size: 11pt; font-weight: bold;">$</span><span style="font-size: 11pt; font-weight: bold;"> kubeadm reset</span></span></div><div><span style="font-size: 11pt;">     // 若master节点添加失败，可重新添加该节点，重复执行分发证书与添加节点两步即可。</span></div><div><span style="font-size: 11pt;">     <span style="font-size: 11pt; font-weight: bold;">$</span><span style="font-size: 11pt; font-weight: bold;"> iptables -F &amp;&amp; \</span></span></div><div><span style="font-size: 11pt;"><span style="font-size: 11pt; font-weight: bold;">       iptables -t nat -F &amp;&amp; \</span></span></div><div><span style="font-size: 11pt;"><span style="font-size: 11pt; font-weight: bold;">       iptables -t mangle -F &amp;&amp; \</span></span></div><div><span style="font-size: 11pt;"><span style="font-size: 11pt; font-weight: bold;">       iptables -X</span></span></div><div><span style="font-size: 11pt;">       <img src="Kubernetes v1.13.4 HA集群搭建配置_files/kubeadm重置master节点.JPG" type="image/jpeg" data-filename="kubeadm重置master节点.JPG" width="559"/></span></div><div><br/></div><div><ul><li><div><span style="font-size: 11pt;">配置kubectl环境变量：</span></div></li></ul></div><div>     root@kube-master{1,2}:</div><div>     $ mkdir -p $HOME/.kube</div><div>     $ cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</div><div>     $ chown $(id -u):$(id -g) $HOME/.kube/config</div><div><br/></div><div><ul><li><div>添加其余worker node节点：</div></li></ul><div>     root@kube-node{0,1}:</div></div><div>     $<span style="font-weight: bold;"> kubeadm join</span> <a href="http://master.lab.example.com:16443/" style="font-weight: bold;">master.lab.example.com:16443</a><span style="font-weight: bold;"> \</span></div><div><span style="font-weight: bold;">       --token brtjrh.k4jxfu4h57nlu6zt --discovery-token-ca-cert-hash </span></div><div><span style="font-weight: bold;">       sha256:5518be649fe9762f303a20a06293ddd3cac9a776ce16a64a6dca19b6da18dac2</span></div><div><span style="font-weight: bold;">    </span><span style="font-weight: bold;"> </span>// 完整安装日志与截图如下所示：</div><div><span style="font-weight: bold;">     </span><a href="Kubernetes v1.13.4 HA集群搭建配置_files/kubeadm-join-worker-node.log"><img src="Kubernetes v1.13.4 HA集群搭建配置_files/4640e65434fc5628034c087f83504381.png" alt="kubeadm-join-worker-node.log"></a></div><div>     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/kube join  node.JPG" type="image/jpeg" data-filename="kube join  node.JPG" width="498"/></div><div><br/></div><div><ul><li><div>重置由kubeadm配置的worker node节点：</div></li></ul><div>     root@kube-node<span style="font-style: italic;">X</span>:</div></div><div>     $ kubeadm reset</div><div>     // <span style="font-size: 11pt;">若node节点添加失败，可重新添加该节点，重复执行添加节点即可。</span></div><div>     $ iptables -F &amp;&amp; \</div><div>       iptables -t nat -F &amp;&amp; \</div><div>       iptables -t mangle -F &amp;&amp; \</div><div>       iptables -X</div><div>       <img src="Kubernetes v1.13.4 HA集群搭建配置_files/kubeadm重置node节点.JPG" type="image/jpeg" data-filename="kubeadm重置node节点.JPG" width="562"/></div><div><br/></div><div><ul><li><div><span style="font-size: 11pt; font-weight: bold;">查看集群各节点与组件状态：</span></div></li></ul><div>     root@kube-master0:</div></div><div>     $ kubectl get nodes</div><div>     $ kubectl get pods --namespace=kube-system</div><div>     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/Kubernetes 1.13.4 HA集群状态.JPG" type="image/jpeg" data-filename="Kubernetes 1.13.4 HA集群状态.JPG" width="499"/></div><div><br/></div><div><ul><li><div>集群监听端口：</div></li></ul><div>     1. master节点的Kubernetes组件监听端口：</div></div><div>     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/Kubernetes 1.13.4 master节点端口信息.JPG" type="image/jpeg" data-filename="Kubernetes 1.13.4 master节点端口信息.JPG" width="502"/></div><div><br/></div><div>     2. worker node节点的Kubernetes组件监听端口：</div><div>     <img src="Kubernetes v1.13.4 HA集群搭建配置_files/Kubernetes 1.13.4 node节点端口信息.JPG" type="image/jpeg" data-filename="Kubernetes 1.13.4 node节点端口信息.JPG" width="504"/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 