# Linux 进程的内存布局

## 文档目录

- ELF 文件的简要分析
- 堆、栈（堆栈）、队列的基本特点
- 进程的内存布局

## 堆、栈（堆栈）的基本特点

- 队列：先进先出（就像一条路，有一个入口和一个出口，先进去的就可以先出去）

------

1. CPU 字长决定了可寻址的内存空间大小，32位CPU 最大寻址空间是2^32 = 4GiB
   
     64位CPU 最大可寻址空间是2^64，由于在当前这个空间过于庞大，所以64位CPU只会用到地址空间一部分，具体根据系统和平台有所差异

2. 最大地址空间跟系统拥有的可用物理内存大小无关，所以叫做虚拟内存

3. 虚拟内存被划分为内核空间和用户空间，32位系统普遍采用低地址段为用户空间(user space), 高地址段为内核空间（Kernel Space）

-----

堆和栈的区别和联系：

在计算机领域，堆栈是一个不容忽视的概念，堆栈是两种数据结构。堆栈都是一种数据项按序排列的数据结构，只能在一端（称为栈顶（top））对数据项进行插入和删除。在单片机应用中，堆栈是个特殊的存储区，主要功能是暂时存放数据和地址，通常用来保护断点和现场。

堆和栈的要点：

堆，队列优先，先进先出（FIFO—first in first out）。

栈，先进后出（FILO—First-In/Last-Out）。

一般情况下，如果有人把堆栈合起来说，那它的意思是栈，可不是堆。

堆和栈的对比分析：

1、堆栈空间分配

栈（操作系统）：由操作系统自动分配释放 ，存放函数的参数值，局部变量的值等。其操作方式类似于数据结构中的栈。

堆（操作系统）： 一般由程序员分配释放， 若程序员不释放，程序结束时可能由OS回收，分配方式倒是类似于链表

堆是在程序运行时，而不是在程序编译时，申请某个大小的内存空间。即动态分配内存，对其访问和对一般内存的访问没有区别。堆是指程序运行是申请的动态内存，而栈只是指一种使用堆的方法(即先进后出)。

2、堆栈缓存方式

栈使用的是一级缓存， 他们通常都是被调用时处于存储空间中，调用完毕立即释放。

堆则是存放在二级缓存中，生命周期由虚拟机的垃圾回收算法来决定（并不是一旦成为孤儿对象就能被回收）。所以调用这些对象的速度要相对来得低一些。

栈是先进后出的，但是于堆而言却没有这个特性，两者都是存放临时数据的地方。 对于堆，我们可以随心所欲的进行增加变量和删除变量，不要遵循什么次序，只要你喜欢。

3、堆栈数据结构区别

堆（数据结构）：堆可以被看成是一棵树，如：堆排序。

栈（数据结构）：一种先进后出的数据结构。

-----

### 内存的基础知识

- 一个十六进制内存地址可以存储 8 个数据位（bit），即 1 个字节（byte）。

- （内存结束地址 - 内存初始地址）换算成十进制后 = 多少个字节（Byte）

- CPU 寻址 16 位：
  
  4 位十六进制最大到 FFFF 换算成十进制为 65536，也就是 65536 = B = 64 MB。

- CPU 寻址 32 位：
  
  8 位十六进制最大到 FFFF FFFF 换算成十进制为 4294967296B = 4194304KB = 4096MB = 4GB

- CPU 寻址 64 位：
  
  16 位十六进制最大到 FFFF FFFF FFFF FFFF 换算成十进制为 1.844674407371e19B = 1.801439850948e16KB = 17592186044416MB = 17179869184GB

### 进程的内存布局：

### Linux 匿名页释义

在 Linux 中，匿名页（Anonymous Page）是一种特殊类型的内存页，它在内核中用于匿名（无关联文件）的内存映射。匿名页通常用于存储进程的堆（heap）和栈（stack）等动态分配的数据。

以下是关于匿名页的一些重要含义：

- 无关联文件：匿名页不与任何磁盘文件关联。它们用于临时存储进程的运行时数据，如动态分配的内存、函数调用栈等。与之相反，与文件关联的页被称为文件页。

- 内存映射：匿名页通过内存映射机制将物理内存映射到进程的虚拟地址空间。这样，进程可以直接访问匿名页，而无需关心具体的物理内存位置。

- 内存分配：匿名页通常通过系统调用（如 mmap() 或 sbrk()）或 C 库函数（如 malloc()）进行动态分配。当进程请求分配匿名页时，内核会为其分配一块虚拟地址空间，并在需要时分配物理内存。

- 页面置换：如果系统内存不足，匿名页可能会被交换（换出 swapout）到交换分区（Swap）中，以腾出物理内存供其他进程使用。当进程再次访问被交换的匿名页时，它将被交换回物理内存。

内存释放：当进程不再需要匿名页时，它可以通过相应的系统调用（如munmap()或free()）释放这些页。内核将回收这些页的物理内存，并将其标记为可再分配。

匿名页在进程的运行中起着重要的作用，特别是在动态内存分配和堆栈操作方面。通过使用匿名页，进程可以方便地进行内存管理和动态数据存储，而无需关心具体的物理内存位置和文件关联。
