# Linux ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–æ¢ç©¶

## æ–‡æ¡£è¯´æ˜

- ä»¥ä¸‹ç¤ºä¾‹å‡åœ¨ RHEL 8 ä¸­éªŒè¯å®ç°ï¼Œè‹¥é’ˆå¯¹å…¶ä»– Linux å‘è¡Œç‰ˆè¯·è‡ªè¡Œæµ‹è¯•ã€‚
- è¯¥æ–‡æ¡£ç”¨äºæè¿° Linux ä¸­å¸¸ç”¨çš„ç³»ç»Ÿç›‘æ§ä¸æ€§èƒ½ä¼˜åŒ–å·¥å…·çš„åŠŸèƒ½ä¸ä½¿ç”¨åœºæ™¯ã€‚
- âœ ç”±äºç¬”è€…æ°´å¹³æœ‰é™ï¼Œè¯¥æ–‡æ¡£åœ¨å®è·µè¿‡ç¨‹ä¸­å°†ä¸æ–­ä¸°å¯ŒåŠæ”¹è¿›ã€‚

## æ–‡æ¡£ç›®å½•

- è¿›ç¨‹åœ¨è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´çš„å¸ƒå±€ï¼ˆlayoutï¼‰
- Linux å¸¸ç”¨ç³»ç»Ÿæ€§èƒ½ç›‘æ§å·¥å…·
- ğŸ”¥ Linux ç³»ç»Ÿèµ„æºé™åˆ¶ CGroup
- ğŸ”¥ Linux å†…æ ¸æ€§èƒ½è®¡æ•°å™¨ Perf
- kernel ç›¸å…³è½¯ä»¶åŒ…ä¸‹è½½
- è¿›ç¨‹çš„è°ƒåº¦ä¸ä¼˜å…ˆçº§
- CPU æ—¶é’Ÿå‘¨æœŸã€æœºå™¨å‘¨æœŸã€æŒ‡ä»¤å‘¨æœŸçš„å…³ç³»
- x86_64 æ¶æ„çš„å¸¸ç”¨å¯„å­˜å™¨ç¤ºä¾‹
- CPU Cache ç¼“å­˜æ¶æ„

## è¿›ç¨‹åœ¨è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´çš„å¸ƒå±€ï¼ˆlayoutï¼‰

- Linux å†…æ ¸ä½¿ç”¨åˆ†æ®µä¸åˆ†é¡µæœºåˆ¶å®ç°è¿›ç¨‹è™šæ‹Ÿå†…å­˜åœ°å€ã€çº¿æ€§å†…å­˜åœ°å€è‡³ç‰©ç†å†…å­˜åœ°å€çš„è½¬æ¢ï¼Œè€Œè™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´çš„åˆ†æ®µä¿¡æ¯å¯åœ¨ `/proc/<pid>/maps` ä¸­ç¡®å®šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚
  
  ![linux-process-memory-layout](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/linux-process-memory-layout.png)
  
  `/proc/<pid>/maps` ä¸­çš„ 16 è¿›åˆ¶è™šæ‹Ÿå†…å­˜åœ°å€ä»æ˜¾ç¤ºçš„ä½åœ°å€ä½å‘é«˜åœ°å€ä½æ‰©å±•ï¼Œå¹¶ä¸”åœ¨è¿ç»­çš„åœ°å€ç©ºé—´ä¹‹é—´ä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨æ€§å­˜åœ¨ä¸€å®šçš„ `gap` åŒºåŸŸï¼Œè€Œå³ä¾§ç¤ºæ„å›¾ä¸­æ˜¾ç¤ºé™¤äº†è¿›ç¨‹è‡ªèº«çš„è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´å¤–ï¼Œè¿˜å­˜åœ¨å†…æ ¸è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´ï¼Œä¸¤è€…å…±åŒåä½œå®Œæˆè¿›ç¨‹æ‰€éœ€æ‰§è¡Œçš„ä»»åŠ¡ã€‚

- å¯¹äºæŒ‡å®šè¿›ç¨‹çš„å…¨éƒ¨çŠ¶æ€ä¿¡æ¯å¯åœ¨ `/proc/<pid>/status` æ–‡ä»¶ä¸­æŸ¥çœ‹ï¼Œå¦‚ä¸Šè¿°è¿›ç¨‹çš„æ ˆï¼ˆstackï¼‰å¤§å°ä¸º 132 KiBï¼ˆå  33 ä¸ª pageï¼‰ã€‚
  
  ```bash
  $ sudo grep VmStk /proc/4429/status
    VmStk:       132 kB
  ```

## Linux å¸¸ç”¨ç³»ç»Ÿæ€§èƒ½ç›‘æ§å·¥å…·

> ğŸ“œ ä»¥ä¸‹å‘½ä»¤å‡å¯ä½¿ç”¨ man å‘½ä»¤æŸ¥è¯¢è¯¦å°½çš„ä½¿ç”¨è¯´æ˜

- Linux æ€§èƒ½è§‚æµ‹æ€§å·¥å…·å›¾è°±ï¼š
  
  ![linux-performance-observability](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/linux-performance-observability.jpg)

- Linux é™æ€æ€§èƒ½å·¥å…·å›¾è°±ï¼š
  
  ![linux-static-performance-tools](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/linux-static-performance-tools.jpg)

- `ps` å‘½ä»¤è¯¦è§£ï¼š
  
  ```bash
  ### GNU é£æ ¼çš„å‘½ä»¤è¡Œ ###
  $ pidof <process_name>
  # æ ¹æ®è¿›ç¨‹åç§°æŸ¥æ‰¾è¿›ç¨‹ ID
  
  $ ps -p $(pidof <process_name>)
  # æŸ¥çœ‹ç›¸åº”è¿›ç¨‹çš„æ¦‚è¦ä¿¡æ¯
  $ ps -p $(pidof nginx)
    PID TTY      STAT   TIME COMMAND
    865 ?        Ss     0:00 nginx: master process /usr/sbin/nginx
    866 ?        S      0:00 nginx: worker process
    867 ?        S      0:00 nginx: worker process 
  # æŸ¥çœ‹ Nginx ç›¸å…³è¿›ç¨‹çš„æ¦‚è¦ä¿¡æ¯
  
  $ ps -p <pid> -o etime
  # æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹è‡ªå¯åŠ¨ä¸ºæ­¢çš„æ¶ˆè€—ï¼ˆelapsedï¼‰æ—¶é—´
  $ ps --forest -C <cmdlist>
  # æŸ¥çœ‹æŒ‡å®šå‘½ä»¤åˆ—è¡¨çš„è¿›ç¨‹æ ‘ ç»“æ„
  $ ps --forest -C nginx -o pid,ppid,cmd
  # æŸ¥çœ‹ Nginx è¿›ç¨‹çš„è¿›ç¨‹æ ‘ä¸ pidã€ppid å’Œ cmd
  
  $ ps -ef
  $ ps -efL
  # å…¨æ ¼å¼è¾“å‡ºç³»ç»Ÿä¸Šè¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹ï¼Œå¹¶æ˜¾ç¤ºå„ä¸ªè¿›ç¨‹çš„çº¿ç¨‹æ•°ï¼ˆNLWPï¼‰ã€‚
  # æ³¨æ„ï¼šLinux å†…æ ¸ä¸åŒºåˆ†è¿›ç¨‹ä¸çº¿ç¨‹ï¼Œå°†çº¿ç¨‹è§†ä¸ºè½»é‡çº§è¿›ç¨‹ï¼ˆLWPï¼‰ã€‚
  $ ps -L -C <process_name>
  # æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„çº¿ç¨‹ä¿¡æ¯
  $ ps -L [-p|p|-q|q] <pid>
  # æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„çº¿ç¨‹ä¿¡æ¯
  $ ps -U <user_name>
  # æŸ¥çœ‹æŒ‡å®šç”¨æˆ·çš„è¿›ç¨‹ä¿¡æ¯
  
  ### BSD é£æ ¼å‘½ä»¤è¡Œ ###
  $ ps axu
    USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
    root         1  0.0  0.7 180608 13420 ?        Ss   Apr04   0:05 /usr/lib/systemd/systemd --switched-root --system --deserialize 18
    root         2  0.0  0.0      0     0 ?        S    Apr04   0:00 [kthreadd]
    root         3  0.0  0.0      0     0 ?        I<   Apr04   0:00 [rcu_gp]
    root         4  0.0  0.0      0     0 ?        I<   Apr04   0:00 [rcu_par_gp]
    root         6  0.0  0.0      0     0 ?        I<   Apr04   0:00 [kworker/0:0H-kblockd]
    root         8  0.0  0.0      0     0 ?        I<   Apr04   0:00 [mm_percpu_wq]
    root         9  0.0  0.0      0     0 ?        S    Apr04   0:01 [ksoftirqd/0]
    root        10  0.0  0.0      0     0 ?        I    Apr04   0:01 [rcu_sched]
    root        11  0.0  0.0      0     0 ?        S    Apr04   0:00 [migration/0]
    root        12  0.0  0.0      0     0 ?        S    Apr04   0:00 [watchdog/0]
    ...
  # æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·åŠè¿›ç¨‹çš„æ‰©å±•è¯¦æƒ…
  # ä½¿ç”¨ man ps æŸ¥çœ‹å‘½ä»¤è¾“å‡ºçš„ HEADER è¯¦ç»†è¯´æ˜
  # å¸¸è§çš„ HEADER è¯´æ˜ï¼š
  #   USERï¼šuserï¼Œä¹Ÿç§°ä¸º euserï¼Œå³è¿è¡Œè¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· IDã€‚
  #   PIDï¼špidï¼Œå³è¿›ç¨‹ IDã€‚
  #   %CPUï¼š%cpuï¼Œä¹Ÿç§°ä¸º cputime æˆ– realtime ratioï¼Œå³è¿›ç¨‹å æ‰€æœ‰è¿›ç¨‹çš„ CPU ä½¿ç”¨æ—¶é—´ç™¾åˆ†æ¯”ã€‚
  #   %MEMï¼š%memï¼Œå³è¿›ç¨‹çš„å¸¸é©»ç‰©ç†å†…å­˜ï¼ˆresident set sizeï¼‰ä½¿ç”¨ç‡ã€‚
  #   VSZï¼švszï¼Œå³è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å¤§å°ï¼ˆå•ä½ä¸º KiBï¼‰ã€‚
  #   RSSï¼šrssï¼Œå³è¿›ç¨‹çš„å¸¸é©»å†…å­˜å¤§å°ï¼ˆé swapped çš„ç‰©ç†å†…å­˜å¤§å°ï¼‰ï¼Œå…¶å•ä½ä¸º KiBã€‚
  #   TTYï¼štnameï¼Œå³è¿›ç¨‹æ‰€åœ¨çš„ç»ˆç«¯ï¼Œå…¶ä¸­ "?" ä»£è¡¨è¿›ç¨‹æ— éœ€è¿è¡Œç»ˆç«¯ã€‚
  #   STATï¼šstatï¼Œå³è¿›ç¨‹çš„çŠ¶æ€ã€‚
  #   STARTï¼šstart_timeï¼Œå³è¿›ç¨‹å¯åŠ¨çš„æ—¶é—´æˆ–æ—¥æœŸã€‚
  #   TIMEï¼štimeï¼Œå³è¿›ç¨‹ä»å¯åŠ¨åˆ°ç°åœ¨ç§¯ç´¯çš„ CPU ä½¿ç”¨æ—¶é—´ï¼Œæ ¼å¼ä¸º "[DD-]HH:MM:SS"ï¼Œè¯¥å€¼é€æ¸ç´¯åŠ ã€‚
  #   CLSï¼šclsï¼Œå³è¿›ç¨‹çš„è°ƒåº¦ç±»åˆ«ï¼ˆè§ä¸‹æ–‡ "è¿›ç¨‹çš„è°ƒåº¦ä¸ä¼˜å…ˆçº§è¯´æ˜"ï¼‰ã€‚
  #   COMMANDï¼šcommï¼Œå³è¿›ç¨‹çš„å¯æ‰§è¡Œç¨‹åºåç§°ã€‚
  
  $ ps axum
  # æŸ¥çœ‹ç³»ç»Ÿä¸Šè¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹ï¼Œå¹¶åœ¨æ¯ä¸ªè¿›ç¨‹ä¸‹æ˜¾ç¤ºè¯¥è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹ã€‚
  $ ps axl
  # é•¿åˆ—è¡¨æ ¼å¼è¾“å‡ºç³»ç»Ÿä¸Šè¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹
  $ ps axjf
  # æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹çš„è¿›ç¨‹æ ‘ä¿¡æ¯ï¼Œä¸ pstree å‘½ä»¤ç±»ä¼¼ã€‚
  
  $ ps ax --format pid,%mem,comm --sort -%mem
  $ ps axo pid,%mem,comm --sort -%mem
  # æŸ¥çœ‹è¿›ç¨‹ä»¥è¿›ç¨‹ IDã€è¿›ç¨‹çš„ç‰©ç†å†…å­˜ä½¿ç”¨ç‡ä»¥åŠè¿›ç¨‹çš„å¯æ‰§è¡Œç¨‹åºåç§°è¾“å‡ºï¼Œå¹¶ä»¥ç‰©ç†å†…å­˜ä½¿ç”¨ç‡
  # çš„é™åºï¼ˆä»é«˜åˆ°ä½ï¼‰æ’åºã€‚
  ```
  
  ğŸ’¥ å…³äº ps ä¸ top å‘½ä»¤è¾“å‡ºä¸­è™šæ‹Ÿå†…å­˜ä¸å¸¸é©»å†…å­˜çš„è¯´æ˜ï¼š
  è¿›ç¨‹çš„ VSZ ä¸ RSS åœ¨è¿›ç¨‹çš„ `/proc/<pid>/status` ä¸­åˆ†åˆ«å¯¹åº” `VmSize` ä¸ `VmRSS`ï¼Œè€Œ `VmRSS = RssAnon + RssFile`ã€‚
  
  ```bash
  $ sudo cat /proc/4429/status
    ...
    VmSize:   149300 kB
    RssAnon:            3304 kB
    RssFile:            5320 kB
    ...
  $ ps axo pid,vsz,rss,comm | grep 4429
    4429 149300  8624 nginx
  ```
  
  top å‘½ä»¤å¯¹ PID 4429 çš„è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­ `VIRT`ï¼ˆè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ï¼‰ä¸ ps å‘½ä»¤çš„ VSZ ç›¸åŒï¼Œ`RES`ï¼ˆè¿›ç¨‹çš„å¸¸é©»å†…å­˜ï¼‰ä¸ ps å‘½ä»¤çš„ RSS ç›¸åŒï¼ŒSHR ä¸ `/proc/<pid>/status` çš„ RssFile ç›¸åŒã€‚
  
  ```bash
  $ top -n 1 -p 4429
    Tasks:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie
    %Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
    MiB Mem :   1828.8 total,   1268.2 free,    210.0 used,    350.7 buff/cache
    MiB Swap:      0.0 total,      0.0 free,      0.0 used.   1450.3 avail Mem
  
     PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
    4429 nginx     20   0  149300   8624   5320 S   0.0   0.5   0:01.04 nginx 
  # top å‘½ä»¤æ‰§è¡Œ 1 ç§’ç«‹å³è¿”å›
  ```
  
  é€šè¿‡ ps ä¸ top å‘½ä»¤å¯æŸ¥çœ‹è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å¤§å°ï¼Œé™¤æ­¤ä¹‹å¤–ä¹Ÿå¯ç›´æ¥è®¡ç®—è¿›ç¨‹åœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„åˆ†æ®µèŒƒå›´è€Œè·å¾—å…¶è™šæ‹Ÿå†…å­˜çš„å¤§å°ï¼Œåœ¨ Linux ä¸­è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜åˆ†æ®µçš„æ˜ å°„ä½äº `/proc/<pid>/maps` æ–‡ä»¶ä¸­ï¼Œè®¡ç®—æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š
  
  ```bash
  $ sudo cat /proc/<pid>/maps | \
    awk '{print $1}' | \
    awk -F'[-]' '{ s=strtonum("0x"$1); e=strtonum("0x"$2); sum+=e-s } END { print sum/1024 }'
  # ç»Ÿè®¡æŒ‡å®šè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´ä¸­çš„åœ°å€æ•°é‡ï¼Œæ¯ä¸ªåœ°å€å¯¹åº” 1 å­—èŠ‚ã€‚
  # ä»¥ä¸Šå‘½ä»¤è¿”å›çš„å•ä½ä¸º KiB
  ```

  é™¤äº† top å¤–ï¼Œ`htop` å‘½ä»¤å¯æä¾›æ›´åŠ ä¾¿æ·ä¸å¯è§†åŒ–çš„ç®¡ç†ç•Œé¢ã€‚

- ç›‘æ§è™šæ‹Ÿå†…å­˜ä½¿ç”¨æƒ…å†µï¼š`vmstat` å‘½ä»¤  
  - vmstat å‘½ä»¤æ¥è‡ªäº `procps-ng` è½¯ä»¶åŒ…  
  - è¯¥å‘½ä»¤ä¸å¸¦å‚æ•°å°†æ˜¾ç¤ºè‡ªå¯åŠ¨ä»¥æ¥ç»Ÿè®¡ä¿¡æ¯çš„å¹³å‡å€¼  
  - è¯¥å‘½ä»¤å…·æœ‰å¤šç§ç»Ÿè®¡æ±‡æ€»æ¨¡å¼ï¼ŒåŒ…æ‹¬ VM æ¨¡å¼ï¼ˆVM modeï¼‰ã€ç£ç›˜æ¨¡å¼ï¼ˆdisk modeï¼‰ã€ç£ç›˜åˆ†åŒºæ¨¡å¼ï¼ˆdisk partition modeï¼‰ä¸ slab æ¨¡å¼ï¼ˆslab modeï¼‰ç­‰ï¼Œé»˜è®¤æƒ…å†µä¸‹ä»¥ VM æ¨¡å¼è¾“å‡ºã€‚ 
  - é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘½ä»¤è¾“å‡ºçš„å†…å­˜å•ä½ä¸º KiBï¼Œæ›´æ”¹å•ä½çš„é€‰é¡¹ï¼š
    - `-S k` é€‰é¡¹ï¼šå•ä½ KB
    - `-S m` é€‰é¡¹ï¼šå•ä½ MB
    - `-S M` é€‰é¡¹ï¼šå•ä½ MiB

    ```bash
    root@ceph-node0:~# vmstat -S M 2 5
    procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
     r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
     1  0      0    121      9    160    0    0     7   120  188  276  0  0 99  0  0
     1  0      0    121      9    160    0    0     0    19  305  474  0  0 100  0  0
     0  0      0    121      9    160    0    0     0    19  328  462  0  1 99  0  0
     0  0      0    121      9    160    0    0     0    33  327  473  0  1 99  0  0
     0  0      0    120      9    160    0    0     0    39  351  514  0  0 100  0  0
    # é»˜è®¤ VM æ¨¡å¼è¾“å‡ºï¼Œå•ä½ä¸º MiBï¼Œæ¯éš” 2 ç§’é‡‡æ ·ï¼Œå…±é‡‡æ · 4 æ¬¡ã€‚
    ```
  
  - vmstat å‘½ä»¤ VM æ¨¡å¼è¾“å‡ºçš„è¯¦ç»†è¯´æ˜ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    ![vmstat-header-info](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/vmstat-header-info.jpg)

    ![linux-process-schedule](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/linux-process-schedule.jpg)

- ğŸ”¥ sysstat è½¯ä»¶åŒ…ç›¸å…³å‘½ä»¤ï¼š  
  - è¯¥è½¯ä»¶åŒ…ä¸­ä¸»è¦åŒ…å«çš„å‘½ä»¤ï¼šmpstatã€iostatã€pidstatã€sar ç­‰ 
  - ç›‘æ§ CPU çš„ä½¿ç”¨æƒ…å†µï¼š`mpstat` å‘½ä»¤
    mpstat å‘½ä»¤å°†ä½¿ç”¨ `/proc/stat` ä¸ `/proc/interrupts` æ–‡ä»¶è¿›è¡Œæ£€ç´¢ï¼Œç›‘æ§ç»Ÿè®¡ CPU çš„ä½¿ç”¨çŠ¶æ€ã€‚

    ```bash
    $ sudo mpstat -P { <cpu_list> | ALL } \
      -N { <node_list> | ALL } \
      <interval> <count>
    # mpstat å‘½ä»¤æŸ¥çœ‹æŒ‡å®š CPU æ ¸å¿ƒæˆ– NUMA èŠ‚ç‚¹çš„ä½¿ç”¨çŠ¶æ€
    
    $ sudo mpstat -P ALL 1 10
    # å®æ—¶ç›‘æ§æ‰€æœ‰ CPU æ ¸å¿ƒçš„ä½¿ç”¨çŠ¶æ€ï¼Œæ¯éš” 1 ç§’é‡‡é›†æ ·æœ¬å…±é‡‡é›† 10 æ¬¡ã€‚
    
    $ sudo mpstat -P 1 -N 0 -o JSON 2 5 > mpstat-dump.json
    # å®æ—¶ç›‘æ§ 1 å·é€»è¾‘ CPUã€0 å· NUMA èŠ‚ç‚¹çš„ CPU çŠ¶æ€ï¼Œæ¯éš” 2 ç§’é‡‡é›†æ ·æœ¬å…±é‡‡é›† 5 æ¬¡ï¼Œ
    # ç»“æœè¾“å‡ºä¸ºæŒ‡å®š JSON æ–‡ä»¶ã€‚
    ```

    ![mpstat-demo](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/mpstat-demo.png)

    è‹¥éœ€å¯ç”¨å®æ—¶è¾“å‡ºçš„é«˜äº®æ˜¾ç¤ºï¼Œå¯è®¾ç½® `S_COLORS` ç¯å¢ƒå˜é‡ä¸º `always` æˆ– `auto`ã€‚
  
  - ç›‘æ§ç£ç›˜çš„ I/O ä½¿ç”¨æƒ…å†µï¼š`iostat` å‘½ä»¤
    iostat å‘½ä»¤ä½¿ç”¨å†…æ ¸æ€§èƒ½è®¡æ•°å™¨ç»Ÿè®¡ç”Ÿæˆä¸¤ç±»æŠ¥å‘Šï¼šCPU ä½¿ç”¨æŠ¥å‘Šã€è®¾å¤‡ä½¿ç”¨æŠ¥å‘Š

    ```bash
    $ sudo iostat -cdz --human 2 10
    # æ¯ 2 ç§’é‡‡é›†æ ·æœ¬å…±é‡‡é›† 10 æ¬¡ï¼Œå®æ—¶ç›‘æ§ CPU ä¸ç£ç›˜è®¾å¤‡çš„çŠ¶æ€ã€‚
    # è¾“å‡ºä¸­çš„ tps äº‹åŠ¡æ•°åˆç§°ä¸º IOPS
    # æ³¨æ„ï¼š
    #   -c é€‰é¡¹ï¼šæ˜¾ç¤º CPU ä½¿ç”¨ç‡æŠ¥å‘Š
    #   -d é€‰é¡¹ï¼šæ˜¾ç¤ºè®¾å¤‡ä½¿ç”¨ç‡æŠ¥å‘Š
    #   -z é€‰é¡¹ï¼šçœç•¥ç»Ÿè®¡æ— ä»»ä½•æ´»åŠ¨çš„è®¾å¤‡
    #   --human é€‰é¡¹ï¼šæ˜¾ç¤ºäººç±»å¯è¯»çš„å®¹é‡æ ¼å¼
    ```

    ![iostat-demo](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/iostat-demo.png)
  
  - ç›‘æ§è¿›ç¨‹çš„ä½¿ç”¨æƒ…å†µï¼š`pidstat` å‘½ä»¤

    ```bash
    $ sudo pidstat -p <pid> -u -t -r <interval> <count>
    # æŸ¥çœ‹è¿›ç¨‹çš„çŠ¶æ€ç»Ÿè®¡ä¿¡æ¯
    # æ³¨æ„ï¼š
    #   -p é€‰é¡¹ï¼šè¿›ç¨‹ PID
    #   -u é€‰é¡¹ï¼šæŠ¥å‘Š CPU ä½¿ç”¨ç‡
    #   -t é€‰é¡¹ï¼šæŠ¥å‘Šé¡µé¢é”™è¯¯ï¼ˆpage faultsï¼‰ä¸å†…å­˜ä½¿ç”¨ç‡
    #   -r é€‰é¡¹ï¼šæŠ¥å‘ŠæŒ‡å®šè¿›ç¨‹çš„çº¿ç¨‹ç»Ÿè®¡æƒ…å†µ
    ```
  
  - ç³»ç»Ÿæ€§èƒ½ç›‘æ§ä¸æŠ¥å‘Šå·¥å…·ï¼š`sar` å‘½ä»¤

## ğŸ”¥ Linux ç³»ç»Ÿèµ„æºé™åˆ¶ CGroup

- è¯¥éƒ¨åˆ†å†…å®¹è¯·å‚çœ‹ [Linux ç³»ç»Ÿèµ„æºé™åˆ¶](https://github.com/Alberthua-Perl/tech-docs/blob/master/Linux%20%E7%9A%84%E5%9F%BA%E7%A1%80%E4%B8%8E%E8%BF%9B%E9%98%B6/Linux%20%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6.md)ã€‚

## ğŸ”¥ Linux æ€§èƒ½è®¡æ•°å™¨ Perf

- è¯¥éƒ¨åˆ†å†…å®¹è¯·å‚çœ‹ [Linux æ€§èƒ½è®¡æ•°å™¨ Perf]()ã€‚

## kernel ç›¸å…³è½¯ä»¶åŒ…ä¸‹è½½

- ä¸ç³»ç»Ÿè¯Šæ–­ä¸ä¼˜åŒ–çš„éƒ¨åˆ†å·¥å…·ä¾èµ–å†…æ ¸çš„ç‰ˆæœ¬ï¼Œå¦‚ perfã€SystemTap ç­‰ï¼Œå› æ­¤åœ¨ä½¿ç”¨æ­¤ç±»å·¥å…·æ—¶éœ€å®‰è£…å†…æ ¸ç›¸å…³çš„è½¯ä»¶åŒ…ï¼Œå¹¶ä¸”å…¶ç‰ˆæœ¬å¿…é¡»ä¸å½“å‰ç³»ç»Ÿå†…æ ¸å®Œå…¨ä¸€è‡´ã€‚
- ç›¸å…³çš„å†…æ ¸è½¯ä»¶åŒ…å®‰è£…å¯å‚è€ƒ [How can I download or install kernel debuginfo packages for RHEL systems?](https://access.redhat.com/solutions/9907#masthead)

## è¿›ç¨‹çš„è°ƒåº¦ä¸ä¼˜å…ˆçº§

- ğŸ“œ `man 7 sched` å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹è°ƒåº¦çš„ç­–ç•¥ä¸ç³»ç»Ÿè°ƒç”¨
- Linux ä¸­çš„è¿›ç¨‹è°ƒåº¦ç­–ç•¥ï¼š  
  - å®æ—¶è°ƒåº¦ç­–ç•¥ï¼ˆreal-time scheduling policyï¼‰
    - ç”±å®æ—¶è°ƒåº¦ç­–ç•¥è°ƒåº¦çš„è¿›ç¨‹éœ€åœ¨é™åˆ¶çš„æ—¶é—´å†…å®Œæˆä»»åŠ¡ï¼Œå¸¸è§çš„ç­–ç•¥æœ‰ `FF`ã€‚
    - å®æ—¶è°ƒåº¦çš„è¿›ç¨‹æ¯”éå®æ—¶è°ƒåº¦çš„è¿›ç¨‹è·å¾—æ›´å¤šçš„ CPU ä½¿ç”¨æ—¶é—´ï¼Œç”±äºå…¶éœ€è¦åœ¨æœ‰é™çš„æ—¶é—´å†…å®Œæˆå¹¶è¿”å›ã€‚  
  - éå®æ—¶è°ƒåº¦ç­–ç•¥ï¼ˆnon-real-time scheduling policyï¼‰
    å¸¸è§çš„ç­–ç•¥æœ‰ `TS`
- Linux è¿›ç¨‹è°ƒåº¦ä¼˜å…ˆçº§çš„åˆ†ç±»ï¼š
  
  ![linux-process-priorities](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/linux-process-priorities.jpg)
  
  - ç³»ç»Ÿä¼˜å…ˆçº§ï¼ˆsystem priorityï¼‰  
  - å®æ—¶ä¼˜å…ˆçº§ï¼ˆreal-time priorityï¼‰  
  - è¿‡æ—¶çš„ä¼˜å…ˆçº§ï¼ˆobsolete priorityï¼‰ï¼š`/ËˆÉ’bsÉ™liËt/`
    è¯¥ä¼˜å…ˆçº§ç±»å‹ä¸º `BSD` é£æ ¼ç±»å‹ï¼Œä½¿ç”¨ ps å‘½ä»¤çš„ `l` é€‰é¡¹æŸ¥çœ‹ï¼Œå…¶ä¼˜å…ˆçº§çš„å€¼ä¸ `pri` é€‰é¡¹ä¸åŒã€‚
- Linux ä¸­çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆcontext switchï¼‰ï¼š
  - ä¸Šä¸‹æ–‡åˆ‡æ¢çš„è¿‡ç¨‹ï¼š

    ![linux-context-switch-1](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/linux-context-switch-1.png)

    ![linux-context-switch-2](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/linux-context-switch-2.png)

    - å½“ä¸€ä¸ªç¨‹åºæ­£åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸­æ–­ï¼ˆinterruptï¼‰æˆ–ç³»ç»Ÿè°ƒç”¨ï¼ˆsystem callï¼‰å‘ç”Ÿå¯ä»¥ä½¿å¾— CPU çš„æ§åˆ¶æƒä»å½“å‰è¿›ç¨‹è½¬ç§»åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚
    - æ“ä½œç³»ç»Ÿå†…æ ¸è´Ÿè´£ä¿å­˜è¿›ç¨‹ $P_1$ åœ¨ CPU ä¸­çš„ä¸Šä¸‹æ–‡åˆ° $PCB_1$ï¼ˆPCB å³ä¸ºè¿›ç¨‹çš„ `task_struct` ç»“æ„ä½“ï¼‰ä¸­ã€‚
    - ä» $PCB_2$ å–å‡ºè¿›ç¨‹ $P_2$ çš„ CPU ä¸Šä¸‹æ–‡ï¼Œå°† CPU æ§åˆ¶æƒè½¬ç§»ç»™è¿›ç¨‹ $P_2$ï¼Œ å¼€å§‹æ‰§è¡Œè¿›ç¨‹ $P_2$ çš„æŒ‡ä»¤ã€‚  
  - å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢çš„ 3 ä¸­åœºæ™¯ï¼š
    - 1ï¸âƒ£ è¿›ç¨‹æ— æ³•è¿è¡Œä¸‹å»ï¼š
      å¦‚ç­‰å¾… IO å®Œæˆï¼Œæˆ–è€…ç­‰å¾…æŸä¸ªèµ„æºã€æŸä¸ªäº‹ä»¶ç­‰ã€‚
    - 2ï¸âƒ£ è¿›ç¨‹ä»åœ¨è¿è¡Œï¼Œä½†å†…æ ¸ä¸è®©å®ƒç»§ç»­ä½¿ç”¨ CPUï¼š
      å¦‚è¿›ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œï¼Œæˆ–è€…ä¼˜å…ˆçº§æ›´é«˜çš„è¿›ç¨‹æŠ¢å ï¼Œå› æ­¤è¯¥è¿›ç¨‹å¿…é¡»äº¤å‡º CPU çš„ä½¿ç”¨æƒã€‚
    - 3ï¸âƒ£ è¿›ç¨‹è¿˜å¯è¿è¡Œï¼Œä½†å…¶è‡ªèº«çš„ç®—æ³•å†³å®šä¸»åŠ¨äº¤å‡º CPU äºåˆ«çš„è¿›ç¨‹ï¼š
      ç”¨æˆ·ç¨‹åºå¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨ `sched_yield()` æ¥äº¤å‡º CPUï¼Œå†…æ ¸åˆ™å¯ä»¥é€šè¿‡å‡½æ•° `cond_resched()` æˆ–è€… `yield()` æ¥åšåˆ°ã€‚
  - ä¸Šä¸‹æ–‡åˆ‡æ¢åˆå¯åˆ†ä¸ºï¼š
    - è‡ªæ„¿ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆvoluntary /ËˆvÉ’lÉ™ntri/ï¼‰
    - éè‡ªæ„¿ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆinvoluntaryï¼‰æˆ–å¼ºåˆ¶åˆ‡æ¢ 
  > è‡ªæ„¿ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶è¿›ç¨‹ä¸å†å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œè€Œéè‡ªæ„¿ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶è¿›ç¨‹ä»å¤„äºè¿è¡ŒçŠ¶æ€ã€‚
  - ä»¥ä¸Šåœºæ™¯ 1ï¸âƒ£ å±äºè‡ªæ„¿ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè€Œåœºæ™¯ 2ï¸âƒ£ ä¸ 3ï¸âƒ£ å±äºéè‡ªæ„¿ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚
- ps å‘½ä»¤å¸¸ç”¨å‚æ•°ç¤ºä¾‹ï¼š
  
  ```bash
  $ sudo ps axo pid,pri,rtprio,ni,cls,cputime,psr,comm
      PID PRI RTPRIO  NI CLS     TIME PSR COMMAND
        1  19      -   0  TS 00:00:10   0 systemd
        2  19      -   0  TS 00:00:00   1 kthreadd
        3  39      - -20  TS 00:00:00   0 rcu_gp
        4  39      - -20  TS 00:00:00   0 rcu_par_gp
        6  39      - -20  TS 00:00:00   0 kworker/0:0H-kblockd
        8  39      - -20  TS 00:00:00   0 mm_percpu_wq
        9  19      -   0  TS 00:00:00   0 ksoftirqd/0
       10  19      -   0  TS 00:00:01   1 rcu_sched
       11 139     99   -  FF 00:00:00   0 migration/0
       12 139     99   -  FF 00:00:00   0 watchdog/0
       13  19      -   0  TS 00:00:00   0 cpuhp/0
       14  19      -   0  TS 00:00:00   1 cpuhp/1
       15 139     99   -  FF 00:00:00   1 watchdog/1
       16 139     99   -  FF 00:00:00   1 migration/1 
       ...
       1677  19      -   0  TS 00:00:00   1 nginx
       1678  19      -   0  TS 00:00:00   0 nginx
       1679  19      -   0  TS 00:00:00   1 nginx
       ...
  # æŸ¥çœ‹ç³»ç»Ÿæ‰€æœ‰è¿›ç¨‹çš„ PIDã€ç³»ç»Ÿä¼˜å…ˆçº§ã€å®æ—¶ä¼˜å…ˆçº§ã€nice å€¼ã€cls è°ƒåº¦ç­–ç•¥ã€
  # CPU å®é™…ä½¿ç”¨æ—¶é—´ï¼ˆrealtimeï¼‰ã€è¿›ç¨‹å½“å‰è¢«åˆ†é…çš„é€»è¾‘ CPU ä¸å¯¹åº”çš„å‘½ä»¤
  
  $ cat /proc/<pid>/status
    ...
    voluntary_ctxt_switches:        1  # è‡ªæ„¿ä¸Šä¸‹æ–‡åˆ‡æ¢æ•°ç›®
    nonvoluntary_ctxt_switches:     4  # éè‡ªæ„¿ä¸Šä¸‹æ–‡åˆ‡æ¢æ•°ç›®
  # voluntary_ctxt_switches, nonvoluntary_ctxt_switches: since Linux 2.6.23
  # ä»¥ä¸Šæ•°ç›®æ˜¯è¿›ç¨‹è¢«è°ƒåº¦è¿è¡Œåçš„ç´¯åŠ å€¼
  # æ³¨æ„ï¼š
  #   è‡ªæ„¿ä¸Šä¸‹æ–‡åˆ‡æ¢æ•°ç›®å å¤šæ•°è¯´æ˜è¿›ç¨‹ç›¸å¯¹ CPU çš„èµ„æºéœ€æ±‚ä¸é«˜ï¼Œè€Œéè‡ªæ„¿ä¸Šä¸‹æ–‡åˆ‡æ¢æ•°ç›®è¾ƒå¤š
  #   çš„è¯ï¼Œéœ€è€ƒè™‘å…¶å¯¹ CPU çš„èµ„æºéœ€æ±‚å¯èƒ½å­˜åœ¨ç“¶é¢ˆï¼Œè¢«å†…æ ¸å¼ºåˆ¶è°ƒåº¦åˆ‡æ¢ã€‚
  ```
  
  ä»ä¸Šè¿° ps å‘½ä»¤çš„è¾“å‡ºä¸­å¯çŸ¥ï¼š  
  - CLS è°ƒåº¦ç­–ç•¥ä¸º TSï¼ˆSCHED_NORMALï¼‰çš„è¿›ç¨‹ä¸å…·æœ‰å®æ—¶ä¼˜å…ˆçº§ï¼ˆRTPRIOï¼‰
  - âœ¨ è¿›ç¨‹å…·æœ‰æœ€é«˜çš„å®æ—¶ä¼˜å…ˆçº§ï¼ˆ99ï¼‰è€Œå…·æœ‰æœ€ä½çš„ç³»ç»Ÿä¼˜å…ˆçº§ï¼ˆ139ï¼‰å½¼æ­¤é—´ä¸çŸ›ç›¾ï¼Œå› ä¸ºå®æ—¶ä¼˜å…ˆçº§æ˜¯è¿›ç¨‹åœ¨é™å®šæ—¶é—´å†…éœ€å®Œæˆçš„ä»»åŠ¡å¯ï¼Œéœ€æŠ¢å  CPU èµ„æºå¿«é€Ÿå®Œæˆä»»åŠ¡ï¼Œè€Œä»»åŠ¡å®Œæˆåä¸å†å ç”¨ CPU èµ„æºå…·æœ‰è¾ƒä½çš„ç³»ç»Ÿçš„ä¼˜å…ˆçº§ï¼Œæ­¤ç±»è¿›ç¨‹é€šå¸¸ä¸ºå†…æ ¸è¿›ç¨‹ã€‚

## CPU æ—¶é’Ÿå‘¨æœŸã€æœºå™¨å‘¨æœŸã€æŒ‡ä»¤å‘¨æœŸçš„å…³ç³»

- CPU çš„æœ€å°æ—¶é—´å•ä½æ˜¯æ—¶é’Ÿå‘¨æœŸï¼Œè€Œä¸€ä¸ªæœºå™¨å‘¨æœŸåŒ…æ‹¬è‹¥å¹²ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œè€ŒæŒ‡ä»¤å‘¨æœŸï¼Œåˆ™åŒ…å«è‹¥å¹²ä¸ªæœºå™¨å‘¨æœŸã€‚
- ğŸ¤˜ æŒ‰ç²’åº¦æ’åºï¼š**æŒ‡ä»¤å‘¨æœŸ > æœºå™¨å‘¨æœŸ > æ—¶é’Ÿå‘¨æœŸ**
- æ—¶é’Ÿå‘¨æœŸï¼ˆClock Cycleï¼‰ï¼š 
  - æ—¶é’Ÿå‘¨æœŸä¹Ÿç§°ä¸º **æŒ¯è¡å‘¨æœŸ**ï¼Œå®šä¹‰ä¸º **æŒ¯è¡é¢‘ç‡** çš„å€’æ•°ã€‚  
  - æ—¶é’Ÿå‘¨æœŸæ˜¯è®¡ç®—æœºä¸­ CPU çš„æœ€åŸºæœ¬ã€æœ€å°çš„æ—¶é—´å•ä½ã€‚  
  - åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼ŒCPU ä»…å®Œæˆä¸€ä¸ªæœ€åŸºæœ¬çš„åŠ¨ä½œã€‚
- æœºå™¨å‘¨æœŸï¼ˆMachine Cycleï¼‰ï¼š  
  - æœºå™¨å‘¨æœŸä¹Ÿç§°ä¸º CPU å‘¨æœŸï¼ˆCPU Cycleï¼‰ï¼Œåœ¨è®¡ç®—æœºä¸­ï¼Œä¸ºäº†ä¾¿äºç®¡ç†ï¼Œå¸¸æŠŠä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªé˜¶æ®µã€‚ 
  - å¦‚ï¼Œå–æŒ‡ä»¤ã€å­˜å‚¨å™¨ï¼ˆå³ä¸»å­˜ï¼‰è¯»ã€å­˜å‚¨å™¨å†™ç­‰ï¼Œè¿™æ¯ä¸€é¡¹å·¥ä½œç§°ä¸ºä¸€ä¸ª **åŸºæœ¬æ“ä½œ**ï¼ˆæ³¨æ„ï¼šæ¯ä¸€ä¸ªåŸºæœ¬æ“ä½œéƒ½æ˜¯ç”±è‹¥å¹² CPU æœ€åŸºæœ¬çš„åŠ¨ä½œç»„æˆï¼‰ã€‚å®Œæˆä¸€ä¸ª **åŸºæœ¬æ“ä½œ** æ‰€éœ€è¦çš„æ—¶é—´ç§°ä¸ºæœºå™¨å‘¨æœŸã€‚é€šå¸¸ç”¨å†…å­˜ä¸­è¯»å–ä¸€ä¸ªæŒ‡ä»¤çš„æœ€çŸ­æ—¶é—´æ¥è§„å®š CPU å‘¨æœŸã€‚
- æŒ‡ä»¤å‘¨æœŸï¼ˆIntruction Cycleï¼‰ï¼š 
  - è®¡ç®—æœºä»å–æŒ‡ä»¤åˆ°æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•çš„æ—¶é—´ã€‚
- ğŸ’» ä¸€ä¸ªå®Œæ•´çš„æŒ‡ä»¤å‘¨æœŸå¯åŒ…å«ä»¥ä¸‹äº”ä¸ªé˜¶æ®µï¼š
  
  ![instruction-cycle](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/instruction-cycle.jpg)
  
  - å–æŒ‡ä»¤ï¼ˆInstruction Fetchï¼‰ï¼š
    - CPU ä»æŒ‡ä»¤å¯„å­˜å™¨æŒ‡å‘çš„å†…å­˜åœ°å€è¯»å–æŒ‡ä»¤ã€‚
    - æŒ‡ä»¤å¯„å­˜å™¨ä¹Ÿç§°ä¸ºç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counterï¼Œ`PC`ï¼‰ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯ CPU æ ¹æ®æŒ‡ä»¤åœ°å€ä»å†…å­˜é‡ŒæŠŠå…·ä½“çš„æŒ‡ä»¤åŠ è½½åˆ°æŒ‡ä»¤å¯„å­˜å™¨ä¸­ï¼Œå¹¶å­˜å‚¨ä¸‹ä¸€æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚å½“ CPU æ‰§è¡Œå®Œå½“å‰æŒ‡ä»¤åï¼Œä¼šä»æŒ‡ä»¤å¯„å­˜å™¨ä¸­è¯»å–ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå¹¶å°†å…¶åŠ è½½åˆ°æŒ‡ä»¤å¯„å­˜å™¨ä¸­ï¼Œç„¶åå¼€å§‹æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚  
  - æŒ‡ä»¤è¯‘ç ï¼ˆInstruction Decodeï¼‰ï¼š
    CPU è§£ç å–å‡ºçš„æŒ‡ä»¤ï¼Œå¹¶ç¡®å®šæ‰§è¡Œè¯¥æŒ‡ä»¤æ‰€éœ€è¦çš„æ“ä½œã€‚æ­¤é˜¶æ®µè¿˜ä¼šç¡®å®šè¯»å–æ“ä½œæ•°çš„åœ°å€ï¼Œå¹¶æŠŠå®ƒä»¬ä¼ é€åˆ°æ‰§è¡Œé˜¶æ®µã€‚  
  - æ‰§è¡ŒæŒ‡ä»¤ï¼ˆExecuteï¼‰ï¼š
    CPU æ‰§è¡ŒæŒ‡ä»¤å¹¶è®¡ç®—ç»“æœã€‚æ“ä½œæ•°åœ¨æŒ‡ä»¤è¯‘ç é˜¶æ®µè¢«è¯»å–å¹¶åœ¨æ‰§è¡Œé˜¶æ®µè¿›è¡Œè®¡ç®—ã€‚ 
  - è®¿é—®å­˜å‚¨å™¨ï¼ˆMemory Accessï¼‰ï¼š
    è‹¥å½“å‰æŒ‡ä»¤éœ€è¦è®¿é—®å†…å­˜ï¼Œåˆ™åœ¨è¯¥é˜¶æ®µä¸­è®¿é—®å†…å­˜ã€‚ 
  - å†™å›æ•°æ®ï¼ˆWrite Backï¼‰ï¼š
    æœ€ç»ˆè®¡ç®—ç»“æœè¢«å†™å›åˆ° CPU çš„å¯„å­˜å™¨æˆ–è€…å†…å­˜ã€‚  
  - ä»¥ä¸Šäº”ä¸ªé˜¶æ®µç»„æˆä¸€ä¸ªæŒ‡ä»¤å‘¨æœŸã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸æ˜¯æ‰€æœ‰çš„æŒ‡ä»¤éƒ½éœ€è¦ä»¥ä¸Šäº”ä¸ªé˜¶æ®µå…¨éƒ¨æ‰§è¡Œï¼Œä¸€äº›æ¯”è¾ƒç®€å•çš„æŒ‡ä»¤å¯èƒ½åªéœ€è¦æ‰§è¡Œå‰ä¸‰ä¸ªæˆ–è€…å‰å››ä¸ªé˜¶æ®µã€‚è€Œæœ‰äº›å¤æ‚çš„æŒ‡ä»¤å¯èƒ½éœ€è¦å¤šä¸ªæŒ‡ä»¤å‘¨æœŸæ‰èƒ½å®Œæˆã€‚
- å¯¹äºä¸€ä¸ªæŒ‡ä»¤å‘¨æœŸæ¥è¯´ï¼Œå–å‡ºä¸€æ¡æŒ‡ä»¤ï¼Œç„¶åæ‰§è¡Œå®ƒï¼Œè‡³å°‘éœ€è¦ä¸¤ä¸ª CPU å‘¨æœŸã€‚å–å‡ºæŒ‡ä»¤è‡³å°‘éœ€è¦ä¸€ä¸ª CPU å‘¨æœŸï¼Œæ‰§è¡Œè‡³å°‘ä¹Ÿéœ€è¦ä¸€ä¸ª CPU å‘¨æœŸï¼Œå¤æ‚çš„æŒ‡ä»¤åˆ™éœ€è¦æ›´å¤šçš„ CPU å‘¨æœŸã€‚è€Œä¸€ä¸ª CPU å‘¨æœŸæ˜¯è‹¥å¹²æ—¶é’Ÿå‘¨æœŸä¹‹å’Œã€‚
  
  ![three-cycle-relationship](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/three-cycle-relationship.jpg)

## x86_64 æ¶æ„çš„å¸¸ç”¨å¯„å­˜å™¨ç¤ºä¾‹

- x86_64 æ¶æ„æ˜¯ x86 æ¶æ„çš„ 64 ä½æ‰©å±•ï¼Œå®ƒåŒ…æ‹¬äº†ä¸€äº›ä¸ 32 ä½ç‰ˆæœ¬ä¸åŒçš„å¯„å­˜å™¨ï¼Œä»¥ä¸‹åˆ—ä¸¾äº† x86_64 æ¶æ„ä¸­å¸¸ç”¨å¯„å­˜å™¨çš„å…¨ç§°å’Œç®€ç§°ï¼š 
  - é€šç”¨å¯„å­˜å™¨ (General-Purpose Registers)ï¼š
    - RAX (Accumulator Register)
    - RBX (Base Register)
    - RCX (Counter Register)
    - RDX (Data Register)
    - RSI (Source Index Register)
    - RDI (Destination Index Register)
    - RBP (Base Pointer Register)
    - RSP (Stack Pointer Register)
    - R8-R15ï¼šæ–°å¢ 8 ä¸ªé€šç”¨å¯„å­˜å™¨ï¼Œå³ R8ã€R9ã€R10ã€R11ã€R12ã€R13ã€R14ã€R15ã€‚
  - ç¨‹åºè®¡æ•°å™¨ (Program Counter Registers, PC)ï¼š
    - RIP (Instruction Pointer Register)ï¼š
      å­˜å‚¨ CPU æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€ã€‚  
  - æ ‡å¿—å¯„å­˜å™¨ (Flags Registers)ï¼š
    - RFlags (Flags Register)ï¼š
      å­˜å‚¨ CPU çŠ¶æ€çš„äºŒè¿›åˆ¶æ ‡å¿—ï¼ŒåŒ…å«äº† x86_32 æ¶æ„ä¸­çš„ EFlags å¯„å­˜å™¨ã€‚  
  - ğŸ’ª æ§åˆ¶å¯„å­˜å™¨ (Control Registers)ï¼š
    - CR0 (Control Register 0)ï¼š
      ç”¨äºå¼€å¯å’Œå…³é—­è™šæ‹Ÿå†…å­˜ã€ä¿æŠ¤æ¨¡å¼å’Œåˆ†é¡µæœºåˆ¶ç­‰åŠŸèƒ½çš„æ§åˆ¶å¯„å­˜å™¨ã€‚
    - CR2 (Control Register 2)ï¼š
      å­˜å‚¨æœ€è¿‘ä¸€æ¬¡çš„è®¿é—®å†…å­˜äº§ç”Ÿçš„ç¼ºé¡µå¼‚å¸¸çš„åœ°å€å€¼ã€‚
    - **`CR3`** (Control Register 3)ï¼š
      CR3 å¯„å­˜å™¨åœ¨ x86 æ¶æ„ä¸­ç§°ä¸º **é¡µè¡¨åŸºå€å¯„å­˜å™¨**ï¼ˆPage Table Base Registerï¼Œ`PTBR`ï¼‰ï¼Œå®ƒå­˜å‚¨çš„æ˜¯æ“ä½œç³»ç»Ÿåœ¨è™šæ‹Ÿå†…å­˜ç®¡ç†ä¸­çš„é¡µè¡¨çš„åŸºåœ°å€ï¼ˆèµ·å§‹åœ°å€ï¼‰ã€‚é¡µè¡¨åŸºå€å¯„å­˜å™¨æ˜¯åœ¨é¡µè¡¨å®ç°ä¸­çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ï¼Œé€šè¿‡ PTBR å¯ä»¥å®šä½åˆ°é¡µè¡¨åœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œä½¿ CPU èƒ½å¤Ÿæ­£ç¡®åœ°å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚åœ¨è¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæ›´æ–° PTBR ä¸­çš„å€¼ï¼Œä»¥æŒ‡å‘ç›¸åº”è¿›ç¨‹çš„é¡µè¡¨ï¼ˆæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„é¡µè¡¨ï¼‰ã€‚
    - CR4 (Control Register 4)ï¼š
      ç”¨äºæ¿€æ´»ä¸€äº›é«˜çº§çš„ CPU åŠŸèƒ½ï¼Œå¦‚è°ƒè¯•å¯„å­˜å™¨ã€å…¨å±€é¡µé¢ç­‰ã€‚
    - CR8 (Control Register 8)ï¼š
      ç”¨äºæ§åˆ¶ä¸­æ–­çš„ä¼˜å…ˆçº§ã€‚
- åœ¨ x86_64 æ¶æ„ä¸­ï¼Œ32 ä½çš„å¯„å­˜å™¨åç§°çš„å‰ç¼€ç”± E æ”¹ä¸º Rï¼Œå¦‚ï¼ŒRAXã€RBXã€RCX ç­‰ã€‚æ­¤å¤–ï¼Œx86_64 æ¶æ„è¿˜å¼•å…¥äº† 8 ä¸ªæ–°å¢çš„é€šç”¨å¯„å­˜å™¨ R8-R15ã€‚è¿™äº›å¯„å­˜å™¨çš„ä½œç”¨å’Œ 32 ä½çš„é€šç”¨å¯„å­˜å™¨ä¸€æ ·ï¼Œå¯ä»¥ç”¨äºå­˜å‚¨æ•°æ®å’Œè¿›è¡Œå„ç§è¿ç®—ã€‚

## CPU Cache ç¼“å­˜æ¶æ„

- è®¡ç®—æœºå­˜å‚¨ä½“ç³»æ•´ä½“åˆ†å±‚ç¤ºæ„ï¼š
  
  ![compute-storage-arch](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/compute-storage-arch.jpg)

- CPU Cache ç¼“å­˜æ¶æ„æ‹“æ‰‘ç¤ºä¾‹ï¼š  
  ä½¿ç”¨ `lstopo` å‘½ä»¤ä»¥è·å–å¦‚ä¸‹æ‹“æ‰‘ï¼Œåˆ†åˆ«æ¥è‡ªäº Intel Core i5 ä¸ i7 å¤„ç†å™¨ã€‚
  
  ![foundation0-cpu-topo](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/foundation0-cpu-topo.png)
  
  ![lenovo-t580-cpu-cache-topo](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/lenovo-t580-cpu-cache-topo.png)
  
  ![dell-poweredge-r720-cpu-topo](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/dell-poweredge-r720-cpu-topo.png)
  
  ```bash
  $ sudo yum install -y hwloc-gui
  # å®‰è£…åŸºäº GUI çš„ç³»ç»Ÿæ‹“æ‰‘ä¿¡æ¯è½¯ä»¶åŒ…
  
  $ sudo lstopo --logical --no-io
  Machine (9951MB total) + Package L#0
    NUMANode L#0 (9951MB)
    L3 L#0 (3072KB)
      L2 L#0 (256KB) + L1d L#0 (32KB) + L1i L#0 (32KB) + Core L#0 + PU L#0
      L2 L#1 (256KB) + L1d L#1 (32KB) + L1i L#1 (32KB) + Core L#1 + PU L#1
      L2 L#2 (256KB) + L1d L#2 (32KB) + L1i L#2 (32KB) + Core L#2 + PU L#2
      L2 L#3 (256KB) + L1d L#3 (32KB) + L1i L#3 (32KB) + Core L#3 + PU L#3
  # æŸ¥çœ‹ä¸»æœºçš„ CPU é€»è¾‘æ‹“æ‰‘ä¿¡æ¯
  
  $ sudo sudo lstopo --physical --no-io
  Machine (9951MB total) + Package P#0
    NUMANode P#0 (9951MB)
    L3 (3072KB)
      L2 (256KB) + L1d (32KB) + L1i (32KB) + Core P#0 + PU P#0
      L2 (256KB) + L1d (32KB) + L1i (32KB) + Core P#1 + PU P#1
      L2 (256KB) + L1d (32KB) + L1i (32KB) + Core P#2 + PU P#2
      L2 (256KB) + L1d (32KB) + L1i (32KB) + Core P#3 + PU P#3 
  # æŸ¥çœ‹ä¸»æœºçš„ CPU ç‰©ç†æ‹“æ‰‘ä¿¡æ¯
  
  $ sudo lstopo --no-io
  Machine (9951MB total) + Package L#0
    NUMANode L#0 (P#0 9951MB)
    L3 L#0 (3072KB)
      L2 L#0 (256KB) + L1d L#0 (32KB) + L1i L#0 (32KB) + Core L#0 + PU L#0 (P#0)
      L2 L#1 (256KB) + L1d L#1 (32KB) + L1i L#1 (32KB) + Core L#1 + PU L#1 (P#1)
      L2 L#2 (256KB) + L1d L#2 (32KB) + L1i L#2 (32KB) + Core L#2 + PU L#2 (P#2)
      L2 L#3 (256KB) + L1d L#3 (32KB) + L1i L#3 (32KB) + Core L#3 + PU L#3 (P#3) 
  # æŸ¥çœ‹ä¸»æœºçš„ CPU é€»è¾‘ä¸ç‰©ç†æ‹“æ‰‘ä¿¡æ¯
  # æ³¨æ„ï¼š
  #   PU è¡¨ç¤ºç‰©ç†å¤„ç†å•å…ƒ (Pysical Processing Unit)ï¼ŒæŒ‡çš„æ˜¯æ˜ å°„åˆ°ç‰©ç†å¤„ç†å™¨çš„æ ‡è¯†ç¬¦ã€‚
  #   P# è¡¨ç¤ºå¤„ç†å™¨ (Package) æ ‡è¯†ç¬¦ï¼Œä¹Ÿæ˜¯æ˜ å°„åˆ°ç‰©ç†å¤„ç†å™¨ä¸Šçš„æ ‡è¯†ç¬¦ã€‚
  ```

- ä½¿ç”¨ `valgrind` å‘½ä»¤æµ‹è¯•ç¨‹åºçš„ CPU Cache åœ¨ `L1` ç¼“å­˜ä¸ `LL` ç¼“å­˜ï¼ˆæœ€æ…¢çš„ä¸€çº§ç¼“å­˜æˆ–æœ€åä¸€çº§ç¼“å­˜ï¼‰ä¸­çš„å‘½ä¸­ç‡ï¼Œä¸ºç¨‹åºçš„ä¼˜åŒ–æä¾›ç›¸åº”çº¿ç´¢ï¼š
  
  ```bash
  $ man valgrind
  # æŸ¥çœ‹ valgrind å‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•
  
  $ sudo valgrind --tool=cachegrind ./cache-test1
  ==1798== Cachegrind, a cache and branch-prediction profiler
  ==1798== Copyright (C) 2002-2017, and GNU GPL'd, by Nicholas Nethercote et al.
  ==1798== Using Valgrind-3.14.0 and LibVEX; rerun with -h for copyright info
  ==1798== Command: bin/cache-test1
  ==1798== 
  --1798-- warning: L3 cache found, using its data for the LL simulation.    # ä½¿ç”¨ L3 ç¼“å­˜ä½œä¸º LL ç¼“å­˜
  Starting
  Finished
  ==1798== 
  ==1798== I   refs:      6,750,717,128    
  ==1798== I1  misses:            1,011    # L1 æŒ‡ä»¤ç¼“å­˜æœªå‘½ä¸­æ•°
  ==1798== LLi misses:            1,002    # LL æŒ‡ä»¤ç¼“å­˜æœªå‘½ä¸­æ•°
  ==1798== I1  miss rate:          0.00%   # L1 æŒ‡ä»¤ç¼“å­˜æœªå‘½ä¸­ç‡ï¼ˆI1 misses/I refsï¼‰
  ==1798== LLi miss rate:          0.00%   # LL æŒ‡ä»¤ç¼“å­˜æœªå‘½ä¸­ç‡ï¼ˆLLi miss rate/I refsï¼‰
  ==1798== 
  ==1798== D   refs:      3,937,858,532  (3,375,270,491 rd   + 562,588,041 wr)  
  ==1798== D1  misses:       35,159,402  (        2,516 rd   +  35,156,886 wr)  # L1 æ•°æ®ç¼“å­˜æœªå‘½ä¸­æ•°
  ==1798== LLd misses:       35,158,984  (        2,126 rd   +  35,156,858 wr)  # LL æ•°æ®ç¼“å­˜æœªå‘½ä¸­æ•° 
  ==1798== D1  miss rate:           0.9% (          0.0%     +         6.2%  )  # L1 æ•°æ®ç¼“å­˜æœªå‘½ä¸­ç‡ï¼ˆD1 misses/D refsï¼‰
  ==1798== LLd miss rate:           0.9% (          0.0%     +         6.2%  )  # LL æ•°æ®ç¼“å­˜æœªå‘½ä¸­ç‡ï¼ˆLLd misses/D refsï¼‰
  ==1798== 
  ==1798== LL refs:          35,160,413  (        3,527 rd   +  35,156,886 wr)
  ==1798== LL misses:        35,159,986  (        3,128 rd   +  35,156,858 wr)
  ==1798== LL miss rate:            0.3% (          0.0%     +         6.2%  )
  ```

- CPU Cache ç¼“å­˜å‘½ä¸­ç‡çš„ C ç¨‹åºä»£ç ç¤ºä¾‹ï¼š
  å·¦ä¾§ä¸º cache1.cï¼Œå³ä¾§ä¸º cache2.cã€‚
  
  ![cpu-cache-valgrind-test-demo](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/cpu-cache-valgrind-test-demo.png)
  
  ä»¥ä¸Šä»£ç ç”¨ä»¥å®šä¹‰ä¸€ä¸ª 7500 ä¸ªè¡Œå…ƒç´ ä¸ 7500 ä¸ªåˆ—å…ƒç´ çš„äºŒç»´æ•°ç»„ã€‚å·¦ä¾§ç¤ºä¾‹å…ˆå®šä¹‰è¡Œï¼Œåœ¨æ¯è¡Œä¸­ä»¥åˆ—è¿›è¡Œé€’å¢ï¼Œæ¯è¡Œä¸­çš„åˆ—å…ƒç´ çš„å€¼æ˜¯æ•´å‹å˜é‡ `i`ï¼ˆè¡Œçš„ç´¢å¼•å·ï¼‰ä¸æ•´å‹å˜é‡ `j`ï¼ˆåˆ—çš„ç´¢å¼•å·ï¼‰çš„ä¹˜ç§¯ï¼Œè€Œå³ä¾§ç¤ºä¾‹å…ˆå®šä¹‰åˆ—ï¼Œåœ¨æ¯åˆ—ä¸­ä»¥è¡Œè¿›è¡Œé€’å¢ã€‚å› æ­¤ï¼Œä¸¤è€…ç¼–è¯‘åä½¿ç”¨ valgrind å‘½ä»¤è¿›è¡Œç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•ï¼Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š
  
  ![cpu-cache-valgrind-test-1](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/cpu-cache-valgrind-test-1.png)
  
  ![cpu-cache-valgrind-test-2](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/linux-performance/cpu-cache-valgrind-test-2.png)
  
  ä»æµ‹è¯•ç»“æœå¯çŸ¥ cache1 çš„ L1 æ•°æ®å†™ç¼“å­˜æœªå‘½ä¸­ç‡ï¼ˆ6.2%ï¼‰æ˜æ˜¾ä½äº cache2 çš„ï¼ˆ100.0%ï¼‰ï¼Œå…¶åŸå› åœ¨äº CPU Cache ç¼“å­˜ä»¥ç¼“å­˜è¡Œï¼ˆCache lineï¼‰çš„æ–¹å¼è¿›è¡Œå­˜å‚¨ï¼Œå…ˆå®šä¹‰è¡Œå†ä»¥åˆ—è¿›è¡Œé€’å¢çš„æ•ˆç‡æ›´é«˜ã€‚

## å‚è€ƒé“¾æ¥

- [å¦‚ä½•ç†è§£ CPU steal time](https://www.cnblogs.com/my-show-time/p/15893877.html)
- â¤ [Linux kernel profiling with perf](https://perf.wiki.kernel.org/index.php/Tutorial)
- [Linux æ€§èƒ½åˆ†æå·¥å…· Perf ç®€ä»‹](https://segmentfault.com/a/1190000021465563)
- [è¿›ç¨‹åˆ‡æ¢ï¼šè‡ªæ„¿ (voluntary) ä¸å¼ºåˆ¶ (involuntary)](http://linuxperf.com/?p=209)
