## Ansible è‡ªåŠ¨åŒ–è¿›é˜¶å®è·µï¼ˆ5ï¼‰- åè°ƒæ»šåŠ¨æ›´æ–°

### æ–‡æ¡£ç›®å½•ï¼š

- å§”æ´¾ä»»åŠ¡å’Œäº‹å®

- ç®¡ç†æ»šåŠ¨æ›´æ–°

### å§”æ´¾ä»»åŠ¡å’Œäº‹å®

- å§”æ´¾ä»»åŠ¡ï¼ˆtaskï¼‰ï¼š
  
  - ğŸ¤˜ å§”æ´¾å°±æ˜¯åœ¨ play ä¸­ï¼Œå°†ä»»åŠ¡æ¨é€åˆ°æŒ‡å®šçš„ä¸åŒçš„ä¸»æœºæˆ–ä¸»æœºç»„ä¸Šè¿è¡Œï¼Œè€Œä¸æ˜¯åœ¨å½“å‰å—ç®¡ä¸»æœºä¸Šè¿è¡Œã€‚
  
  - âœ¨ `delegate_to` æŒ‡ä»¤ï¼š
    
    - å°†ä»»åŠ¡æ“ä½œå§”æ‰˜ç»™ä¸»æœº
    
    - è¯¥æŒ‡ä»¤å°† Ansible æŒ‡å‘å°†æ‰§è¡Œä»»åŠ¡çš„ä¸»æœºï¼Œä»¥æ›¿ä»£å¯¹åº”çš„ç›®æ ‡ã€‚
  
  - å§”æ´¾ä»»åŠ¡çš„å¸¸è§èŠ‚ç‚¹ï¼š
    
    - Ansible æ§åˆ¶èŠ‚ç‚¹ `localhost`
    
    - è‹¥éœ€è¦ä¸æŸæœåŠ¡çš„ APIÂ è¿›è¡Œé€šä¿¡ï¼Œè€Œè¯¥æœåŠ¡å‡ºäºæŸç§åŸå› æ— æ³•ä»å—ç®¡ä¸»æœºè®¿é—®ï¼Œä½†å¯ä»æ§åˆ¶èŠ‚ç‚¹è®¿é—®ï¼Œåˆ™å¯èƒ½ä¼šè¿™æ ·åšã€‚
  
  - [ç¤ºä¾‹ 1](https://github.com/Alberthua-Perl/ansible-demo/blob/master/do447-course-demo/chapter05/delegate_tasks_facts.yaml)ï¼š
    
    åœ¨ play ä¸­çš„æ¯ä¸ªä¸»æœºä¸Šè¿è¡Œ uname -a å‘½ä»¤ï¼Œç„¶åä»£è¡¨ play ä¸­çš„æ¯ä¸ªä¸»æœºåœ¨ localhost ä¸Šè¿è¡Œ uname -a å‘½ä»¤ã€‚
    
    ```yaml
    ---
    - name: Test delegation tasks
      hosts: servera.lab.example.com
    
      tasks:
        - name: Get system information
          command: uname -a
          register: server
    
        - name: Display servera system information
          debug:
            msg: "{{ server }}"
    
        - name: Get system information
          command: uname -a
          delegate_to: localhost
          register: local
    
        - name: Display localhost system information
          debug:
            msg: "{{ local }}"
    ```
    
    è¯¥ playbook æ‰§è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/ansible-advanced-practice/delegate-rolling-update/delegate_to-demo.png)
  
  - âœ… ç¤ºä¾‹ 2ï¼š
    
    ```yaml
      - name: Remove the server from HAProxy
        haproxy:
          state: disabled
          host: "{{ ansible_facts['fqdn'] }}"
          socket: /var/lib/haproxy/stats
        delegate_to: "{{ item }}"
        loop: "{{ groups['lbservers'] }}" 
        # ansible å°†è¯¥ä»»åŠ¡å§”æ´¾è‡³ lbservers ä¸»æœºç»„ä¸­ä¸»æœºä¸Šä»¥ç¦ç”¨ haproxy æœåŠ¡ï¼Œ
        # è€Œä¸æ˜¯åœ¨æŒ‡å®šçš„å—ç®¡ä¸»æœºä¸Šæ‰§è¡Œï¼
      - name: Make sure Apache HTTPD is stopped
        service:
          name: httpd
          state: stopped
    ```
  
  - ğŸ¤˜ å§”æ´¾ä»»åŠ¡çš„åº”ç”¨åœºæ™¯ï¼š
    
    - åœ¨å‘Šè­¦ç³»ç»Ÿä¸­å¯ç”¨åŸºäºä¸»æœºçš„å‘Šè­¦
    
    - å‘è´Ÿè½½å‡è¡¡å™¨ä¸­æ·»åŠ æˆ–ç§»é™¤ä¸€å°ä¸»æœº
    
    - åœ¨ DNS ä¸Šæ·»åŠ æˆ–ä¿®æ”¹é’ˆå¯¹æŸä¸ªä¸»æœºçš„è§£æ
    
    - åœ¨å­˜å‚¨èŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªå­˜å‚¨ä»¥ç”¨äºä¸»æœºæŒ‚è½½
    
    - ä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨ç¨‹åºæ¥æ£€æµ‹ä¸»æœºä¸Šçš„æœåŠ¡æ˜¯å¦æ­£å¸¸

- å§”æ´¾äº‹å®ï¼ˆfactï¼‰ï¼š
  
  - å¦‚å‰æ‰€ç¤ºï¼Œä½¿ç”¨äº†å—ç®¡ä¸»æœºçš„äº‹å® `ansible_facts['fqdn']`ï¼Œè€Œé localhost çš„äº‹å®ã€‚
  
  - ğŸ’¥ å§”æ´¾ä»»åŠ¡æ—¶ï¼Œä½¿ç”¨æ­£åœ¨ä¸ºå…¶è¿è¡Œä»»åŠ¡çš„å—ç®¡ä¸»æœºï¼ˆå½“å‰çš„ `inventory_hostname`ï¼‰çš„ä¸»æœºå˜é‡å’Œäº‹å®ï¼Œå¦‚ä»»åŠ¡æ­£åœ¨ä¸º `servera` è¿è¡Œï¼Œä½†å·²è¢«å§”æ´¾åˆ° localhostï¼Œåˆ™ä½¿ç”¨ `servera` çš„å˜é‡å’Œäº‹å®ã€‚
  
  - `delegate_facts` æŒ‡ä»¤
    
    - è®¾ç½®å€¼ï¼štrue
    
    - åŠŸèƒ½ï¼šå°†å§”æ´¾ä»»åŠ¡æ‰€æ”¶é›†çš„äº‹å®åˆ†é…åˆ°è¯¥ä»»åŠ¡æ‰€å§”æ´¾åˆ°çš„ä¸»æœºä¸Š
  
  - [ç¤ºä¾‹](https://github.com/Alberthua-Perl/ansible-demo/blob/master/do447-course-demo/chapter05/delegate_tasks_facts.yaml)ï¼š
    
    delegate_facts æŒ‡ä»¤å¯å°†äº‹å®æ”¶é›†åˆ°å§”æ´¾ä¸»æœºçš„ `hostvars['servera.lab.example.com']` å‘½åç©ºé—´ä¸­ï¼Œè€Œä¸æ˜¯å½“å‰å—ç®¡ä¸»æœºçš„é»˜è®¤ `hostvars['localhost']` å‘½åç©ºé—´ä¸­ã€‚
    
    ```yaml
    - name: Test delegation facts
      hosts: localhost
      gather_facts: no
    
      tasks:
        - name: Set a fact in delegated task on servera
          set_fact:
            myfact: Where am I set?
          delegate_to: servera.lab.example.com
          delegate_facts: true
          # åœ¨ localhost ä¸Šè®¾ç½®äº‹å®å˜é‡ï¼Œå¹¶å°†è¯¥äº‹å®å§”æ´¾è‡³ servera èŠ‚ç‚¹ä¸Š
    
        - name: Display the facts from servera.lab.example.com
          debug:
            msg: "{{ hostvars['servera.lab.example.com']['myfact'] }}"
          # use magic variable to verify delegation fact
    ```
  
  > ğŸ’¥ `delegate_to` ä¸ `delegate_facts` æŒ‡ä»¤å¿…é¡»åŒæ—¶ä½¿ç”¨ï¼

### ç®¡ç†æ»šåŠ¨æ›´æ–°

- æ¦‚è¿°ï¼š  
  
  - Ansible å¯å¯ç”¨æ»šåŠ¨æ›´æ–°ï¼ˆ`rolling updates`ï¼‰ï¼Œä¸€ç§åœ¨æœåŠ¡å™¨æ‰¹æ¬¡é”™å¼€éƒ¨ç½²çš„ç­–ç•¥ã€‚
  
  - å€ŸåŠ©è¯¥ç­–ç•¥ï¼Œå¯åœ¨ä¸åœæœºçš„æƒ…å†µä¸‹éƒ¨ç½²åŸºç¡€æ¶æ„æ›´æ–°ã€‚
  
  - å‘ç”Ÿä¸å¯é¢„è§çš„é—®é¢˜æ—¶ï¼ŒAnsible å¯æš‚åœéƒ¨ç½²ï¼Œå¹¶ä¸”ä»»ä½•é”™è¯¯éƒ½å¯ä»…é™äºç‰¹å®šæ‰¹ä¸­çš„æœåŠ¡å™¨ã€‚
  
  - é€šè¿‡å®æ–½æµ‹è¯•å’Œç›‘æ§ï¼Œå¯å°† playbook ä»»åŠ¡é…ç½®ä¸ºï¼š
    
    - å¯¹å—å½±å“çš„æ‰¹å¤„ç†ä¸­çš„ä¸»æœºè¿›è¡Œå›æ»šé…ç½®ï¼ˆ`rollback configuration`ï¼‰ã€‚
    
    - éš”ç¦»å—å½±å“çš„ä¸»æœºï¼Œä»¥å¯ç”¨å¯¹å¤±è´¥éƒ¨ç½²çš„åˆ†æã€‚
    
    - å‘åˆ©ç›Šç›¸å…³è€…å‘é€éƒ¨ç½²é€šçŸ¥ã€‚

- æ§åˆ¶æ‰¹å¤„ç†å¤§å°ï¼ˆbatch sizeï¼‰ï¼š  
  
  - é»˜è®¤ Ansible ä¼šåœ¨å¼€å§‹æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡å‰ï¼Œå¯¹ play ä¸­çš„æ‰€æœ‰ä¸»æœºè¿è¡Œä¸€ä¸ªä»»åŠ¡ã€‚
  
  - ğŸ’¥ è‹¥æŸä¸€ä»»åŠ¡å¤±è´¥ï¼Œåˆ™æ‰€æœ‰ä¸»æœºå°†åªæœ‰ä¸€éƒ¨åˆ†é€šè¿‡è¯¥ä»»åŠ¡ã€‚
  
  - è¿™å¯èƒ½æ„å‘³ç€ä»»ä½•ä¸»æœºéƒ½æ— æ³•æ­£å¸¸å·¥ä½œï¼Œå¯èƒ½å¯¼è‡´ä¸­æ–­ã€‚
  
  - ç†æƒ³æƒ…å†µä¸‹ï¼Œå¯åœ¨å¯åŠ¨ä¸‹ä¸€æ‰¹ä¸»æœºä¹‹å‰å…¨ç¨‹é€šè¿‡ play å¤„ç†ä¸€äº›ä¸»æœºã€‚
  
  - ğŸ’¥ è‹¥æœ‰å¤ªå¤šä¸»æœºå¤±è´¥ï¼Œåˆ™å¯ä¸­æ­¢æ•´ä¸ª playã€‚
  
  - æ‰¹å¤„ç†å¤§å°è®¾ç½®ä¸ºå›ºå®šå€¼ï¼š
    
    - `serial` å…³é”®å­—ï¼š
      
      - åœ¨ play çº§åˆ«å®ç°æ‰¹å¤„ç†ä¸»æœº
      
      - æŒ‡å®šæ¯ä¸ªæ‰¹å¤„ç†ä¸­åº”å½“æœ‰å¤šå°‘ä¸ªä¸»æœº
      
      - åœ¨å¼€å§‹ä¸‹ä¸€æ‰¹å¤„ç†ä¹‹å‰ï¼ŒAnsible å°†å…¨ç¨‹é€šè¿‡ play å¤„ç†æ¯ä¸€æ‰¹ä¸»æœºã€‚
      
      - è‹¥å½“å‰æ‰¹å¤„ç†ä¸­çš„æ‰€æœ‰ä¸»æœºéƒ½å¤±è´¥ï¼Œåˆ™æ•´ä¸ª play å°†ä¸­æ­¢ï¼Œä¸”ä¸ä¼šå¯åŠ¨ä¸‹ä¸€ä¸ªæ‰¹å¤„ç†ã€‚
      
      > âœ… forksÂ å‚æ•°ä¸ serialÂ å…³é”®å­—åŒæ—¶åªæœ‰ä¸€è€…ç”Ÿæ•ˆï¼
      
      - ç¤ºä¾‹ï¼š
        
        ```yaml
        ---
        - name: Update Webservers
          hosts: web_servers
          serial: 2
        ```
        
        - serial å…³é”®å­—å°†åœ¨ä¸¤ä¸ªä¸»æœºçš„æ‰¹å¤„ç†ä¸­å¤„ç† web_servers ç»„ä¸­çš„ä¸»æœºã€‚
        
        - è‹¥ play æ­£å¸¸æ‰§è¡Œä¸”æ²¡æœ‰é”™è¯¯ï¼Œåˆ™ä½¿ç”¨æ–°çš„æ‰¹å¤„ç†å†æ¬¡é‡å¤è¯¥ playã€‚
        
        - æ­¤è¿‡ç¨‹å°†ç»§ç»­ï¼Œç›´åˆ°å·²å¤„ç† play ä¸­çš„æ‰€æœ‰ä¸»æœºã€‚
    
    - è‹¥ play ä¸­çš„ä¸»æœºæ€»æ•°ä¸èƒ½è¢«æ‰¹å¤„ç†å¤§å°æ•´é™¤ï¼Œåˆ™æœ€åä¸€ä¸ªæ‰¹å¤„ç†åŒ…å«çš„ä¸»æœºå¯èƒ½æ¯” serial å…³é”®å­—çš„æŒ‡å®šå€¼æ›´å°‘ã€‚
    
    - å¦‚ä¸Šæ‰€ç¤ºï¼Œè‹¥ web æœåŠ¡å™¨çš„æ€»æ•°é‡ä¸ºå¥‡æ•°å€¼ï¼Œåˆ™æœ€åä¸€ä¸ªæ‰¹å¤„ç†åŒ…å«ä¸€ä¸ªä¸»æœºã€‚
    
    - ğŸ‘‰ è‹¥å®šä¹‰çš„ `forks` å‚æ•°ä¸º 100ï¼Œ`serial` å€¼ä¸º 2ï¼Œåˆ™å…·æœ‰ 200 ä¸ªä¸»æœºçš„ä¸»æœºç»„å°†éœ€è¦ 100 ä¸ªæ‰¹å¤„ç†æ‰èƒ½å®Œæˆï¼Œå³ `2 x (2 serial x 50)` forksã€‚
  
  - æ‰¹å¤„ç†å¤§å°è®¾ç½®ä¸ºç™¾åˆ†æ¯”ï¼š
    
    - å¯å°† serialÂ å…³é”®å­—è®¾ç½®ä¸ºç™¾åˆ†æ¯”ï¼š
      
      ```yaml
      ---
      - name: Update Webservers
        hosts: web_servers
        serial: 25%
      ```
    
    - è‹¥ serial çš„å€¼ä¸º 25%ï¼Œé‚£ä¹ˆæ— è®ºÂ web_servers ç»„ä¸­æ˜¯åŒ…å« 20 ä¸ªä¸»æœºè¿˜æ˜¯ 200 ä¸ªä¸»æœºï¼Œéƒ½éœ€è¦ 4 ä¸ªæ‰¹å¤„ç†æ¥å®Œæˆæ‰€æœ‰ä¸»æœºçš„ playã€‚
    
    - ğŸ’¥ Ansible å°†è¯¥ç™¾åˆ†æ¯”åº”ç”¨åˆ°ä¸»æœºç»„ä¸­çš„ä¸»æœºæ€»æ•°ï¼ŒAnsible å°†æ ¹æ®ä¸»æœºç»„çš„æ€»å¤§å°è€Œéæœªå¤„ç†ä¸»æœºç»„çš„å¤§å°è®¡ç®—æ‰¹å¤„ç†å¤§å°ã€‚
    
    - ğŸ‘‰ è‹¥ç”Ÿæˆçš„å€¼ä¸æ˜¯æ•´æ•°æ•°é‡çš„ä¸»æœºï¼Œåˆ™å€¼å°†è¢« `å‘ä¸‹èˆå…¥` åˆ°æœ€æ¥è¿‘çš„æ•´æ•°ã€‚
    
    - å‰©ä½™çš„ä¸»æœºåœ¨æœ€ç»ˆçš„è¾ƒå°æ‰¹å¤„ç†ä¸­è¿è¡Œã€‚
    
    - æ‰¹å¤„ç†å¤§å°ä¸èƒ½ä¸º `0` ä¸ªä¸»æœºã€‚
    
    - è‹¥å‘ä¸‹èˆå…¥åçš„å€¼ä¸º `0`ï¼ŒAnsible ä¼šå°†æ‰¹å¤„ç†å¤§å°æ›´æ”¹ä¸º `1` ä¸ªä¸»æœºã€‚
      
      ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/ansible-advanced-practice/delegate-rolling-update/serial-percent-demo.png)
  
  - ğŸš€ è®¾ç½®è¦æ›´æ”¹çš„æ‰¹å¤„ç†å¤§å°ï¼š
    
    - å¯åœ¨ play è¿è¡Œæ—¶æ›´æ”¹æ‰¹å¤„ç†å¤§å°ã€‚
    
    - å¯åœ¨ä¸€ä¸ªä¸»æœºçš„æ‰¹å¤„ç†ä¸Šæµ‹è¯• playï¼Œè‹¥è¯¥ä¸»æœºå¤±è´¥ï¼Œåˆ™æ•´ä¸ª play éƒ½ä¼šä¸­æ­¢ã€‚
    
    - âœ… ä½†è‹¥è¯¥ play åœ¨ä¸€ä¸ªä¸»æœºä¸ŠæˆåŠŸï¼Œå¯ä»¥å°†æ‰¹å¤„ç†å¤§å°å¢åŠ åˆ°ä¸»æœºçš„ `10%`ï¼Œç„¶åå¢åŠ åˆ°å—ç®¡ä¸»æœºçš„ `50%`ï¼Œå†å¢åŠ åˆ°å—ç®¡ä¸»æœºçš„å…¶ä½™éƒ¨åˆ†ã€‚
    
    - ğŸ‘‰ å¯é€šè¿‡å°† serial å…³é”®å­—è®¾ç½®ä¸ºå€¼åˆ—è¡¨æ¥é€æ­¥æ›´æ”¹æ‰¹å¤„ç†å¤§å°ã€‚
    
    - ğŸ‘‰ æ­¤åˆ—è¡¨å¯ä»¥åŒ…å« `æ•´æ•° + ç™¾åˆ†æ¯”` çš„ä»»æ„ç»„åˆï¼Œå¹¶æŒ‰é¡ºåºé‡ç½®æ¯ä¸ªæ‰¹å¤„ç†çš„å¤§å°ã€‚
    
    - ğŸ’¥ è‹¥å¯¹åº”äº serial å…³é”®å­—çš„æœ€åä¸€ä¸ªæ¡ç›®çš„æœ€åä¸€ä¸ªæ‰¹å¤„ç†åä»æœ‰æœªå¤„ç†çš„ä¸»æœºï¼Œåˆ™æœ€åä¸€ä¸ªæ‰¹å¤„ç†å¤§å°å°†é‡å¤ï¼Œç›´åˆ°æ‰€æœ‰ä¸»æœºéƒ½å¾—åˆ°å¤„ç†ã€‚
    
    - ç¤ºä¾‹ï¼š
      
      é’ˆå¯¹åŒ…å« 100 ä¸ªä¸»æœºçš„Â web_servers ä¸»æœºç»„æ‰§è¡Œ
      
      ```yaml
      ---
      - name: Update Webservers
        hosts: web_servers
        serial:
          - 1
          - 10%
          - 25%
      ```
      
      - ç¬¬ä¸€ä¸ªæ‰¹å¤„ç†ï¼š1 ä¸ªä¸»æœº
      
      - ç¬¬äºŒä¸ªæ‰¹å¤„ç†ï¼š10 ä¸ªä¸»æœºï¼ˆ100 çš„ 10%ï¼‰
      
      - ç¬¬ä¸‰ä¸ªæ‰¹å¤„ç†ï¼š25 ä¸ªä¸»æœºï¼ˆ100 çš„ 25%ï¼‰
      
      > ğŸ‘‰ ç•™ä¸‹ 64 ä¸ªæœªç»å¤„ç†çš„ä¸»æœºï¼ˆå·²å¤„ç† 1 + 10 + 25 ä¸ªï¼‰
      
      - Ansible ç»§ç»­ä»¥ 25Â ä¸ªä¸»æœºï¼ˆ100 çš„ 25%ï¼‰çš„æ‰¹å¤„ç†å¤§å°æ‰§è¡Œ playï¼Œç›´åˆ°å‰©ä½™çš„æœªå¤„ç†ä¸»æœºæ•°å°‘äº 25 ä¸ªã€‚
      
      - å‰©ä½™çš„ `14` ä¸ªä¸»æœºåœ¨æœ€ç»ˆæ‰¹å¤„ç†ä¸­å¤„ç†
      
      > ğŸ¤˜ æ•´ä¸ªæ‰¹å¤„ç†çš„è¿‡ç¨‹ï¼š`1 + 10 + 25 + 25 + 25 + 14 = 100`

- ä¸­æ­¢ playï¼š
  
  - é»˜è®¤æƒ…å†µä¸‹ï¼ŒAnsible å°è¯•è·å–å°½å¯èƒ½å¤šçš„ä¸»æœºæ¥å®Œæˆ playã€‚
  
  - ğŸš€ Ansible è¿è¡Œ playbook çš„è¦ç‚¹ï¼š
    
    - è‹¥æŸä¸€ä»»åŠ¡å¯¹äºæŸä¸€ä¸»æœºå¤±è´¥ï¼Œåˆ™å®ƒå°†ä» play ä¸­ä¸¢å¼ƒï¼Œä½† Ansible å°†ç»§ç»­ä¸ºå…¶ä»–ä¸»æœºè¿è¡Œ play ä¸­å‰©ä½™çš„ä»»åŠ¡ã€‚
    
    - ğŸ’¥ ä»…å½“æ‰€æœ‰ä¸»æœºéƒ½å¤±è´¥æ—¶ï¼Œplay æ‰ä¼šåœæ­¢ã€‚
    
    - ä½†è‹¥ä½¿ç”¨ serial å…³é”®å­—å°†ä¸»æœºç»„ç»‡åˆ°æ‰¹å¤„ç†ä¸­ï¼Œé‚£ä¹ˆè‹¥å½“å‰æ‰¹å¤„ç†ä¸­çš„æ‰€æœ‰ä¸»æœºéƒ½å¤±è´¥ï¼Œåˆ™ Ansible å°†åœæ­¢æ‰€æœ‰å‰©ä½™ä¸»æœºçš„ playï¼Œè€Œä¸ä»…ä»…æ˜¯å½“å‰æ‰¹å¤„ç†ä¸­å‰©ä½™çš„ä¸»æœºã€‚
    
    - è‹¥ç”±äºæ‰¹å¤„ç†ä¸­çš„æ‰€æœ‰ä¸»æœºå¤±è´¥è€Œåœæ­¢äº†è¯¥ play çš„æ‰§è¡Œï¼Œåˆ™ä¸‹ä¸€ä¸ªæ‰¹å¤„ç†å°†ä¸ä¼šå¯åŠ¨ã€‚
  
  - âœ¨ `ansible_play_batch` å˜é‡ï¼š
    
    - æ¯ä¸ªæ‰¹å¤„ç†ä¿ç•™æ´»åŠ¨ä¸»æœºåˆ—è¡¨ã€‚
    
    - ä»»ä½•æœ‰ä»»åŠ¡å¤±è´¥çš„ä¸»æœºéƒ½å°†ä» ansible_play_batch åˆ—è¡¨ä¸­åˆ é™¤ã€‚
    
    - Ansible ä¼šåœ¨æ¯é¡¹ä»»åŠ¡åæ›´æ–°æ­¤åˆ—è¡¨ã€‚
  
  - ç¤ºä¾‹ï¼š
    
    é’ˆå¯¹åŒ…å« 100 ä¸ªä¸»æœºçš„ web_servers ä¸»æœºç»„æ‰§è¡Œçš„ 2 ç§æ–¹æ³•
    
    ğŸ‘‰ æ–¹æ³• 1ï¼š
    
    ```yaml
    ---
    - name: Update Webservers
      hosts: web_servers
      tasks:
        - name: Step One
          shell: /usr/bin/some_command
        - name: Step Two
          shell: /usr/bin/some_other_command
    ```
    
    - è‹¥ Web æœåŠ¡å™¨ä¸­æœ‰ 99 ä¸ªçš„ç¬¬ä¸€ä¸ªä»»åŠ¡å¤±è´¥ï¼Œä½†ä¸€ä¸ªä¸»æœºæˆåŠŸï¼Œåˆ™ Ansible å°†ç»§ç»­æ‰§è¡Œç¬¬äºŒä¸ªä»»åŠ¡ã€‚
    
    - å½“ Ansible æ‰§è¡Œç¬¬äºŒä¸ªä»»åŠ¡æ—¶ï¼ŒAnsible ä»…ä¸ºä¹‹å‰æˆåŠŸçš„ä¸€ä¸ªä¸»æœºæ‰§è¡Œè¯¥ä»»åŠ¡ã€‚
    
    ğŸ‘‰ æ–¹æ³• 2ï¼š
    
    ```yaml
    ---
    - name: Update Webservers
      hosts: web_servers
      serial: 2
      tasks:
        - name: Step One
          shell: /usr/bin/some_command
        - name: Step Two
          shell: /usr/bin/some_other_command
    ```
    
    - è‹¥ä½¿ç”¨Â serial å…³é”®å­—ï¼Œåˆ™åªæœ‰å½“å‰æ‰¹å¤„ç†ä¸­å‰©ä½™äº†æ²¡æœ‰å¤±è´¥çš„ä¸»æœºï¼Œplaybook æ‰§è¡Œæ‰ä¼šç»§ç»­ã€‚
    
    - è‹¥ç¬¬ä¸€ä¸ªæ‰¹å¤„ç†ä¸­åŒ…å«ä¸¤ä¸ªä¸»æœºï¼Œä¸€ä¸ªæˆåŠŸï¼Œä¸€ä¸ªå¤±è´¥ï¼Œåˆ™æ‰¹å¤„ç†å°†å®Œæˆï¼Œå¹¶ä¸” Ansibleå°†ç§»åŠ¨åˆ°ç¬¬äºŒä¸ªåŒ…å«ä¸¤ä¸ªä¸»æœºçš„æ‰¹å¤„ç†ã€‚
    
    - è‹¥ç¬¬äºŒä¸ªæ‰¹å¤„ç†ä¸­çš„ä¸¤ä¸ªä¸»æœºåœ¨ play ä¸­çš„ä»»åŠ¡ä¸Šå¤±è´¥ï¼Œåˆ™ Ansible å°†ä¸­æ­¢æ•´ä¸ª playï¼Œä¸å†å¯åŠ¨æ‰¹å¤„ç†ã€‚
    
    - åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œplaybook æ‰§è¡Œåï¼š
      
      - ä¸€ä¸ªä¸»æœºæˆåŠŸå®Œæˆ play
      
      - ä¸‰ä¸ªä¸»æœºå¯èƒ½å¤„äºé”™è¯¯çŠ¶æ€
      
      - å…¶ä½™çš„ä¸»æœºä¿æŒä¸å˜

- æŒ‡å®šå®¹é”™ï¼ˆfailure toleranceï¼‰ï¼š
  
  - é»˜è®¤æƒ…å†µä¸‹ï¼ŒAnsible ä»…åœ¨æ‰¹å¤„ç†ä¸­çš„æ‰€æœ‰ä¸»æœºå¤±è´¥æ—¶åœæ­¢ play æ‰§è¡Œã€‚
  
  - è‹¥æ¸…å•ä¸­æœ‰è¶…è¿‡ä¸€å®šç™¾åˆ†æ¯”çš„ä¸»æœºå¤±è´¥ï¼Œä¹Ÿå¯èƒ½å¸Œæœ› play ä¸­æ­¢ï¼Œå³ä½¿æ•´ä¸ªæ‰¹å¤„ç†æ²¡å…¨éƒ¨å¤±è´¥ã€‚
  
  - âœ¨ `max_fail_percentage` å…³é”®å­—ï¼š
    
    - é»˜è®¤å€¼ `100%`
    
    - å½“æ‰¹å¤„ç†ä¸­å¤±è´¥çš„ä¸»æœºæ•°é‡è¶…è¿‡æ­¤ç™¾åˆ†æ¯”æ—¶ï¼ŒAnsible å°†æš‚åœ playbook æ‰§è¡Œã€‚
    
    - å¯è®¾ç½®ä¸º `0`ï¼Œè‹¥æœ‰ä»»ä½•ä»»åŠ¡å¤±è´¥ï¼Œå¯ç›´æ¥ä¸­æ­¢ playã€‚
  
  - ç¤ºä¾‹ï¼š
    
    é’ˆå¯¹åŒ…å« 100 ä¸ªä¸»æœºçš„ web_servers ä¸»æœºç»„æ‰§è¡Œ
    
    ```yaml
    ---
    - name: Update Webservers
      hosts: web_servers
      max_fail_percentage: 30%
      # è¯¥å‚æ•°åœ¨æ¯ä¸ªæ‰¹å¤„ç†ä¸­éƒ½å°†è¿›è¡Œåˆ¤æ–­
      serial:
        - 2
        - 10%
        - 100%
      tasks:
        - name: Step One
          shell: /usr/bin/some_command
        - name: Step Two
          shell: /usr/bin/some_other_command
    ```
    
    - ç¬¬ä¸€ä¸ªæ‰¹å¤„ç†åŒ…å« 2 ä¸ªä¸»æœºã€‚
    
    - ç”±äº 30% çš„ 2 æ˜¯ 0.6ï¼Œå› æ­¤å•ä¸ªä¸»æœºå¤±è´¥ä¼šå¯¼è‡´æ‰§è¡Œåœæ­¢ã€‚
    
    - è‹¥ç¬¬ä¸€ä¸ªæ‰¹å¤„ç†ä¸­çš„ä¸¤ä¸ªä¸»æœºéƒ½æˆåŠŸï¼Œåˆ™ Ansible å°†ç»§ç»­æ‰§è¡ŒåŒ…å« 10 ä¸ªä¸»æœºçš„ç¬¬äºŒä¸ªæ‰¹å¤„ç†ã€‚
    
    - ç”±äº 10 çš„ 30% æ˜¯ 3ï¼Œå› æ­¤ï¼Œå¿…é¡»æœ‰è¶…è¿‡ 3 ä¸ªä¸»æœºå¤±è´¥æ‰ä¼šå¯¼è‡´ Ansible åœæ­¢ playbook æ‰§è¡Œã€‚
    
    - å¦‚æœä¸‰ä¸ªæˆ–æ›´å°‘çš„ä¸»æœºåœ¨ç¬¬äºŒä¸ªæ‰¹å¤„ç†ä¸­é‡åˆ°é”™è¯¯ï¼ŒAnsible å°†ç»§ç»­æ‰§è¡Œç¬¬ä¸‰ä¸ªæ‰¹å¤„ç†ã€‚
  
  - ğŸš€ Ansible çš„å¤±è´¥è¡Œä¸ºæ€»ç»“ï¼š
    
    - è‹¥æœªè®¾ç½® serial å…³é”®å­—å’Œ max_fail_percentage å€¼ï¼Œåˆ™æ‰€æœ‰ä¸»æœºéƒ½å°†åœ¨ä¸€ä¸ªæ‰¹å¤„ç†ä¸­é€šè¿‡ play è¿è¡Œï¼Œè‹¥æ‰€æœ‰ä¸»æœºéƒ½å¤±è´¥ï¼Œåˆ™ play å°†å¤±è´¥ï¼Œåªè¦ä¸€ä¸ªä¸»æœºå¯ç»§ç»­æ‰§è¡Œä»»åŠ¡ï¼Œplay å°†ç»§ç»­æ‰§è¡Œã€‚
    
    - è‹¥è®¾ç½®äº† serial å…³é”®å­—ï¼Œåˆ™ä¸»æœºå°†åœ¨å¤šä¸ªæ‰¹å¤„ç†ä¸­é€šè¿‡ play è¿è¡Œï¼Œè‹¥ä»»ä½•ä¸€ä¸ªæ‰¹å¤„ç†ä¸­çš„æ‰€æœ‰ä¸»æœºéƒ½å¤±è´¥æ—¶ï¼Œplay å°†ä¼šå¤±è´¥ã€‚
    
    - è‹¥è®¾ç½®äº† max_fail_percentage å…³é”®å­—ï¼Œåˆ™å½“æ‰¹å¤„ç†ä¸­è¶…è¿‡è¯¥ç™¾åˆ†æ¯”çš„ä¸»æœºå¤±è´¥æ—¶ï¼Œè¯¥ play å°†å¤±è´¥ã€‚
    
    - play å¤±è´¥ï¼Œåˆ™ playbook ä¸­å‰©ä½™çš„æ‰€æœ‰ play éƒ½å°†è¢«ä¸­æ­¢ã€‚

- ä¸€æ¬¡è¿è¡Œä¸€ä¸ªä»»åŠ¡ï¼ˆ`run a task once`ï¼‰ï¼š
  
  - `run_once: yes` å…³é”®å­—ï¼š
    
    ä½¿ä¸€é¡¹ä»»åŠ¡åªåœ¨æ¯ä¸ªæ‰¹å¤„ç†çš„ä¸€å°ä¸»æœºä¸Šè¿è¡Œï¼Œå³æ•´ä¸ªæ‰¹å¤„ç†ä¸­åªè¿è¡Œä¸€æ¬¡ï¼Œè€Œä¸æ˜¯æ‰¹å¤„ç†ä¸­çš„æ‰€æœ‰ä¸»æœºã€‚
  
  - [ç¤ºä¾‹](https://github.com/Alberthua-Perl/ansible-demo/blob/master/do447-course-demo/chapter05/serial_run_once_demo.yaml)ï¼š
    
    ```yaml
    ---
    - name: test serial and run_once keywords
      hosts: all,!gitlab_node
      # è¯¥ç¤ºä¾‹ä¸­ä¸»æœºç»„ä¸ºé™¤äº† gitlab_node ä¸»æœºç»„å¤–çš„æ‰€æœ‰ä¸»æœº
      order: sorted 
      # æŒ‡å®šçš„ä¸»æœºç»„ä¸­æŒ‰å­—æ¯é¡ºåºæ‰§è¡Œä»»åŠ¡
      become: false
      gather_facts: no
      serial: 2
    
      tasks:
        - name: 'List: show all hosts in play'
          debug:
            var: ansible_play_hosts
    
        - name: 'List: show all hosts in each batch'
          debug:
            var: ansible_play_batch
    
        - debug:
            msg: First host in play is {{ ansible_play_hosts[0] }}
    
        - name: Report batch process on managed hosts
          shell: "echo {{ inventory_hostname }} -- {{ batch_nodes }} >> /tmp/batch_nodes.txt"
          # ä½¿ç”¨é­”æ³•å˜é‡ï¼Œè‹¥ä½¿ç”¨äº‹å®å˜é‡å°†æŠ¥é”™ï¼
          run_once: yes
          # Just run once on the first node of batch, ignore other nodes.
          delegate_to: workstation.lab.example.com
          vars:
            batch_nodes: "{{ ansible_play_batch | join(' ') }}"
          # ansible_play_batch variable is list included batch managed hosts.
    Â Â Â Â Â Â #when: inventory_hostname == ansible_play_hosts[0]
          # Just run the task on the fist node of all hosts
    ```
    
    ```bash
    â”Œâ”€[devops][workstation][Â±][master âœ“][~/.../ansible-demo/do447-course-demo]
    â””â”€â cat /tmp/batch_nodes.txt 
    servera.lab.example.com -- servera.lab.example.com serverb.lab.example.com
    serverc.lab.example.com -- serverc.lab.example.com serverd.lab.example.com
    servere.lab.example.com -- servere.lab.example.com serverf.lab.example.com
    workstation.lab.example.com -- workstation.lab.example.com
    # ç»“æœæ˜¾ç¤ºä»»åŠ¡åœ¨æ¯ä¸ªæ‰¹å¤„ç†çš„ç¬¬ä¸€å°ä¸»æœºä¸Šè¿è¡Œ
    ```
  
  - è‹¥åªéœ€è¦ä¸º play ä¸­çš„æ‰€æœ‰ä¸»æœºè¿è¡Œä¸€æ¬¡ä»»åŠ¡ï¼Œå¹¶ä¸”è¯¥ play å…·æœ‰å¤šä¸ªæ‰¹å¤„ç†ï¼Œé‚£ä¹ˆå¯å°†ä»¥ä¸‹æ¡ä»¶æ·»åŠ åˆ°ä»»åŠ¡ä¸­ã€‚
    
    ```yaml
    when: inventory_hostname == ansible_play_hosts[0]
    # ä»…é’ˆå¯¹ play ä¸­çš„ç¬¬ä¸€ä¸ªä¸»æœºè¿è¡Œä»»åŠ¡ï¼ˆansible_play_hosts åˆ—è¡¨å˜é‡ï¼‰ã€‚ 
    ```
