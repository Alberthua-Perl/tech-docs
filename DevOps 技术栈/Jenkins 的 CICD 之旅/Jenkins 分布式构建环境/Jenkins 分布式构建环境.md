# Jenkins åˆ†å¸ƒå¼æ„å»ºç¯å¢ƒ

## æ–‡æ¡£ç›®å½•

- [1. Jenkins éƒ¨ç½²æ¶æ„æ¦‚è¿°](#1-jenkins-éƒ¨ç½²æ¶æ„æ¦‚è¿°)
- [2. Jenkins éƒ¨ç½²æ¶æ„è¯¦è§£](#2-jenkins-éƒ¨ç½²æ¶æ„è¯¦è§£)
  - [2.1 å• Master èŠ‚ç‚¹æ¶æ„](#21-å•-master-èŠ‚ç‚¹æ¶æ„)
  - [2.2 åˆ†å¸ƒå¼æ¶æ„ï¼ˆMaster + Agentï¼‰](#22-åˆ†å¸ƒå¼æ¶æ„master--agent)
    - [2.2.1 å›ºå®š Agent ç±»å‹](#221-å›ºå®š-agent-ç±»å‹)
    - [2.2.2 åŠ¨æ€ Agent ç±»å‹](#222-åŠ¨æ€-agent-ç±»å‹)
- [å‚è€ƒé“¾æ¥](#å‚è€ƒé“¾æ¥)

## 1. Jenkins éƒ¨ç½²æ¶æ„æ¦‚è¿°

Jenkins éƒ¨ç½²åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æ¨¡å¼ï¼š

- ä¸€ç§æ˜¯ç›´æ¥ä½¿ç”¨å• Master å®‰è£… Jenkinsï¼Œç›´æ¥è¿›è¡Œä»»åŠ¡ç®¡ç†å’Œä¸šåŠ¡æ„å»ºå‘å¸ƒï¼Œä½†å¯èƒ½å­˜åœ¨ä¸€å®šçš„ç”Ÿäº§å®‰å…¨é£é™©ã€‚
- ä¸€ç§æ˜¯ Master åŠ  Agent æ¨¡å¼ã€‚Master èŠ‚ç‚¹ä¸»è¦æ˜¯å¤„ç†è°ƒåº¦æ„å»ºä½œä¸šï¼ŒæŠŠæ„å»ºåˆ†å‘åˆ° Agent å®é™…æ‰§è¡Œï¼Œç›‘è§† Agent çš„çŠ¶æ€ã€‚ä¸šåŠ¡æ„å»ºå‘å¸ƒçš„å·¥ä½œäº¤ç»™ Agent è¿›è¡Œï¼Œå³æ‰§è¡Œ Master åˆ†é…çš„ä»»åŠ¡ï¼Œå¹¶è¿”å›ä»»åŠ¡çš„è¿›åº¦å’Œç»“æœã€‚

Jenkins çš„ Master å’Œ Agent å‡å¯å®‰è£…åœ¨è™šæ‹Ÿæœºæˆ–å®¹å™¨ä¸­ï¼Œä¸”ç»„åˆå½¢å¼å¯å¤šæ ·ã€‚

| éƒ¨ç½²æ¨¡å¼ | Master | Agent | ä¼˜ç¼ºç‚¹åˆ†æ |
|-----|-----|-----|-----|
| å• Master | è™šæ‹Ÿæœº | - | âœ… **ä¼˜ç‚¹**ï¼šæœ¬åœ°åŒ–æ„å»ºï¼Œæ“ä½œç®€å•ã€‚<br> âŒ **ç¼ºç‚¹**ï¼šä»»åŠ¡ç®¡ç†å’Œæ‰§è¡Œéƒ½åœ¨åŒä¸€å°è™šæ‹Ÿæœºä¸Šï¼Œå®‰å…¨é£é™©è¾ƒé«˜ã€‚|
| å• Master | å®¹å™¨ | - | âœ… **ä¼˜ç‚¹**ï¼šåˆ©ç”¨ Kubernetes Pod è°ƒåº¦æœºåˆ¶ï¼Œæ‹¥æœ‰ä¸€å®šçš„è‡ªæ„ˆèƒ½åŠ›ã€‚<br> âŒ **ç¼ºç‚¹**ï¼šä»»åŠ¡ç®¡ç†å’Œæ‰§è¡Œæ²¡æœ‰åˆ†ç¦»ï¼Œå®‰å…¨é£é™©é—®é¢˜ä»æœªè§£å†³ã€‚|
| Master + Agent | è™šæ‹Ÿæœº | è™šæ‹Ÿæœº | âœ… **ä¼˜ç‚¹**ï¼šä»»åŠ¡ç®¡ç†å’Œæ‰§è¡Œåˆ†ç¦»ï¼Œé™ä½äº†ä¸€å®šçš„å®‰å…¨é£é™©ã€‚<br> âŒ **ç¼ºç‚¹**ï¼šåªèƒ½å›ºå®š Agentï¼Œæ— æ³•è¿›è¡Œèµ„æºè°ƒåº¦ï¼Œèµ„æºåˆ©ç”¨ç‡ä½ï¼Œä¸”ç¯å¢ƒç»´æŠ¤æˆæœ¬é«˜ã€‚|
| Master + Agent | è™šæ‹Ÿæœº | å®¹å™¨ï¼ˆKubernetesé›†ç¾¤ï¼‰ | âœ… **ä¼˜ç‚¹**ï¼šå®¹å™¨åŒ–çš„ Agent å¯ä»¥é€‰æ‹©å›ºå®š Agentï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Kubernetes å®ç°åŠ¨æ€ Agentï¼ŒåŠ¨æ€ Agent çš„æ–¹å¼èµ„æºåˆ©ç”¨ç‡é«˜ã€‚å¹¶ä¸”å¯ä»¥æ ¹æ®è°ƒåº¦ç­–ç•¥å‡åŒ€åˆ†é…ä»»åŠ¡ï¼ŒåæœŸä¹Ÿæ¯”è¾ƒå®¹æ˜“ç»´æŠ¤ã€‚<br> âŒ **ç¼ºç‚¹**ï¼šJenkins çš„ Master å­˜åœ¨å°æ¦‚ç‡çš„å®•æœºé£é™©ï¼Œæ¢å¤æˆæœ¬è¾ƒé«˜ã€‚|
| Master + Agent| å®¹å™¨ï¼ˆKubernetesé›†ç¾¤ï¼‰| å®¹å™¨ï¼ˆKubernetesé›†ç¾¤ï¼‰| âœ… **ä¼˜ç‚¹**ï¼šå®¹å™¨åŒ–çš„ Agent å¯ä»¥é€‰æ‹©å›ºå®š Agentï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Kubernetes å®ç°åŠ¨æ€ Agentï¼Œèµ„æºåˆ©ç”¨ç‡é«˜ã€‚å¹¶ä¸” Master å…·æœ‰è‡ªæ„ˆèƒ½åŠ›ï¼Œç»´æŠ¤æˆæœ¬ä½ã€‚Agent å¯ä»¥é€‰æ‹©å’Œ Master å…±é›†ç¾¤ï¼Œä¹Ÿå¯ä»¥åˆ†é›†ç¾¤ã€‚<br> âŒ **ç¼ºç‚¹**ï¼šç³»ç»Ÿå¤æ‚ç¨‹åº¦é«˜ï¼Œç¯å¢ƒæ­å»ºè¾ƒå›°éš¾ã€‚|

## 2. Jenkins éƒ¨ç½²æ¶æ„è¯¦è§£

### 2.1 å• Master èŠ‚ç‚¹æ¶æ„

- å• Master å®‰è£… Jenkinsï¼Œç›´æ¥è¿›è¡Œä»»åŠ¡ç®¡ç†å’Œä¸šåŠ¡æ„å»ºå‘å¸ƒã€‚

  <center><img src="images/jenkins-cluster-alone-master.png" style="width:80%"></center>

  <center>å›¾ 2.1-1 Jenkins å• Master èŠ‚ç‚¹æ¶æ„ç¤ºæ„</center>

- å¯¹äºæŸäº›ç‰¹å®šåœºæ™¯ï¼Œå•èŠ‚ç‚¹ä¸è¶³ä»¥æ»¡è¶³éœ€æ±‚ï¼š
  - å¦‚æœæ‰€æœ‰æ‰§è¡Œç¨‹åºï¼ˆexecutorï¼‰éƒ½å¿™äºå¤„ç†æ„å»ºä½œä¸šï¼Œåˆ™ä½œä¸šï¼ˆjobï¼‰å¿…é¡»ç­‰å¾…ã€‚
  - å½“é¡¹ç›®çš„æ•°é‡æˆ–è´Ÿè½½å¢åŠ æ—¶ï¼Œå¾ˆå¯èƒ½ä¼šè€—å°½èµ„æºã€‚
- ä¸ºäº†æ¢å¤å¹¶è¿è¡Œ Jenkins åŸºç¡€è®¾æ–½ï¼Œéœ€è¦é€šè¿‡å¢åŠ å†…å­˜ã€CPU ç­‰æ¥æ‰©å®¹æœåŠ¡å™¨ï¼Œè€Œè¿™ä¸å…·å¤‡å¯æ‰©å±•æ€§ï¼Œå¿…é¡»æ ¹æ®éœ€æ±‚ç»´æŠ¤å’Œå‡çº§æœåŠ¡å™¨ã€‚
- åœ¨ç»´æŠ¤å‡çº§è¿‡ç¨‹ä¸­ï¼Œæ„å»ºç¯å¢ƒå°†è¢«å…³é—­ï¼Œä½œä¸šä¸å¾—ä¸åœæ­¢ï¼Œæ•´ä¸ª Jenkins åŸºç¡€è®¾æ–½å°†ä¸å¯ç”¨ã€‚
- è¿™ç§å•èŠ‚ç‚¹æ¶æ„ä¼šé€ æˆç³»ç»Ÿç»å¸¸å¤„äº idle çŠ¶æ€ï¼Œåˆ†é…ç»™ Jenkins ç¯å¢ƒçš„èµ„æºåœ¨è¿™ç§çŠ¶æ€ä¸‹ä¹Ÿæ²¡æ³•è¢«å……åˆ†åˆ©ç”¨ã€‚
- å•èŠ‚ç‚¹æ¶æ„è¿˜ä¼šå¼•å…¥å®‰å…¨é—®é¢˜ï¼Œå› ä¸º Jenkins ç”¨æˆ·å¯¹æ‰€æœ‰èµ„æºå’Œå·¥ä½œç©ºé—´éƒ½æ‹¥æœ‰å®Œå…¨çš„æƒé™ã€‚
- ç”±äºè¿™äº›åŸå› ï¼ŒJenkins æ”¯æŒåˆ†å¸ƒå¼æ¶æ„ï¼Œå…¶ä¸­æ„å»ºé¡¹ç›®çš„å·¥ä½œè´Ÿè½½è¢«å§”æ‰˜ç»™å¤šä¸ª Jenkins ä»£ç†ï¼ˆagentï¼‰ã€‚

### 2.2 åˆ†å¸ƒå¼æ¶æ„ï¼ˆMaster + Agentï¼‰

- Jenkins çš„ Master èŠ‚ç‚¹å’Œ Agent èŠ‚ç‚¹å‡å¯å®‰è£…åœ¨ç‰©ç†æœºã€è™šæ‹Ÿæœºæˆ–å®¹å™¨ä¸­ï¼Œå¯æ ¹æ®è‡ªèº«éœ€æ±‚é€‰æ‹©å…¶ä¸­ä¸€ç§æ–¹æ¡ˆæ‰§è¡Œã€‚
- Jenkins åˆ†å¸ƒå¼æ¶æ„ç‰¹ç‚¹ï¼š
  - Master èŠ‚ç‚¹è´Ÿè´£ï¼ˆä¹Ÿå« Controller èŠ‚ç‚¹ï¼‰ï¼š
    - è°ƒåº¦æ„å»ºä½œä¸š
    - å°†æ„å»ºä½œä¸šåˆ†å‘ç»™ Agent å®é™…æ‰§è¡Œ
    - ç›‘è§† Agent èŠ‚ç‚¹ï¼Œå¹¶æ ¹æ®éœ€è¦åœæ­¢å…¶å·¥ä½œã€‚
  - Agent èŠ‚ç‚¹è´Ÿè´£ï¼ˆä¹Ÿå« Slave èŠ‚ç‚¹ï¼‰ï¼š
    - ä» Master èŠ‚ç‚¹æ¥æ”¶è¯·æ±‚æˆ–å·¥ä½œï¼ŒAgent çš„å·¥ä½œå°±æ˜¯æŒ‰å‘½ä»¤è¡Œäº‹ã€‚
    - å¯ä»¥å°†å·¥ä½œé…ç½®ä¸ºå§‹ç»ˆåœ¨ç‰¹å®š Agent ä¸Šæ‰§è¡Œ
    - Master èŠ‚ç‚¹å°†åˆ©ç”¨å…¶èµ„æºæ¥å¤„ç† HTTP è¯·æ±‚å’Œç®¡ç†æ„å»ºç¯å¢ƒï¼Œæ„å»ºçš„å®é™…æ‰§è¡Œå°†å§”æ‰˜ç»™ Agentã€‚
- é€šè¿‡è¿™ç§é…ç½®ï¼Œå¯ä»¥æ¨ªå‘æ‰©å±• Jenkins æ¶æ„ï¼Œå…¶ä¸­ Jenkins å°†å®‰è£…åœ¨å•ä¸ªèŠ‚ç‚¹ä¸Šã€‚

#### 2.2.1 å›ºå®š Agent ç±»å‹

- Agent ä¸€ç›´è¿è¡Œï¼Œä»»åŠ¡æ„å»ºå®Œæˆåä¸ä¼šé”€æ¯ï¼Œåˆ›å»ºå®Œæˆåå°†ä¸€ç›´å ç”¨é›†ç¾¤èµ„æºï¼Œé…ç½®è¿‡ç¨‹è¾ƒç®€å•ã€‚æ¯ä¸ª Agent å¯ä»¥å­˜åœ¨å¤šä¸ª executorï¼Œå…·ä½“çš„æ•°é‡åº”è¯¥æ ¹æ®Agent æ‰€åœ¨ä¸»æœºçš„ç³»ç»Ÿèµ„æºæ¥è®¾å®šã€‚
- å¸¸è§çš„å›ºå®š Agent éƒ¨ç½²åœºæ™¯å¦‚ä¸‹ï¼š
  - Linux Jenkinsï¼ˆå¸¸ç”¨ï¼‰
  - Windows Jenkins
  - å®¹å™¨åŒ– Agent
- ğŸ’¥ æ³¨æ„ï¼šå¾ˆå¤šçš„æ„å»ºæ­¥éª¤ï¼Œæœ‰å¯èƒ½ä¼šé€šè¿‡è¿è¡Œ shell å‘½ä»¤è¿›è¡Œï¼Œäºæ˜¯æ­¤æ—¶è¦ç¡®ä¿åœ¨ç‰©ç†æœºã€è™šæ‹Ÿæœºæˆ–å®¹å™¨å†…éƒ¨æœ‰å¯ç”¨çš„å‘½ä»¤ï¼Œæ¯”å¦‚æµæ°´çº¿é£æ ¼çš„ä½œä¸šä¸­éœ€è¦æ‰§è¡Œ mvn å‘½ä»¤ï¼Œéœ€è¦åœ¨å®¹å™¨å†…å®‰è£…é…ç½®å¥½ maven å·¥å…·ç­‰ã€‚

#### 2.2.2 åŠ¨æ€ Agent ç±»å‹

- æ„å»ºä»»åŠ¡æ—¶åŠ¨æ€åˆ›å»º Agent å®¹å™¨ï¼Œå¹¶åœ¨ä»»åŠ¡æ„å»ºå®Œæˆåé”€æ¯å®¹å™¨ï¼Œå¯å®ç°èµ„æºåŠ¨æ€åˆ†é…ï¼Œèµ„æºåˆ©ç”¨ç‡é«˜ï¼Œä½†æ˜¯é…ç½®è¿‡ç¨‹è¾ƒä¸ºå¤æ‚ã€‚å¯ä»¥æŠŠæ¯ä¸ª Agent è§†ä½œä¸€ä¸ªåŠ¨æ€çš„ executorã€‚
- ä¾èµ–äº‘ç¯å¢ƒï¼Œé€šè¿‡ Jenkins Controllerï¼ˆå³ Jenkins Mater èŠ‚ç‚¹ï¼‰ä¸äº‘ç¯å¢ƒè¿›è¡Œäº¤äº’ä»¥ç®¡ç†è¿™äº›åŠ¨æ€ Agentã€‚Jenkins Controller é€šè¿‡APIï¼ˆä¾èµ–æ’ä»¶ï¼‰ä¸äº‘æä¾›å•†çš„æœåŠ¡è¿›è¡Œé€šä¿¡ï¼Œå‘é€è¯·æ±‚ä»¥åˆ›å»ºæ–°çš„èµ„æºï¼ˆå¦‚è™šæ‹Ÿæœºæˆ–å®¹å™¨ï¼‰ã€é…ç½®è¿™äº›èµ„æºä»¥ä½œä¸º Jenkins Agent è¿è¡Œï¼Œä»¥åŠåœ¨ä½œä¸šå®Œæˆåé”€æ¯è¿™äº›èµ„æºã€‚è¿™äº› API è°ƒç”¨å…è®¸ Jenkins Controller è‡ªåŠ¨åŒ–æ•´ä¸ªæµç¨‹ï¼Œä»èµ„æºçš„åˆ›å»ºåˆ°é”€æ¯ï¼Œä»è€Œå®ç°äº† Agent çš„åŠ¨æ€ç®¡ç†ã€‚
  - **Docker plugin**ï¼šåŸºäºé…ç½®çš„ Docker ä¸»æœºï¼ŒæŒ‰éœ€è¦åˆ›å»ºå®¹å™¨è¿è¡Œ Agentï¼Œéœ€è¦äº‹å…ˆé…ç½®å¥½ Agent çš„å®¹å™¨é•œåƒæ¨¡ç‰ˆã€‚
  - **Kubernetes plugin**ï¼ˆå¸¸ç”¨ï¼‰ï¼šåŸºäºé…ç½®çš„ Kubernetesï¼ŒæŒ‰éœ€è¦åˆ›å»º Pod è¿è¡Œ Agentï¼Œéœ€è¦äº‹å…ˆé…ç½® Pod çš„èµ„æºæ¸…å•å®šä¹‰ã€‚

    > æ³¨æ„ï¼šJenkins Controller è‡ªèº«æ—¢å¯ä»¥éƒ¨ç½²åœ¨ Kubernetes é›†ç¾¤ä¸Šï¼Œä¹Ÿå®Œå…¨å¯ä»¥è¿è¡Œåœ¨ Kubernetes å¤–ã€‚

<center><img src="images/jenkins-master-agent-k8s-deploy.png" style="width:80%"></center>

<center>å›¾ 2.2.2-1 Kuberbetes é›†ç¾¤ä¸­ Jenkins åˆ†å¸ƒå¼æ¶æ„çš„åŠ¨æ€ Agent</center>

## å‚è€ƒé“¾æ¥

- [åœ¨ CCE ä¸­å®‰è£…éƒ¨ç½² Jenkins æ–¹æ¡ˆæ¦‚è¿° | åä¸ºäº‘](https://support.huaweicloud.com/bestpractice-cce/cce_bestpractice_0066.html)
