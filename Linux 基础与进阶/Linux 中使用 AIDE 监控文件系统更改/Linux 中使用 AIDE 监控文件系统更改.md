# 第七章 监控文件系统更改

## 使用AIDE检测文件系统更改

### 使用AIDE分析文件系统更改

- 在正在运作的服务器上，常常要在其文件系统中添加、删除和修改文件。

- 但对某些文件（如可执行程序和配置文件）的意外更改可能表示未经授权的修改或其他安全问题。

- 因此，务必要监控这些文件的内容、权限或其他特征的变化。

- RHEL提供高级入侵检测环境（advanced intrusion detection environment，AIDE）这一用户空间实用程序。

- AIDE监控对文件的各种更改，包括权限或所有权更改、时间戳更改（修改或访问时间戳）或内容更改。

- 安装AIDE
  
  - 默认情况下，通常不安装aide软件包。
  
  - 需要先安装和配置此软件包，并且构建其初始数据库，然后才能检查文件系统。
  
  ```bash
  $ sudo yum install -y aide
  # 安装aide软件包
  ```

- 配置AIDE
  
  - /etc/aide.conf：AIDE配置文件
  
  - /var/lib/aide/aide.db.gz：旧AIDE数据库文件（一般作为AIDE检查基线）
  
  - /var/lib/aide/aide.db.new.gz：新AIDE数据库文件（执行aide --update命令后生成）
  
  - /var/log/aide/aide.log：AIDE检查执行日志
  
  - AIDE配置文件控制AIDE监控哪些文件的更改，以及监控每个文件的哪些特征。
  
  - 默认情况下，AIDE仅监控 /etc 目录中大多数文件的权限更改，但更密切地监控特定的文件。
  
  - 作为安全管理员，可能希望精确调整AIDE监控主机文件系统中不同部分的内容。
  
  - AIDE附带了一个配置合理的默认 /etc/aide.conf 文件，可使用其构建初始化的数据库。
  
  - ✅ 若希望或需要精确调整AIDE监控的内容，则应在构建或更新AIDE数据库之前修改该文件。
  
  - /etc/aide.conf 文件中的每行为指令（directive）。
  
  - 该文件包含三种类型的行：配置行、选择行、宏行
  
  - 注释以 "#" 开头，无任何作用。

- 配置行（configuration line）
  
  - 配置行调整AIDE的配置参数。
  
  - 配置行的作用：全局调整AIDE的功能行为、设置组定义（group definition）
  
  - 选择行使用组定义来指定AIDE在检测文件系统更改时应监控的文件的特征。
  
  - 配置行语法：parameter = value
  
  - 配置参数（parameter）如下所示：
    
    - database:
      
      - AIDE在运行检查时从中读取数据库的位置（旧AIDE数据库文件），通常是本地文件。
    
    - database_out：
      
      - AIDE在更新时写入数据库的位置（新AIDE数据库文件），通常也是本地文件，并且必须与输入数据库不同。
    
    - gzip_dbout：
      
      - 若此参数设置为yes，则AIDE将创建一个新数据库并使用gzip命令对其进行压缩。
      
      - 配置行还可以创建组定义，组定义与选择行一起使用，以设置要监控的文件的特征。
      
      - /etc/aide.conf 文件中组定义示例：定义 PERMS 的组，若选择行使用该组定义，将监控该行选择的文件中权限（p）、用户（u）、组（g）、访问控制列表（acl）、SELinux上下文（selinux）和文件系统扩展属性（xattr）的更改。(此处有图片)

- 选择行（selection line）
  
  - 选择行指定AIDE监控的文件和目录，以及AIDE将要监视的更改。
  
  - 选择行可以是常规（regular）、等于（equals）或否定（negative）。
  
  - 常规选择行：文件或目录的绝对路径匹配的正则表达式 + 组定义
    
    - 与该正则表达式匹配的文件和目录将添加到AIDE数据库中，并且执行行的组定义指定的检查。
    
    - 若正则表达式（regex）为 /etc，则正则表达式将递归匹配 /etc 目录中的所有文件和目录。
  
  - 等于选择行：等号（=）开头 + 正则表达式 + 组定义
    
    - 通过考量该行的组定义提及的所有检查，AIDE记录与正则表达式匹配的文件。
    
    - ❗ 若正则表达式以正斜杠（/）字符结尾，则等于选择行仅匹配目录的子项，子目录的子项不会递归匹配。
  
  - 否定选择行：感叹号（!）开头 + 正则表达式
    
    - AIDE不监控与否定选择行匹配的文件或目录。
    
    - 示例：(此处有图片)

- 宏行（macro line）
  
  - 宏行设置或清除变量，这些变量可用于引用整个AIDE配置文件中多次出现的冗长URL或文件系统路径。
  
  - 示例：(此处有图片)

- 初始化AIDE数据库
  
  - 安装AIDE后，确保AIDE知道文件系统的当前状态至关重要。
  
  - AIDE使用文件系统的已知状态，作为检测和报告文件系统更改的参考点。
  
  - 理想情况下，可以在安装后尽快构建AIDE数据库。
  
  - ✅ AIDE通过将文件的当前状态与存储在AIDE数据库中的预期状态信息进行比较来进行操作。
  
  - 若没有基准数据库，AIDE就没有办法确定系统预期状态。
  
  ```bash
  $ sudo aide --init
  # 初始化AIDE数据库(此处有图片)
  ```

- 通过AIDE验证完整性
  
  - 在AIDE知道当前文件系统状态后，可以通过与已知状态进行比较来检测文件系统更改。
  
  ```bash
  $ sudo aide --check
  # 将现有系统文件的状态与已保存的数据库进行比较
  ```
  
  - 此处有图片
  
  - 默认情况下，报告将打印到标准输出和 /var/log/aide/aide.log 文件中。
  
  - 生产环境中，应定期执行AIDE检查，可使用 cron job、systemd timer unit 或其他方式来自动运行AIDE检查。
  
  - 如下所示：(此处有图片)

- 更新AIDE数据库
  
  - ✅ 推荐做法：在对系统进行预期更改后，务必要更新AIDE数据库。
  
  - 如，软件包更新或授权的配置文件调整可能会更改受监控文件的时间戳权限或校验和（checksum）。
  
  - 为避免AIDE报告误报，需要更新数据库以反映这些授权的更改。
  
  - 确认AIDE报告的所有剩余更改都已获得授权后，运行以下命令来更新AIDE数据库。
  
  ```bash
  $ sudo aide --update
  # 更新AIDE数据库
  ```
  
  - 此处有图片
  
  - ❗ 更新AIDE数据库后，不要忘将其替换旧的AIDE数据库，以使用新的数据库作为检查基线（baseline），除非仍使用旧数据库作为检查基线。
  
  - 初始化或更新AIDE数据库时，将增加系统负载！
  
  ```bash
  $ man 5 aide.conf
  # 查看AIDE配置文件详细说明
  ```

-----

## 使用AIDE调查文件系统更改

### 结合使用AIDE和Audit

- AIDE可用于检测主机文件系统上的更改，但其局限在于无法告知导致变化的原因。

- 如，可将AIDE配置为报告/etc/passwd和/etc/shadow的更改，但不会生成关于谁在何时使用哪个工具进行更改的详细信息，这是审计规则的用武之地，它们可以帮助获取所发生情况的详细信息。Linux Audit系统可以监控文件以查找可能导致更改的活动，并记录有关活动时间以及所涉及的进程和用户的许多有用信息。

- Linux Audit系统可以监控文件以查找可能导致更改的活动，并记录有关活动时间以及所涉及的进程和用户的许多有用信息。

- AIDE和Audit的组合可有效解决此问题。

- 通过配置两个系统来监控关键的文件和目录，可使用AIDE定期报告对系统进行的意外更改。

- ✅ 然后，可查看自更改之前的上一个AIDE报告以来的审计日志，以帮助确定可能负责的活动。

-----

### 配置AIDE和Audit

- 要使此方法有效，需配置AIDE和Audit以监控相同的文件。

- 首先确保正确配置AIDE，编辑 /etc/aide.conf 文件，初始化AIDE数据库，设置cron job来定期运行AIDE检查并将报告发送给系统管理员。

- 示例：
  
  - 编辑 /etc/aide.conf 文件：(此处有图片)
  
  - 编辑 /etc/audit/rules.d/*.rules 文件添加如下文件系统（监视）规则：(此处有图片)

- 以上示例AIDE将检查/usr目录的子项，不递归检查子目录的子项，设置文件系统（监视）规则递归监控/usr目录的写入或更改权限。

- ✅ 推荐做法：若不需要为审计目的收集信息，则可减少相应审计内容，这样可减少日志中的 “噪音”，减小日志大小，并可以提高性能，具体取决于规则的结构，如上述事例中可避免使用 -p rwxa。

-----

### 调查文件系统更改

```bash
$ sudo ausearch -i --start "dd/mm/yyyy" "hh:mm:ss" -f <filename>
# 基于文件名的审计日志查询
```

-----

### 解读审计事件（audit event）

- 示例1：审计使用普通用户更改/etc/group文件的时间戳，权限问题而无法更改。(此处有图片)

- 示例2：审计使用root用户更改/etc/group文件的内容，可直接添加用户组名称以创建用户组。(此处有图片)

- 常见的审计记录类型：(此处有图片)

- 审计记录字段说明：(此处有图片)
