## DNS åŸç†ä¸å¸¸ç”¨é…ç½®å®ç°

### æ–‡æ¡£è¯´æ˜ï¼š

- OS ç‰ˆæœ¬ï¼šCentOS Linux release 7.7.1908 (Core)
- Bind ç›¸å…³è½¯ä»¶åŒ…ç‰ˆæœ¬ï¼š
  - bind-9.11.4-9.P2.el7.x86_64 
  - bind-utils-9.11.4-9.P2.el7.x86_64
  - bind-chroot-9.11.4-9.P2.el7.x86_64

### æ–‡æ¡£ç›®å½•ï¼š

- DNS åŸŸåè§£ææœåŠ¡ä¹‹å±‚æ¬¡ç»“æ„
- DNS åŸŸåè§£ææœåŠ¡ä¹‹åŒºåŸŸ
- DNS æŸ¥è¯¢æµç¨‹
- DNS èµ„æºè®°å½•
- DNS ç¼“å­˜åŠå®ç°
- DNS åŸŸåæœåŠ¡å™¨ç±»å‹
- BIND DNS å®ç°æƒå¨åŸŸåè§£ææœåŠ¡
- dig å‘½ä»¤ä½¿ç”¨ç¤ºä¾‹
- host å‘½ä»¤ä½¿ç”¨ç¤ºä¾‹
- nslookup å‘½ä»¤ä½¿ç”¨ç¤ºä¾‹
- DNS å®‰å…¨é—®é¢˜
- å‚è€ƒé“¾æ¥

### DNS åŸŸåè§£ææœåŠ¡ä¹‹å±‚æ¬¡ç»“æ„ï¼š

- ç›¸è¾ƒäºç”±æ•°å­—æ„æˆçš„ IP åœ°å€ï¼ŒåŸŸåæ›´å®¹æ˜“è¢«ç†è§£å’Œè®°å¿†ï¼Œæ‰€ä»¥é€šå¸¸æ›´ä¹ æƒ¯é€šè¿‡åŸŸåçš„æ–¹å¼æ¥è®¿é—®ç½‘ç»œä¸­çš„èµ„æºã€‚

- ä½†ç½‘ç»œä¸­çš„è®¡ç®—æœºä¹‹é—´åªèƒ½åŸºäº IP åœ°å€æ¥ç›¸äº’è¯†åˆ«å¯¹æ–¹çš„èº«ä»½ï¼Œè€Œä¸”è¦æƒ³åœ¨äº’è”ç½‘ä¸­ä¼ è¾“æ•°æ®ï¼Œä¹Ÿå¿…é¡»åŸºäºå¤–ç½‘çš„ IP åœ°å€æ¥å®Œæˆã€‚

- å› æ­¤ï¼ŒDNSï¼ˆDomain Name Systemï¼ŒåŸŸåç³»ç»Ÿï¼‰æŠ€æœ¯åº”è¿è€Œç”Ÿã€‚

- è¯¥æŠ€æœ¯è§£å†³ç®¡ç†å’Œè§£æåŸŸåä¸ IP åœ°å€å¯¹åº”å…³ç³»ï¼Œå³ï¼Œèƒ½å¤Ÿæ¥å—ç”¨æˆ·è¾“å…¥çš„åŸŸåæˆ– IP åœ°å€ï¼Œç„¶åè‡ªåŠ¨æŸ¥æ‰¾ä¸ä¹‹åŒ¹é…ï¼ˆæˆ–è€…è¯´å…·æœ‰æ˜ å°„å…³ç³»ï¼‰çš„ IP åœ°å€æˆ–åŸŸåï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
  
  - æ­£å‘è§£æï¼šå°†åŸŸåè§£æä¸º IP åœ°å€
  
  - åå‘è§£æï¼šå°† IP åœ°å€è§£æä¸ºåŸŸå

- DNS åŸŸåè§£ææŠ€æœ¯çš„æ­£å‘è§£ææ˜¯æœ€å¸¸ä½¿ç”¨çš„ä¸€ç§å·¥ä½œæ¨¡å¼ã€‚

- é‰´äºäº’è”ç½‘ä¸­çš„åŸŸåå’Œ IP åœ°å€å¯¹åº”å…³ç³»æ•°æ®å¤ªè¿‡åºå¤§ï¼ŒDNS åŸŸåè§£ææœåŠ¡é‡‡ç”¨äº†ç±»ä¼¼ç›®å½•æ ‘çš„å±‚æ¬¡ç»“æ„æ¥è®°å½•åŸŸåä¸ IP åœ°å€ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼Œä»è€Œå½¢æˆäº†ä¸€ä¸ªå…·æœ‰å±‚æ¬¡ç»“æ„çš„å¤§å‹åˆ†å¸ƒå¼é›†ç¾¤ç³»ç»Ÿã€‚

- DNS åè®®è¿è¡Œåœ¨ UDP åè®®ä¹‹ä¸Šï¼Œä½¿ç”¨ç«¯å£å· `53`ã€‚

- åœ¨ RFC æ–‡æ¡£ä¸­ `RFC 2181` å¯¹ DNS æœ‰è§„èŒƒè¯´æ˜ï¼Œ`RFC 2136` å¯¹ DNS çš„åŠ¨æ€æ›´æ–°è¿›è¡Œè¯´æ˜ï¼Œ`RFC 2308` å¯¹ DNS æŸ¥è¯¢çš„åå‘ç¼“å­˜è¿›è¡Œè¯´æ˜ã€‚

- DNS åŸŸåç³»ç»Ÿå±‚æ¬¡ç»“æ„ï¼š
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dns-domain-hierarchical-structure.jpg)
  
  - æ ¹åŸŸåæœåŠ¡å™¨ï¼ˆRoot Domainï¼‰ï¼š
    
    ç”¨ `Â·`ï¼ˆå¥ç‚¹ï¼‰è¡¨ç¤ºï¼Œæ ¹åŸŸåæœåŠ¡å™¨å…¨çƒçš„æ•°é‡æ˜¯å›ºå®šçš„ï¼Œä¸º `13` ç»„ã€‚
  
  - é¡¶çº§åŸŸåæœåŠ¡å™¨ï¼ˆTop Level Domain, `TLD`ï¼‰ï¼š
    
    æŒ‡ä»£æŸä¸ªå›½å®¶/åœ°åŒºæˆ–ç»„ç»‡ä½¿ç”¨çš„ç±»å‹åç§°ï¼Œå¦‚ comã€cnã€edu ç­‰ã€‚
  
  - æ¬¡çº§åŸŸåæœåŠ¡å™¨ï¼ˆSecond Level Domain, `SLD`ï¼‰ï¼š
    
    ä¸ªäººæˆ–ç»„ç»‡åœ¨ Internet ä¸Šæ³¨å†Œçš„åç§°ï¼Œå¦‚ qq.comã€gitHub.com ç­‰ã€‚
  
  - ä¸‰çº§åŸŸåæœåŠ¡å™¨æˆ–æƒå¨åŸŸåæœåŠ¡å™¨ï¼ˆå¦‚æœæœ‰ï¼‰ï¼šThird Level Domain
    
    è¿™å±‚ä¸¥æ ¼æ¥è¯´æ˜¯æ¬¡çº§åŸŸåçš„å­åŸŸï¼Œæ˜¯äºŒå±‚åŸŸåæ´¾ç”Ÿçš„åŸŸåï¼Œé€šä¿—è¯´å°±æ˜¯ç½‘ç«™åï¼Œå¦‚ `cs.berkeley.edu`ã€‚
  
  - ä¸»æœºåï¼ˆå¦‚æœæœ‰ï¼‰ï¼š
    
    ä¸»æœºåç§°æ ‡ç­¾ï¼Œé€šå¸¸åœ¨ DNS åŸŸåæœ€å·¦ä¾§ï¼Œæ ‡è¯†ç½‘ç»œä¸Šçš„ç‰¹å®šè®¡ç®—æœºï¼Œå¦‚ `www.berkeley.edu`ã€‚

- 13 ç»„æ ¹åŸŸåæœåŠ¡å™¨çš„å…·ä½“ä¿¡æ¯ï¼š
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dns-root-server.jpg)

> ğŸ‘¨â€ğŸ« æ³¨æ„ï¼šä¸ºä»€ä¹ˆæ ¹åŸŸåæœåŠ¡å™¨å…¨çƒåªæœ‰ 13 ç»„ï¼Ÿ
> 
> 1. ä¸»è¦æ˜¯åŸºäºå½“æ—¶çš„ç½‘ç»œç¯å¢ƒï¼Œä» UDP åˆ†ç‰‡ä¸Šè€ƒè™‘ï¼Œä¿è¯æŠ¥æ–‡èƒ½ç•…é€šæ— é˜»ã€‚
> 
> 2. ç»å¤§å¤šæ•°çš„ç½‘ç»œæ¥å£ç±»å‹æ”¯æŒ IP æŠ¥æ–‡ â‰¤ 576 å­—èŠ‚æ— éœ€åˆ†ç‰‡è‡ªç”±é€šè¡Œï¼Œè€ƒè™‘åˆ°ä»¥ä¸Šå› ç´ ï¼ŒIETF å†³å®šå°† DNS æŠ¥æ–‡ä½“é™åˆ¶åœ¨ 512 å­—èŠ‚ã€‚æ¯ä¸€ç»„æ ¹åŸŸåæœåŠ¡å™¨å ç”¨ 32 å­—èŠ‚ï¼Œå…¶ä¸­åŒ…æ‹¬æ ¹åŸŸåçš„åç§°ã€IP åœ°å€ã€TTL (Time To Live) ç­‰å‚æ•°ã€‚
> 
> 3. 13 ç»„æ ¹åŸŸåæœåŠ¡å™¨ä¸€å…±å ç”¨ 416 å­—èŠ‚ï¼Œå‰©ä½™çš„ 96 å­—èŠ‚ç”¨äºåŒ…è£… DNS æŠ¥æ–‡å¤´ä»¥åŠå…¶å®ƒåè®®å‚æ•°ã€‚æ‰€ä»¥ä»ç©ºé—´ä¸Šæ¥è¯´ï¼Œæ²¡æœ‰å¤šä½™çš„ç©ºé—´å®¹çº³ç¬¬ 14 ç»„æ ¹åŸŸåæœåŠ¡å™¨çš„ 32 å­—èŠ‚ã€‚
> 
> 4. å®¹æ˜“è¢«è¯¯è§£çš„æ˜¯ï¼Œè¿™ 13 ç»„æ ¹åŸŸåæœåŠ¡å™¨å¹¶ä¸ç­‰äº 13 å°ç‰©ç†æœåŠ¡å™¨ï¼Œè€Œæ˜¯ä»£è¡¨ç€ 13 ä¸ªå…¨çƒ IP åœ°å€ï¼Œç”± 13 ä¸ªæœºæ„æ¥ç®¡ç†ï¼Œå¯¹åº”æœ‰ä¸åŒçš„åå­—ï¼Œåˆ†åˆ«ä¸º "A" åˆ° "M"ï¼Œå…¶ä¸­ç¾å›½æœ€å¤§ç”µä¿¡è¿è¥å•† Verizon ç®¡ç†ä¸¤ä¸ªæ ¹åŸŸåå…¨çƒ IP åœ°å€ã€‚
> 
> 5. æˆªæ­¢åˆ°ï¼ˆ2019.09ï¼‰ä¸ºæ­¢ï¼Œå…¨çƒä¸€å…±æœ‰ 1011 å°æœåŠ¡å™¨å®ä¾‹éå¸ƒ 5 å¤§æ´² 4 å¤§æ´‹ã€‚

- åŸŸååç¼€ä¸€èˆ¬åˆ†ä¸ºå›½é™…åŸŸåå’Œå›½å†…åŸŸåã€‚

- åŸåˆ™ä¸Šæ¥è®²ï¼ŒåŸŸååç¼€éƒ½æœ‰ä¸¥æ ¼çš„å®šä¹‰ï¼Œä½†åœ¨å®é™…ä½¿ç”¨æ—¶å¯ä»¥ä¸å¿…ä¸¥æ ¼éµå®ˆã€‚

- ç›®å‰æœ€å¸¸è§çš„åŸŸååç¼€ï¼š
  
  - `.com`ï¼šå•†ä¸šç»„ç»‡
  
  - `.org`ï¼šéè¥åˆ©ç»„ç»‡
  
  - `.gov`ï¼šæ”¿åºœéƒ¨é—¨
  
  - `.net`ï¼šç½‘ç»œæœåŠ¡å•†
  
  - `.edu`ï¼šæ•™ç ”æœºæ„
  
  - `.pub`ï¼šå…¬å…±å¤§ä¼—
  
  - `.cn`ï¼šä¸­å›½å›½å®¶é¡¶çº§åŸŸå

### DNS åŸŸåè§£ææœåŠ¡ä¹‹åŒºåŸŸï¼š

- DNS æœåŠ¡å™¨æœ‰ä¸€ä¸ªåŒºåŸŸï¼ˆ`zone`ï¼‰çš„æ¦‚å¿µã€‚

- ç”±äº DNS æœåŠ¡å™¨è¦ä¸ºå…¨çƒçš„ç”¨æˆ·æä¾›æŸ¥è¯¢å’Œæ•°æ®åº“çš„æœåŠ¡ï¼Œå¯¹è®¡ç®—ã€å­˜å‚¨ã€ç½‘ç»œå¸¦å®½éƒ½è¦æ±‚å¾ˆé«˜ï¼Œæ‰€ä»¥å°±å¿…é¡»ç»„ç»‡æˆåŸŸåæœåŠ¡å™¨é›†ç¾¤ï¼Œä½¿å®ƒä»¬ååŒå·¥ä½œï¼Œå…±åŒæä¾›åŸŸåè§£ææœåŠ¡ã€‚

- æ¯ä¸ªé›†ç¾¤å°±è´Ÿè´£ç®¡ç†ç›¸åº”çš„åŸŸååå­—ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªé›†ç¾¤è´Ÿè´£ä¸åŒçš„ DNS åŒºåŸŸã€‚

- å¦‚ï¼Œæ¯ä¸ªæ ¹åŸŸåæœåŠ¡å™¨èŠ‚ç‚¹æŒ‡å‘çš„ä¸‹ä¸€çº§å°±æ˜¯å…¶ç®¡ç†çš„ DNS åŒºåŸŸï¼ŒåŒæ ·å†å¾€ä¸‹ï¼Œcn é¡¶çº§åŸŸåæœåŠ¡å™¨èŠ‚ç‚¹ä¸‹é¢å°±ç®¡ç†ä¸­å›½åŒºçš„ DNS åŒºåŸŸã€‚

- é€šè¿‡è¿™ç§åŒºåŸŸç®¡ç†çš„æ–¹æ³•ï¼Œå°±å¾ˆå®¹æ˜“è¿›è¡Œ DNS æŸ¥è¯¢ã€‚

- æ¯ä¸€çº§çš„ DNS åŒºåŸŸåŸŸåæœåŠ¡å™¨ä¼šä¿å­˜ä¸‹ä¸€çº§çš„ DNS åŒºåŸŸåŸŸåæœåŠ¡å™¨çš„ä¿¡æ¯ï¼Œå¦‚æœä»æ ¹åŸŸåæœåŠ¡å™¨å‡ºå‘ï¼Œä¸€çº§çº§çš„å¾€ä¸‹æŸ¥æ‰¾ï¼Œå°±å¯ä»¥å¾—åˆ°ç›®æ ‡åŸŸåå¯¹åº”çš„ IP ä¿¡æ¯ã€‚

- ä¸¥æ ¼æ¥è¯´å…·æœ‰ä¸‰ç§ DNS æœåŠ¡å™¨è§’è‰²ä¸å®¹å¿½è§†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
  
  - æœ¬åœ° DNS æœåŠ¡å™¨ï¼š
    
    - ç‰¹æŒ‡å†…ç½‘çš„ DNS æœåŠ¡å™¨ï¼Œæä¾›å†…ç½‘ä¸»æœºä¹‹é—´çš„åŸŸåæŸ¥è¯¢æœåŠ¡ï¼Œä¸€èˆ¬ä½œä¸ºç¼“å­˜/è½¬å‘ä¹‹ç”¨ï¼Œå½“åœ¨è¯¥æœåŠ¡å™¨ä¸Šæ‰¾ä¸åˆ°ç›¸åº”åŸŸåæ—¶ï¼Œå®ƒä¼šå°†è¯·æ±‚è½¬å‘åˆ°ä¸Šçº§ DNS æœåŠ¡å™¨ä½œè¿›ä¸€æ­¥æŸ¥è¯¢ã€‚
    
    - å®ƒä¾èµ–äºä¸¤ä¸ªæ–‡ä»¶ï¼Œä»¥ Linux ä¸ºä¾‹ï¼Œå³ `/etc/hosts`Â ä¸Â `/etc/resolv.conf`ã€‚å‰è€…è®°å½•äº†å†…ç½‘ä¸»æœº hostname å’Œ IP ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼ˆé™æ€è§£æï¼‰ï¼Œåè€…è®°å½•äº†å¤–ç½‘çš„DNS æœåŠ¡å™¨åœ°å€ï¼ˆåŠ¨æ€è§£æï¼‰ã€‚å½“æœ¬åœ° DNS æœåŠ¡å™¨åœ¨ /etc/hosts å’Œè‡ªèº«çš„ç¼“å­˜ä¸­éƒ½æ‰¾ä¸åˆ°ç›¸åº”çš„åŸŸåæ—¶ï¼Œå°±ä¼šä» /etc/resolv.conf ä¸­è®°å½•çš„åœ°å€è¿›è¡Œè¿›ä¸€æ­¥æŸ¥è¯¢ã€‚
  
  - ISP DNS æœåŠ¡å™¨ï¼ˆInternet Service Provider, `ISP`ï¼‰ï¼š
    
    - è‹¥è®¡ç®—æœºç›´è¿è¿è¥å•†ï¼ˆISPï¼‰çš„ç½‘ç»œï¼Œåˆ™å¤–ç½‘ DNS æœåŠ¡å™¨å°±æ˜¯æŒ‡ ISP DNS æœåŠ¡å™¨ã€‚
    
    - ISP DNS æœåŠ¡å™¨æ¯”æœ¬åœ° DNS æœåŠ¡å™¨å¤šäº†é€’å½’å’Œè¿­ä»£å‘å„åˆ†çº§ DNS æœåŠ¡å™¨æŸ¥è¯¢çš„åŠŸèƒ½ã€‚
  
  - å…¬å…± DNS æœåŠ¡å™¨ï¼š
    
    - è‹¥ä¸æƒ³é€šè¿‡ ISP çš„ DNS æœåŠ¡å™¨æŸ¥è¯¢ï¼Œä¹Ÿå¯å‘å…¬å…±çš„ DNS æœåŠ¡å™¨å»æŸ¥è¯¢ã€‚
    
    - ç°åœ¨æœ‰å¾ˆå¤šå…¬å…±çš„ DNS æœåŠ¡å™¨ï¼Œéƒ¨åˆ†å¦‚ä¸‹æ‰€ç¤ºï¼š
      
      ```bash
      ### Google æä¾›çš„å…¬å…± DNSï¼š
      8.8.8.8  # ä¸»
      8.8.8.4  # å¤‡
      
      ### å›½å†…ä¸‰å¤§è¿è¥å•†æä¾›çš„å…¬å…± DNSï¼š
      114.114.114.114
      114.114.115.115
      
      ### é˜¿é‡Œæä¾›çš„å…¬å…± DNSï¼š
      223.5.5.5
      223.6.6.6
      
      ### ç™¾åº¦æä¾›çš„å…¬å…± DNSï¼š
      180.76.76.76
      ```

### DNS æŸ¥è¯¢æµç¨‹ï¼š

- DNS æŸ¥è¯¢çš„ä¸¤ç§æ–¹å¼ï¼š
  
  - 1ï¸âƒ£ é€’å½’æŸ¥è¯¢ï¼ˆ`recursive query`ï¼‰ï¼š
    
    - å®¢æˆ·ç«¯é¦–å…ˆåœ¨ /etc/hosts é™æ€æ–‡ä»¶ã€æœ¬åœ° DNS ç¼“å­˜ä¸­æŸ¥æ‰¾ç›®æ ‡ä¸»æœºçš„ IP åœ°å€ã€‚
    
    - å®¢æˆ·ç«¯ä¸æœ¬åœ° DNS æœåŠ¡å™¨é—´ä¸ºé€’å½’æŸ¥è¯¢ã€‚
    
    - é€’å½’æŸ¥è¯¢éœ€é€å±‚æŸ¥è¯¢ç›´æ¥è¿”å›ç»“æœï¼Œè€Œä¸ä½¿ç”¨æŸ¥è¯¢æç¤ºã€‚
    
    - æŸ¥è¯¢è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š
      
      ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dns-recursive-query.jpg)
  
  - 2ï¸âƒ£ è¿­ä»£æŸ¥è¯¢ï¼ˆ`iterative query`ï¼‰ï¼š
    
    - æœ¬åœ° DNS æœåŠ¡å™¨åœ¨æ”¶åˆ°å®¢æˆ·ç«¯å‘èµ·çš„è¯·æ±‚æ—¶ï¼Œå¹¶ä¸ç›´æ¥è¿”å›æŸ¥è¯¢ç»“æœï¼Œè€Œæ˜¯å‘å¦ä¸€å° DNS æœåŠ¡å™¨å‘èµ·è¯·æ±‚ï¼Œä»¥è·å–æŸ¥è¯¢æç¤ºã€‚
    
    - æŸ¥è¯¢è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š
      
      ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dns-iterative-query.jpg)

- å®é™…ä¸­ï¼Œç”±äºæ ¹åŸŸåæœåŠ¡å™¨å’Œå…¶ä»–çš„ TLD æœåŠ¡å™¨çš„èµ„æºå®è´µï¼Œéœ€è¦ä¸ºå…¨çƒçš„ç”¨æˆ·æä¾› DNS è§£ææœåŠ¡ï¼Œå› æ­¤å…¶ä¸æ‰§è¡Œé€’å½’æŸ¥è¯¢ï¼Œæ‰§è¡Œ DNS é€’å½’æŸ¥è¯¢ä¼šå¯¼è‡´å…¨çƒäº’è”ç½‘æ€§èƒ½ä¸ä½³ã€‚è€Œä¸”é€’å½’æŸ¥è¯¢éœ€è¦é€å±‚æŸ¥è¯¢æ‰èƒ½è·å¾—æŸ¥è¯¢ç»“æœï¼Œå½“æŸ¥è¯¢å…·æœ‰è®¸å¤šå±‚æ¬¡çš„ DNS ç»“æ„æ—¶æ•ˆç‡å¾ˆä½ã€‚

- ğŸš€ å®é™…åº”ç”¨ä¸­è¿™ä¸¤ç§æŸ¥è¯¢æ–¹å¼ä¸€èµ·ä½¿ç”¨ï¼Œæœ¬åœ° DNS æœåŠ¡å™¨å’Œ ISP DNS æœåŠ¡å™¨å¯ä»¥æ‰§è¡Œé€’å½’æŸ¥è¯¢ï¼Œè€Œå…¶ä»–å±‚çº§ DNS æœåŠ¡å™¨æ‰§è¡Œè¿­ä»£æŸ¥è¯¢ã€‚

- ğŸ±â€ğŸ DNS æŸ¥è¯¢çš„å®Œæ•´ç¤ºæ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
  
  ä»¥ä¸‹ 3 ä¸ªå›¾ä¾‹å‡ç»“åˆ DNS é€’å½’ä¸è¿­ä»£æŸ¥è¯¢ä»¥å®Œæˆ DNS æŸ¥è¯¢çš„å®Œæ•´è¿‡ç¨‹
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dns-query-progress-1.jpg)
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dns-query-progress-2.jpg)
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dns-query-progress-3.jpg)

### DNS èµ„æºè®°å½•ï¼š

- DNS èµ„æºè®°å½•çš„ç±»å‹ï¼š
  
  - `IN` èµ„æºè®°å½•ï¼šç½‘ç»œè®°å½•
  
  - <font color=red>**SOA**</font> èµ„æºè®°å½•ï¼ˆStart of Authority Recordï¼‰ï¼š
    
    - æˆæƒèµ·å§‹æœºæ„è®°å½•ï¼Œç”¨äºåœ¨åŒºåŸŸçš„å¤šä¸ª NS è®°å½•ä¸­åŒºåˆ†å“ªä¸€å°ä¸ºä¸» DNS æœåŠ¡å™¨ã€‚
    
    - ğŸ’¥ æ¯ä¸ªåŒºåŸŸå¿…é¡»æ­£å¥½æœ‰ 1 ä¸ª SOA è®°å½•ã€‚
      
      ```bash
      example.com.    86400    IN    SOA    classroom.example.com.  root.classroom.example.com. 2015071700 3600 300 604800 60
      ```
  
  - <font color=red>**NS**</font> èµ„æºè®°å½•ï¼ˆName Server Recordï¼‰ï¼š
    
    - åç§°æœåŠ¡å™¨è®°å½•ï¼Œç”¨äºå°†å­åŸŸåæ˜ å°„åˆ°å¯¹å…¶ DNS åŒºåŸŸå…·æœ‰æƒå¨çš„ DNS åç§°æœåŠ¡å™¨ã€‚
    
    - åŒºåŸŸçš„æ¯ä¸ªå…¬å¼€æƒå¨åç§°æœåŠ¡å™¨å¿…é¡»å…·æœ‰ NS è®°å½•ã€‚
    
    - ğŸ’¥ NS è®°å½•æ˜ å°„åˆ°å¿…é¡»å…·æœ‰ A å’Œ/æˆ– AAAA è®°å½•çš„åç§°ã€‚
      
      ```bash
      example.com.                       86400   IN  NS    classroom.example.com.
      168.192.ip-addr.arpa.              86400   IN  NS    classroom.example.com.
      9.0.e.1.4.8.4.6.2.e.d.f.ip6.arpa.  86400   IN  NS    classroom.example.com.
      ```
  
  - <font color=red>**SRV**</font> èµ„æºè®°å½•ï¼š
    
    - æœåŠ¡èµ„æºè®°å½•ï¼ŒæŒ‡å®šæŸåŸŸåæ‰€æä¾›çš„ç‰¹å®šæœåŠ¡ï¼Œå¸®åŠ©å®¢æˆ·ç«¯æŸ¥æ‰¾æ”¯æŒåŸŸçš„ç‰¹å®šæœåŠ¡çš„ä¸»æœºã€‚
    
    - æ ¼å¼ï¼š`<service_name>.<protocol_type>.<domain_name>`
    
    - ç¤ºä¾‹ï¼š`_ldap._tcp.example.com. 86400 IN SRV 0 100 389 server0.example.com.`
      
      è¯¥ SRV è®°å½•è¡¨ç¤ºä¸€ä¸ªå¯ä»¥ä½¿ç”¨ TCP ä¼ è¾“åè®®ï¼ˆ_tcpï¼‰è¿›è¡Œè”ç³»çš„ LDAP æœåŠ¡å™¨ï¼ˆ_ldapï¼‰ï¼Œè¯¥æœåŠ¡å™¨å±äº example.com åŸŸã€‚è¯¥æœåŠ¡å™¨ä¸º server0.example.comï¼Œæ­£åœ¨ä¾¦å¬ 389 ç«¯å£ï¼Œå…¶ä¼˜å…ˆçº§ä¸º 0ï¼Œæƒé‡ä¸º 100ï¼ˆå½“å®¢æˆ·ç«¯æ”¶åˆ°å¤šä¸ª SRV è®°å½•æ—¶ï¼Œå®ƒç”¨äºæ§åˆ¶é€‰å–å“ªä¸€ä¸ªæœåŠ¡å™¨ï¼‰ã€‚
    
    - ğŸ”¥ Kubernetes ä¸ OpenShift ä¸­ service çš„æœåŠ¡å‘ç°é‡‡ç”¨ `SRV` è®°å½•å®ç°ã€‚ä»¥ä¸‹ç¤ºä¾‹ä¸º Kubernetes é›†ç¾¤ codeready-workspace å‘½åç©ºé—´å†…çš„ pod é€šè¿‡ä¸Šæ¸¸ DNS æœåŠ¡å™¨è·å¾— service çš„ SRV è®°å½•çš„è¯·æ±‚æŸ¥è¯¢ã€‚
      
      ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/k8s-pod-dns-resolv-1.png)
      
      ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/k8s-pod-dns-resolv-2.png)
  
  - `A` ä¸ `AAAA` èµ„æºè®°å½•ï¼ˆAddress Recordï¼‰ï¼š
    
    - A è®°å½•ï¼šæä¾›ä¸»æœºååˆ° IPv4 åœ°å€çš„æ˜ å°„
    
    - AAAA è®°å½•ï¼šä¹Ÿç§°ä¸º "å›› A" è®°å½•ï¼Œæä¾›ä¸»æœºååˆ° IPv6 åœ°å€çš„æ˜ å°„ã€‚
      
      ```bash
      host.example.com.       86400   IN      A       172.25.254.254
      a.root-servers.net.     604800  IN      AAAA    2001:503:ba3e::2:30
      ```
  
  - <font color=red>**CNAME**</font> èµ„æºè®°å½•ï¼ˆCanonical Name Recordï¼‰ï¼š
    
    - æƒå¨åç§°è®°å½•ï¼Œå…è®¸ä¸ºä¸»æœºååˆ›å»ºåˆ«åã€‚
    
    - å¸¸ç”¨äºåŸŸåçš„å†…éƒ¨è·³è½¬ï¼Œä¸ºæœåŠ¡å™¨é…ç½®æä¾›çµæ´»æ€§ï¼Œç”¨æˆ·æ„ŸçŸ¥ä¸åˆ°ã€‚
    
    - ç¤ºä¾‹ï¼šç”¨æˆ·è®¿é—® `www.baidu.com` æ—¶ï¼Œå®é™…è¿”å›çš„æ˜¯ `www.a.shifen.com` çš„ IP åœ°å€
    
    - å¯¹å†…éƒ¨åŸŸåä¸ IP çš„å˜æ›´å¸¦æ¥æå¤§çš„ä¾¿åˆ©
      
      ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dns-cname-1.png)
      
      ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dns-cname-2.png)
    
    - ğŸ’¥ CNAME èµ„æºè®°å½•å¿…é¡»æœ€ç»ˆè§£æä¸ºå…·æœ‰ A å’Œ/æˆ– AAAA çš„è®°å½•çš„åç§°ã€‚
    
    > æ³¨æ„ï¼šåº”é¿å…å°† CNAME è®°å½•æŒ‡å‘å…¶ä»– CNAME è®°å½•ï¼ˆCNAME å¾ªç¯ï¼‰ã€‚
  
  - `MX` èµ„æºè®°å½•ï¼ˆMail Exchange Recordï¼‰ï¼š
    
    é‚®ä»¶äº¤æ¢è®°å½•ï¼Œå°†åŸŸåæ˜ å°„åˆ°æ¥å—è¯¥åŸŸçš„é‚®ç®±æœåŠ¡å™¨åŸŸåã€‚
    
    ```textile
    example.com.            86400   IN      MX      10 classroom.example.com.
    example.com.            86400   IN      MX      10 mail.example.com.
    example.com.            86400   IN      MX      100 mailbackup.example.com.
    ```
  
  - `PTR` èµ„æºè®°å½•ï¼ˆPointer Recordï¼‰ï¼š
    
    æŒ‡é’ˆè®°å½•ï¼Œæä¾› IPv4 æˆ– IPv6 åœ°å€åˆ°ä¸»æœºåçš„æ˜ å°„ï¼Œå¸¸ç”¨äºåå‘ DNS è§£æã€‚
    
    ```textile
    4.0.41.198.in-addr.arpa. 785    IN      PTR     a.root-servers.net.
    0.3.0.0.2.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.e.3.a.b.3.0.5.0.1.0.0.2.ip6.arpa. 86400 IN  PTR a.root-servers.net.
    ```
  
  - `TXT` èµ„æºè®°å½•ï¼ˆTXT Recordï¼‰ï¼š
    
    - å°†åç§°æ˜ å°„åˆ°ç¼–ç ä¸ºå¯æ‰“å° `ASCII` å­—ç¬¦çš„ä»»æ„æ–‡æœ¬ã€‚å®ƒä»¬é€šå¸¸ç”¨äºæä¾›å„ç§ç”µå­é‚®ä»¶èº«ä»½éªŒè¯æ–¹æ¡ˆï¼ˆå¦‚ SPFã€DKIM å’Œ DMARC ç­‰ç­‰ï¼‰æ‰€ç”¨çš„æ•°æ®ï¼Œç”¨äºéªŒè¯åŸŸæ‰€æœ‰æƒï¼ˆå¦‚ï¼Œé’ˆå¯¹ Google ä¸ Facebookï¼‰ï¼Œä»¥åŠç”¨äºå…¶ä»–æ‚é¡¹ç”¨é€”ã€‚
    
    - å¯è®°å½•é¢å¤–çš„ä»»ä½•ä¿¡æ¯ï¼Œä¹Ÿå¯ä¸ºç©ºã€‚
      
      ```bash
      lwn.net.   27272   IN  TXT    "google-site-verification: sVlx-LS_z1es5D-fNSUNXrqr3n9Y4F7tOr7HNVMKUGs"
      lwn.net.   27272   IN  TXT    "v=spf1 a:mail.lwn.net  a:prod.lwn.net a:git.lwn.net a:ms.lwn.net -all"
      ```

- ä¸»æœºä¸èµ„æºè®°å½•ï¼š
  
  - æ— è®ºæ˜¯å®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡ç«¯çš„ä¸»æœºéƒ½å°†å…·æœ‰ä»¥ä¸‹ DNS èµ„æºè®°å½•ï¼š
    
    - â¼€ä¸ªæˆ–å¤šä¸ª A å’Œ/æˆ– AAAA IP åœ°å€è®°å½•ã€‚
    
    - â½¤äºå°†å…¶ IP åœ°å€åå‘æ˜ å°„åˆ°åç§°çš„ PTR è®°å½•ã€‚
    
    - ï¼ˆå¯é€‰ï¼‰â¼€ä¸ªæˆ–å¤šä¸ª CNAME è®°å½•ï¼Œâ½¤äºå°†å¤‡â½¤åç§°æ˜ å°„åˆ°å…¶è§„èŒƒä¸»æœºåã€‚
  
  - é™¤äº†åŒºåŸŸä¸­çš„ä¸»æœºçš„è®°å½•ä¹‹å¤–ï¼ŒDNS åŒºåŸŸè¿˜å…·æœ‰ä»¥ä¸‹èµ„æºè®°å½•ï¼š
    
    - æ­£å¥½â¼€ä¸ª SOA è®°å½•ã€‚
    
    - å…¶æ¯ä¸ªæƒå¨åç§°æœåŠ¡å™¨çš„ NS è®°å½•ã€‚
    
    - ï¼ˆå¯é€‰ï¼‰â¼€ä¸ªæˆ–å¤šä¸ª MX è®°å½•ï¼Œâ½¤äºå°†åŸŸåæ˜ å°„åˆ°é‚®ä»¶äº¤æ¢å™¨ï¼Œåè€…æ¥æ”¶ä»¥åŸŸåç»“å°¾çš„åœ°å€çš„ç”µâ¼¦é‚®ä»¶ã€‚
    
    - ï¼ˆå¯é€‰ï¼‰å„ç§åŠŸèƒ½ï¼ˆå¦‚ SPF æˆ– Google ç«™ç‚¹éªŒè¯ï¼‰çš„â¼€ä¸ªæˆ–å¤šä¸ª TXT è®°å½•ã€‚
    
    - ï¼ˆå¯é€‰ï¼‰â½¤äºåœ¨åŸŸä¸­æŸ¥æ‰¾æœåŠ¡çš„â¼€ä¸ªæˆ–å¤šä¸ª SRV è®°å½•ã€‚

### DNS ç¼“å­˜åŠå®ç°ï¼š

- ä¼—æ‰€å‘¨çŸ¥çš„ 80/20 åŸåˆ™ï¼Œå³ç”¨åœ¨ç½‘ç«™è®¿é—®ä¸Š 80% çš„æ—¶é—´æˆ‘ä»¬éƒ½åœ¨çœ‹é‚£äº› 20% çš„ç½‘ç«™ã€‚

- è‹¥å°†å¸¸ç”¨çš„ä¿¡æ¯ç¼“å­˜èµ·æ¥ï¼Œé‚£ä¹ˆåé¢çš„è¯·æ±‚å°†ä¼šå¤§å¤§ç¼©çŸ­è®¿é—®æ—¶é—´ã€‚

- å¯¹äº DNS è¯·æ±‚æ¥è¯´ï¼Œå¦‚æœä¸­é—´çš„å„çº§ DNS æœåŠ¡å™¨éƒ½è®¾æœ‰ç¼“å­˜ï¼Œç¼“å­˜é‚£äº›ç»å¸¸ä¼šç”¨åˆ°çš„åŸŸåä¿¡æ¯ï¼Œé‚£å°†å¤§å¤§æé«˜ DNS çš„è§£ææ•ˆç‡ã€‚

- DNS æŸ¥è¯¢è§£ææ¶‰åŠçš„ DNS ç¼“å­˜ï¼š
  
  - æµè§ˆå™¨ç¼“å­˜ï¼š
    
    å½“ç”¨æˆ·é€šè¿‡æµè§ˆå™¨è®¿é—®æŸåŸŸåæ—¶ï¼Œæµè§ˆå™¨é¦–å…ˆä¼šåœ¨å…¶ç¼“å­˜ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰è¯¥åŸŸåå¯¹åº”çš„ IPã€‚
  
  - ç³»ç»Ÿç¼“å­˜ï¼š
    
    è¯¦è§ä¸‹æ–‡ "Linux ä¸­ DNS ç¼“å­˜ç›¸å…³çš„ç»„ä»¶ä¸æœåŠ¡"ã€‚
  
  - æœ¬åœ° DNS ç¼“å­˜ï¼ˆå¦‚æœæœ‰ï¼‰ï¼š
    
    æ­¤å¤„ç‰¹æŒ‡ç¡¬ä»¶æœåŠ¡å™¨ï¼Œä¸ç³»ç»Ÿç¼“å­˜å¯¹åº”ã€‚
  
  - è·¯ç”±å™¨ router ç¼“å­˜ï¼š
    
    ä¸€èˆ¬ç°åœ¨çš„å‡ºå£è·¯ç”±å™¨ä¹Ÿä¼šè®¾æœ‰ DNS ç¼“å­˜ï¼Œå½“ä»¥ä¸Šéƒ½æŸ¥è¯¢ä¸åˆ°ï¼Œä¼šåœ¨è·¯ç”±å™¨ç¼“å­˜ä¸­æŸ¥è¯¢ã€‚
  
  - ISP DNS ç¼“å­˜ï¼š
    
    ISP ç½‘ç»œæä¾›çš„ DNS æœåŠ¡å™¨ç¼“å­˜ã€‚
  
  - æ ¹åŸŸåï¼ˆrootï¼‰ã€é¡¶çº§åŸŸåï¼ˆTLDï¼‰ã€æ¬¡çº§åŸŸåï¼ˆSLDï¼‰æœåŠ¡å™¨ç­‰ç¼“å­˜ï¼š
    
    å½“å®Œæˆä¸€æ¬¡å®Œæ•´çš„æŸ¥è¯¢ä¹‹åï¼Œä¸­é—´çš„å„ DNS æœåŠ¡å™¨ç¼“å­˜ä¼šå°†è¿”å›çš„ç»“æœä¸€æ¬¡å­˜å…¥è‡ªå·±çš„ç¼“å­˜ä¸­ï¼Œä»¥å¤‡ä¸‹æ¬¡ä½¿ç”¨æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚

- DNS ç¼“å­˜å½“ç„¶èƒ½å¤ŸåŠ å¿« DNS æŸ¥è¯¢çš„æ•ˆç‡ï¼Œä½†æœ‰æ—¶ä¹Ÿä¼šå½±å“ç½‘ç»œé—®é¢˜æ’æŸ¥ã€‚æ­¤æ—¶éœ€å°† DNS ç¼“å­˜æ¸…é™¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
  
  - Windows ç³»ç»Ÿï¼š
    
    ```powershell
    > ipconfig /displaydns
    # æŸ¥çœ‹æœ¬åœ°çš„ DNS ç¼“å­˜ä¿¡æ¯
    ```
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/win-dns-cache-1.jpg)
    
    ```powershell
    > ipconfig /flushdns
    # æ¸…é™¤æœ¬åœ° DNS ç¼“å­˜
    ```
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/win-dns-cache-2.jpg)
  
  - Linux ç³»ç»Ÿï¼š
    
    - è‹¥ä½¿ç”¨ `dnsmasq` ç¼“å­˜æœåŠ¡å™¨ï¼Œé‡å¯è¯¥ç¼“å­˜æœåŠ¡å¯æ¸…é™¤ DNS ç¼“å­˜ã€‚
      
      ```bash
      $ sudo systemctl restart dnsmasq.service
      ```
    
    - è‹¥æœªä½¿ç”¨ï¼Œåˆ™æ ¹æ®å„ Linux å‘è¡Œç‰ˆå„è‡ªçš„ç¼“å­˜æœåŠ¡æ¥æ¸…é™¤ã€‚å¦‚ Ubuntu ä¸­é»˜è®¤ä½¿ç”¨ systemd è§£æçš„æœåŠ¡æ¥ç¼“å­˜ DNS æ¡ç›®ï¼Œå¦‚ä¸‹æ–¹å¼æ¸…é™¤ DNS ç¼“å­˜ï¼š
      
      ```bash
      $Â sudo systemd-resolve --flush-caches
      ```
  
  - å¯¹äº Web æµè§ˆå™¨çš„ DNS ç¼“å­˜ï¼Œå¯åœ¨åœ°å€æ è¾“å…¥ `chrome://net-internals/#dnsChrome`ï¼Œç„¶åå†ç‚¹å‡» `clear host cache`ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ `Ctrl+Shift+Del` æ‰“å¼€æ¸…é™¤æµè§ˆå™¨æ•°æ®çª—å£è¿›è¡Œæ¸…é™¤ã€‚
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/chrome-dns-cache-clear.jpg)

- Linux ä¸­ DNS ç¼“å­˜ç›¸å…³çš„ç»„ä»¶ä¸æœåŠ¡ï¼š
  
  - DNS ç¼“å­˜å¯ä½¿ç”¨ Linux å†…æ ¸æ¨¡å—æˆ–ç¼“å­˜åç§°æœåŠ¡å™¨æ¥å®ç°ï¼Œé€šå¸¸æœ‰ bindã€dnsmasqã€nscdã€unbound ç­‰ã€‚
  
  - ğŸ’ª ç¼“å­˜åç§°æœåŠ¡å™¨åœ¨æœ¬åœ°ç¼“å­˜ä¸­å­˜å‚¨ DNS æŸ¥è¯¢ç»“æœï¼Œå¹¶ä¸”åœ¨ `TTL` åˆ°æœŸåä»ç¼“å­˜ä¸­åˆ é™¤èµ„æºè®°å½•ï¼ŒåŒæ—¶ï¼Œè‹¥å…¶è‡ªèº«ç¼“å­˜ä¸­æ— å¯¹åº”çš„è§£ææ¡ç›®ï¼Œä¹Ÿå¯é€šè¿‡è½¬å‘ï¼ˆ`forward`ï¼‰æ–¹å¼å°† DNS è¯·æ±‚è½¬å‘ç»™ä¸Šæ¸¸ DNS æœåŠ¡å™¨å®Œæˆè§£æåå†ç¼“å­˜è¯¥æ¡ç›®ã€‚é€šå¸¸è®¾ç½®ç¼“å­˜åç§°æœåŠ¡å™¨ä»¥ä»£è¡¨æœ¬åœ°ç½‘ç»œä¸Šçš„å®¢æˆ·ç«¯æ‰§è¡ŒæŸ¥è¯¢ã€‚è¿™é™ä½äº†å…¬ç½‘ä¸Šçš„ DNS æµé‡ï¼Œä»è€Œæé«˜äº† DNS åç§°è§£æçš„æ•ˆç‡ã€‚éšç€ç¼“å­˜çš„å¢åŠ ï¼Œç¼“å­˜åç§°æœåŠ¡å™¨ä»å…¶æœ¬åœ°ç¼“å­˜ä¸­åº”ç­”è¶Šæ¥è¶Šå¤šçš„å®¢æˆ·æŸ¥è¯¢ï¼Œä»è€Œæé«˜ DNS æ€§èƒ½ã€‚
  
  - `dns_resolver` å†…æ ¸æ¨¡å—ï¼š
    
    dns_resolver æ¨¡å—æ˜¯ Linux å†…æ ¸ä¸­ç”¨äºå¤„ç† DNS æŸ¥è¯¢çš„æ¨¡å—ï¼Œå®ƒæä¾›äº†ä¸€ç»„å‡½æ•°ï¼Œç”¨äºå¤„ç† DNS æŸ¥è¯¢çš„è¿‡ç¨‹ï¼ŒåŒ…æ‹¬è§£æ DNS åç§°ã€è¿”å› IP åœ°å€ç­‰ã€‚dns_resolver æ¨¡å—å¯ä»¥ç›´æ¥ç”¨äºå®ç°åŸŸåè§£æåŠŸèƒ½ï¼Œä½†å®ƒå¹¶ä¸æ˜¯ä¸“é—¨ç”¨äºç¼“å­˜ DNS æŸ¥è¯¢ç»“æœçš„å·¥å…·ã€‚å› æ­¤ï¼Œå¦‚æœç³»ç»Ÿéœ€è¦ä½¿ç”¨æœ¬åœ° DNS ç¼“å­˜ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å…¶ä»–å·¥å…·ã€‚
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dns_resolver-module.png)
  
  - ğŸ· `dnsmasq` ç¼“å­˜åç§°æœåŠ¡å™¨ï¼š
    
    å…³äº dnsmasq æœåŠ¡çš„è¯´æ˜å¯å‚è€ƒ [DNSmasq è¯¦ç»†è§£æåŠè¯¦ç»†é…ç½®](https://cloud.tencent.com/developer/article/1174717)ï¼Œæ­¤ç¯‡æ–‡ç« ä¸­è¯´æ˜äº†è¯¥æœåŠ¡å¸¸ç”¨çš„åœºæ™¯ã€‚
  
  - `nscd` ç¼“å­˜åç§°æœåŠ¡å™¨ï¼ˆä¸‹æ–‡è¯¦ç»†ä»‹ç»ï¼‰ï¼š
    
    nscd æ˜¯ä¸€ç§å¸¸ç”¨çš„ç¼“å­˜å·¥å…·ï¼Œå®ƒå¯ä»¥å®ç° DNS æŸ¥è¯¢ç»“æœçš„ç¼“å­˜ã€‚nscd æ˜¯ä¸€ä¸ªé€’å½’çš„ DNS ç¼“å­˜ç³»ç»Ÿï¼Œå¯ä»¥ç¼“å­˜åŸŸåçš„ DNS æŸ¥è¯¢ç»“æœï¼Œå¹¶é˜²æ­¢é‡å¤çš„ DNS æŸ¥è¯¢ã€‚nscd å¯ä»¥ç”¨äºä¼˜åŒ–ç³»ç»Ÿçš„ DNS æŸ¥è¯¢æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦é¢‘ç¹æŸ¥è¯¢åŸŸåçš„æƒ…å†µä¸‹ï¼Œå¦‚ç½‘ç«™ç¼“å­˜æˆ–é‚®ä»¶ç¼“å­˜ç­‰ã€‚åœ¨ä½¿ç”¨ nscd æ—¶ï¼Œéœ€è¦æŒ‡å®š nscd çš„é…ç½®æ–‡ä»¶å’Œç¼“å­˜å¤§å°ç­‰å‚æ•°ï¼Œä»¥é€‚åº”ç³»ç»Ÿçš„éœ€æ±‚ã€‚
  
  - `unbound` ç¼“å­˜åç§°æœåŠ¡å™¨ï¼ˆä¸‹æ–‡è¯¦ç»†ä»‹ç»ï¼‰ï¼š
    
    unbound æ˜¯ä¸€ä¸ªå¼€æºçš„ DNS è§£æå™¨ï¼Œä¹Ÿå¯ä»¥ç”¨äºå®ç°æœ¬åœ° DNS ç¼“å­˜ã€‚unbound å¯ä»¥ç¼“å­˜ DNS æŸ¥è¯¢ç»“æœï¼Œå¹¶æ”¯æŒæ­£å‘è§£æå’Œåå‘è§£æã€‚unbound é€‚ç”¨äºéœ€è¦è§£æå¤§é‡åŸŸåæˆ–éœ€è¦é¢‘ç¹æŸ¥è¯¢åŸŸåçš„æƒ…å†µï¼Œä¾‹å¦‚ç½‘ç«™è§£æã€DNS è½®è¯¢ç­‰ã€‚åœ¨ä½¿ç”¨ unbound æ—¶ï¼Œéœ€è¦æŒ‡å®š unbound çš„é…ç½®æ–‡ä»¶å’Œç¼“å­˜å¤§å°ç­‰å‚æ•°ï¼Œä»¥é€‚åº”ç³»ç»Ÿçš„éœ€æ±‚ã€‚

- nscd ç¼“å­˜åç§°æœåŠ¡å™¨ä½¿ç”¨ç¤ºä¾‹ï¼š
  
  - `nscd`ï¼ˆName Service Cache Daemonï¼‰æ˜¯ä¸€ç§èƒ½å¤Ÿç¼“å­˜ `passwd`ã€`group`ã€`hosts` çš„æœ¬åœ°ç¼“å­˜æœåŠ¡ï¼Œåˆ†åˆ«å¯¹åº”ä¸‰ä¸ªæº `/etc/passwd`ã€`/etc/hosts`ã€`/etc/resolv.conf`ã€‚
  
  - å…¶æœ€ä¸ºæ˜æ˜¾çš„ä½œç”¨æ˜¯åŠ å¿« DNS è§£æé€Ÿåº¦ï¼Œåœ¨æ¥å£è°ƒç”¨é¢‘ç¹çš„å†…ç½‘ç¯å¢ƒå»ºè®®å¼€å¯ã€‚
  
  - å¼€å¯ nscd çš„ hosts ç¼“å­˜æœåŠ¡åï¼Œæ¯æ¬¡å†…éƒ¨æ¥å£è¯·æ±‚ä¸ä¼šéƒ½å‘èµ· DNS è§£æè¯·æ±‚ï¼Œè€Œæ˜¯ç›´æ¥å‘½ä¸­ nscd ç¼“å­˜æ•£åˆ—è¡¨ï¼Œä»è€Œè·å–å¯¹åº”æœåŠ¡å™¨ IP åœ°å€ï¼Œè¿™æ ·å¯åœ¨å¤§é‡å†…éƒ¨æ¥å£è¯·æ±‚æ—¶å‡å°‘æ¥å£çš„å“åº”æ—¶é—´ã€‚
  
  - nscdÂ æœåŠ¡é…ç½®æ–‡ä»¶ï¼š`/etc/nscd.conf`
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/nscd-conf-1.jpg)
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/nscd-conf-2.jpg)
    
    `/var/log/nscd.log`Â æ—¥å¿—æ–‡ä»¶ä¸­çš„ timeout æ¢ç®—ï¼š
    
    ```bash
    $ date --date='@<second>'
    ```
  
  - ğŸ‘‰ å…³äº **`/etc/nsswitch.conf`**Â é…ç½®æ–‡ä»¶çš„è¯´æ˜ï¼šè¯¥æ–‡ä»¶å®šä¹‰ hostsÂ åŸŸåè§£æçš„æŸ¥è¯¢é¡ºåºï¼Œè‹¥ filesï¼ˆ/etc/hostsï¼‰æŸ¥è¯¢å¤±è´¥ï¼Œå°†æŸ¥è¯¢ dnsï¼ˆ/etc/resolv.confï¼‰ã€‚
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/nsswitch-query-sequence-1.jpg)

    è‹¥è¯¥æ–‡ä»¶ä¸­å®šä¹‰çš„æŸ¥è¯¢è·¯å¾„å‡æ— æ³•æˆåŠŸè¿”å›ï¼Œä½†åœ¨ nscd hostsÂ ç¼“å­˜æ•£åˆ—è¡¨ä¸­å­˜åœ¨åŸŸåä¸ IP çš„å¯¹åº”å…³ç³»ï¼ŒæŸ¥è¯¢ä¹Ÿå°†æˆåŠŸè¿”å›ã€‚
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/nsswitch-query-sequence-2.jpg)
    
    ğŸ’¥ /etc/nsswitch.conf é…ç½®æ–‡ä»¶ä¸­å¯¹ DNS è§£æçš„ç±»å‹ä¸é¡ºåºéå¸¸é‡è¦ï¼Œè‹¥é…ç½®é”™è¯¯å°†å¯¼è‡´æ— æ³•è§£æï¼Œå³ä½¿åœ¨é™æ€ä¸åŠ¨æ€è§£ææ–‡ä»¶å‡é…ç½®æ­£ç¡®çš„æƒ…å†µä¸‹ã€‚è¯¥æ–‡ä»¶ä¸­çš„ `hosts` è¡Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    
    ```bash
    hosts:    files  dns  myhostname
    # filesï¼šæœ¬åœ° /etc/hosts ä¸­æŸ¥æ‰¾ä¸»æœºå
    # dnsï¼šå¯æ ¹æ®ç½‘å£é…ç½®æ–‡ä»¶ä¸­çš„å®šä¹‰æˆ– /etc/resolv.conf æ–‡ä»¶ä¸­çš„å®šä¹‰æ‰§è¡Œ DNS æŸ¥æ‰¾
    # myhostnameï¼šè‹¥æŸ¥æ‰¾å¤±è´¥ï¼Œåˆ™ localhost å’Œç³»ç»Ÿçš„ä¸»æœºåçš„ç»“æœåº”ä½¿ç”¨ nss-myhostname (8) è¿›è¡Œè§£æã€‚
    ```

- unbound ç¼“å­˜åç§°æœåŠ¡å™¨ä½¿ç”¨ç¤ºä¾‹ï¼š
  
  - unbound æ˜¯å¼€æºçš„é»˜è®¤å¯ç”¨äº† `DNSSEC` éªŒè¯çš„æ›´å®‰å…¨çš„ç¼“å­˜åç§°æœåŠ¡å™¨ã€‚
  
  - å¸¸ç”¨çš„ unbound æœåŠ¡é…ç½®ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºï¼š
    
    ```bash
    ### unbound æœåŠ¡ç«¯ ###
    $ sudo yum install -y unbound
    # å®‰è£… unbound æœåŠ¡è½¯ä»¶åŒ…
    
    $ sudo vim /etc/unbound/unbound.conf
      ...
      server:
        interface: 172.25.250.10
        # æŒ‡å®šå…·æœ‰ IPv4 åœ°å€çš„ç½‘ç»œæ¥å£åº”ç­” DNS è¯·æ±‚ï¼Œé»˜è®¤ç›‘å¬ localhostï¼ˆ127.0.0.1 ä¸ ::1ï¼‰
        # æŒ‡å®š 0.0.0.0 ä¸ ::0 ä»¥ç»‘å®šæ‰€æœ‰å¯ç”¨çš„æ¥å£
        interface-automatic: no
        # å…³é—­ç½‘ç»œæ¥å£è‡ªåŠ¨é€‰æ‹©
        access-control: 172.25.250.0/24 allow
        # æ§åˆ¶å¯è®¿é—®æœåŠ¡ç«¯çš„å®¢æˆ·ç«¯åŠè®¿é—®æƒé™
        # é»˜è®¤æ‰€æœ‰çš„å®¢æˆ·ç«¯ä¸ºæ‹’ç»è®¿é—®ï¼ˆrefuseï¼‰
        # è®¿é—®æƒé™å¦‚ä¸‹æ‰€ç¤ºï¼š
        #   denyï¼šé˜»æ­¢è®¿é—®ï¼Œä¸”ä¸å‘é€ä»»ä½•å“åº”ã€‚
        #   refuseï¼šé˜»æ­¢è®¿é—®ï¼Œå¹¶å‘å®¢æˆ·ç«¯å‘é€ REFUSED é”™è¯¯ã€‚
        #   allowï¼šå…è®¸é€’å½’è®¿é—®
        #   allow_setrdï¼šå…è®¸é€’å½’è®¿é—®ï¼Œrd bit éœ€å¼ºåˆ¶å¯ç”¨ã€‚
        #   allow_snoopï¼šå…è®¸é€’å½’ä¸éé€’å½’è®¿é—®
        #   deny_non_localï¼šæ‹’ç»æ‰€æœ‰éæœ¬åœ°è§£æåº”ç­”çš„è¯·æ±‚
        #   refuse_non_localï¼šæ‹’ç»æ‰€æœ‰éæœ¬åœ°è§£æåº”ç­”çš„è¯·æ±‚ï¼Œå¹¶å‘å®¢æˆ·ç«¯å‘é€ REFUSED é”™è¯¯ã€‚
        domain-insecure: "example.com"
        # ä¸ºç‰¹å®šæœªç­¾ååŒºåŸŸè·³è¿‡ DNSSEC éªŒè¯
        # æ³¨æ„ï¼š
        #   1. é»˜è®¤æƒ…å†µä¸‹ï¼Œunbound ä¼šæ‰§è¡Œ DNSSEC éªŒè¯ï¼Œä»¥éªŒè¯æ˜¯å¦æ”¶åˆ°äº†æ‰€æœ‰ DNS å“åº”ã€‚
        #      é€šå¸¸å¸Œæœ›æ‰§è¡Œæ­¤æ“ä½œï¼Œä½†æœ‰æ—¶ä¼šæœ‰ä¸€ä¸ªæœªæ­£ç¡®ç­¾åçš„å†…éƒ¨åŸŸï¼Œå› æ­¤æ— æ³•é€šè¿‡ DNSSEC éªŒè¯ã€‚
        #   2. è¯·å‹¿åªæ˜¯ä¸ºäº†è§£å†³æ— æ³•è§£é‡Šçš„ DNS è§£æé—®é¢˜â½½ç¦ç”¨ DNSSEC éªŒè¯ã€‚
        #   3. DNSSEC å¤±è´¥å¯èƒ½è¡¨æ˜å·²æ”¶åˆ°äº†è¢«æ­£ç¡®æ‹’ç»çš„æ¬ºéª—å“åº”ã€‚
      forward-zone:
        name: .
        # è½¬å‘æ‰€æœ‰çš„ DNS æŸ¥è¯¢è¯·æ±‚
        forward-addr: 172.25.250.254
        # è½¬å‘ DNS æŸ¥è¯¢è¯·æ±‚è‡³æŒ‡å®šçš„ä¸»æœºï¼Œè¯¥ä¸»æœºå¯ä»¥æ˜¯å…¶ä»–ç¼“å­˜åç§°æœåŠ¡å™¨ï¼Œä¹Ÿå¯æ˜¯ä¸Šæ¸¸ DNS æœåŠ¡å™¨ã€‚
        # ä¹Ÿå¯ä½¿ç”¨ forward-host å‚æ•°æŒ‡å®šä¸»æœºåŸŸå
      ...
    ```
    
    ```bash
    ### unbound æœåŠ¡ç«¯ ###
    $ sudo unbound-control-setup
    # ç”Ÿæˆ unbound æœåŠ¡ç«¯ç§é’¥ä¸è¯ä¹¦
    $ sudo unbound-checkconf
    # æ£€æŸ¥ /etc/unbound/unbound.conf æ˜¯å¦å­˜åœ¨è¯­æ³•é”™è¯¯
    $ sudo firewall-cmd --permanent --add-service=dns
    $ sudo firewall-cmd --reload
    # å¯ç”¨é˜²ç«å¢™å…è®¸ DNS æµé‡ï¼ˆ53/TCP ä¸ 53/UDPï¼‰
    $ sudo systemctl enable --now unbound.service
    ```
    
    å¯ç”¨ unbound æœåŠ¡åï¼Œåœ¨å®¢æˆ·ç«¯ä½¿ç”¨ dig æˆ– nslookup å‘½ä»¤è¿›è¡Œæµ‹è¯•éªŒè¯æœåŠ¡ç«¯ç¼“å­˜åŠŸèƒ½æ˜¯å¦ç”Ÿæ•ˆï¼Œå¹¶ä¸”æ˜¯å¦å¯è½¬å‘ DNS è¯·æ±‚è‡³ä¸Šæ¸¸ DNS æœåŠ¡å™¨å®Œæˆé€’å½’æŸ¥è¯¢ã€‚
    
    ```bash
    ### unbound å®¢æˆ·ç«¯ ###
    $ dig A serverb.lab.example.com @servera.lab.example.com
    # ä½¿ç”¨ servera èŠ‚ç‚¹ï¼ˆunbound æœåŠ¡ç«¯ï¼‰æŸ¥è¯¢ serverb èŠ‚ç‚¹çš„ A è®°å½•
    ```
    
    ```bash
    ### unbound æœåŠ¡ç«¯ ###
    $ sudo unbound-control dump_cache
      START_RRSET_CACHE
      ;rrset 64696 1 0 7 3
      lab.example.com.        64696   IN      NS      bastion.lab.example.com.
      ;rrset 596 1 0 8 3
      serverb.lab.example.com.        596     IN      A       172.25.250.11
      ;rrset 596 1 0 3 3
      bastion.lab.example.com.        596     IN      A       172.25.250.254
      END_RRSET_CACHE
      START_MSG_CACHE
      msg serverb.lab.example.com. IN A 33152 1 596 3 1 1 1
      serverb.lab.example.com. IN A 0
      lab.example.com. IN NS 0
      bastion.lab.example.com. IN A 0
      END_MSG_CACHE
      EOF
    # å®¢æˆ·ç«¯æŸ¥è¯¢è¯·æ±‚åœ¨æœ¬åœ°æœåŠ¡ç«¯ä¸­çš„ç¼“å­˜ä¿¡æ¯
    # å¦‚ä¸Šæ‰€ç¤ºï¼Œç¼“å­˜åç§°æœåŠ¡å™¨å°† DNS è¯·æ±‚è½¬å‘è‡³ä¸Šæ¸¸ DNS æœåŠ¡å™¨ bastion èŠ‚ç‚¹
    ```
  
  - unbound æœåŠ¡ç«¯å¯¹ç¼“å­˜çš„å¯¼å…¥ä¸å¯¼å‡ºï¼š
    
    ```bash
    $ sudo unbound-control dump_cache > /path/to/file
    # å°†åç§°è§£æç¼“å­˜é‡å®šå‘è‡³æŒ‡å®šæ–‡ä»¶ï¼ˆé»˜è®¤ä¸ºæ ‡å‡†è¾“å‡ºï¼‰
    $ sudo unbound-control load_cache < /path/to/file
    # å°†æŒ‡å®šæ–‡ä»¶ä¸­çš„ç¼“å­˜ä¿¡æ¯å¯¼å…¥è‡³ç¼“å­˜åç§°æœåŠ¡å™¨ä¸­
    ```

- unbound æœåŠ¡ç«¯å¯¹ç¼“å­˜çš„æ¸…é™¤ï¼š
  
  ç®¡ç†å‘˜éœ€è¦å®šæœŸä»ç¼“å­˜ä¸­æ¸…é™¤è¿‡æœŸçš„èµ„æºè®°å½•ã€‚åœ¨èµ„æºè®°å½•ä¸Šçš„ `TTL` åˆ°æœŸä¹‹å‰ï¼Œç¼“å­˜ä¸­çš„é”™è¯¯å’Œè¿‡æœŸèµ„æºè®°å½•å°†é˜»æ­¢å·²æ›´æ­£çš„å¯¹åº”èµ„æºè®°å½•ä¾›å®¢æˆ·ç«¯ä½¿ç”¨ã€‚æ­¤æ—¶ï¼Œéœ€æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¼ºåˆ¶æ¸…é™¤è¿‡æœŸè®°å½•ï¼Œè€Œä¸å¿…ç­‰å¾… `TTL` è¿‡æœŸï¼š
  
  ```bash
  $ sudo unbound-control flush <fqdn>
  $ sudo unbound-control flush serverb.lab.example.com
  # æ¸…é™¤æŒ‡å®šèµ„æºè®°å½•çš„ç¼“å­˜
  
  $ sudo unbound-control flush_zone <zone_name>
  $ sudo unbound-control flush_zone lab.example.com
  # æ¸…é™¤æŒ‡å®š zone çš„æ‰€æœ‰èµ„æºè®°å½•
  ```

### DNS åŸŸåæœåŠ¡å™¨ç±»å‹ï¼š

- DNS æŠ€æœ¯å¯æä¾›ä¸‹é¢ä¸‰ç§ç±»å‹çš„æœåŠ¡å™¨ï¼š
  
  - ä¸»æœåŠ¡å™¨ï¼ˆmasterï¼‰ï¼š
    
    åœ¨ç‰¹å®šåŒºåŸŸå†…å…·æœ‰å”¯ä¸€æ€§ï¼Œè´Ÿè´£ç»´æŠ¤è¯¥åŒºåŸŸå†…çš„åŸŸåä¸ IP åœ°å€ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚
  
  - ä»æœåŠ¡å™¨ï¼ˆslaveï¼‰ï¼š
    
    ä»ä¸»æœåŠ¡å™¨ä¸­è·å¾—åŸŸåä¸ IP åœ°å€çš„å¯¹åº”å…³ç³»å¹¶è¿›è¡Œç»´æŠ¤ï¼Œä»¥é˜²ä¸»æœåŠ¡å™¨å®•æœºç­‰æƒ…å†µã€‚
  
  - ç¼“å­˜æœåŠ¡å™¨ï¼ˆcacheï¼‰ï¼š
    
    é€šè¿‡å‘å…¶ä»–åŸŸåè§£ææœåŠ¡å™¨æŸ¥è¯¢è·å¾—åŸŸåä¸ IP åœ°å€çš„å¯¹åº”å…³ç³»ï¼Œå¹¶å°†ç»å¸¸æŸ¥è¯¢çš„åŸŸåä¿¡æ¯ä¿å­˜åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼Œä»¥æ­¤æ¥æé«˜é‡å¤æŸ¥è¯¢æ—¶çš„æ•ˆç‡ã€‚

- ä¸»æœåŠ¡å™¨æ˜¯ç”¨äºç®¡ç†åŸŸåå’Œ IP åœ°å€å¯¹åº”å…³ç³»çš„çœŸæ­£æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨ååŠ©ä¸»æœåŠ¡å™¨ï¼Œå¯åˆ†æ•£éƒ¨ç½²åœ¨å„ä¸ªå›½å®¶ã€çœå¸‚æˆ–åœ°åŒºï¼Œä»¥ä¾¿è®©ç”¨æˆ·å°±è¿‘æŸ¥è¯¢åŸŸåï¼Œä»è€Œå‡è½»ä¸»æœåŠ¡å™¨çš„è´Ÿè½½å‹åŠ›ã€‚

- ç¼“å­˜æœåŠ¡å™¨ä¸å¤ªå¸¸ç”¨ï¼Œä¸€èˆ¬éƒ¨ç½²åœ¨ä¼ä¸šå†…ç½‘çš„ç½‘å…³ä½ç½®ï¼Œç”¨äºåŠ é€Ÿç”¨æˆ·çš„åŸŸåæŸ¥è¯¢è¯·æ±‚ã€‚

- ğŸ¤˜ ç›®å‰å¯å®ç° DNS æœåŠ¡çš„å¸¸ç”¨ç»„ä»¶ï¼š`Bind`ã€`DNSmasq`ã€`CoreDNS`

### BIND DNS å®ç°æƒå¨åŸŸåè§£ææœåŠ¡ï¼š

> ä»¥ä¸‹æ¶‰åŠçš„é…ç½®æ–‡ä»¶å¯ç‚¹å‡» [sc-col/bind9-master-dns](https://github.com/Alberthua-Perl/sc-col/tree/master/bind9-master-dns)ã€[sc-col/bind9-slave-dns](https://github.com/Alberthua-Perl/sc-col/tree/master/bind9-slave-dns) ä»¥è·å–ã€‚

- `BIND`ï¼ˆBerkeley Internet Name Domainï¼Œä¼¯å…‹åˆ©å› ç‰¹ç½‘åç§°åŸŸï¼‰æœåŠ¡æ˜¯å…¨çƒèŒƒå›´å†…ä½¿ç”¨æœ€å¹¿æ³›ã€æœ€å®‰å…¨å¯é ä¸”é«˜æ•ˆçš„åŸŸåè§£ææœåŠ¡ã€‚

- BIND å¯ä»¥é…ç½®ä¸ºä¸»ï¼ˆmasterï¼‰æˆ–ä»ï¼ˆslaveï¼‰ï¼Œä»¥æœåŠ¡äºæ¯ä¸ªåŒºåŸŸçš„ DNS è¯·æ±‚ï¼Œé¦–å…ˆéœ€é…ç½®ä¸» DNS æƒå¨æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨å°†ä½œä¸ºä» DNS æƒå¨æœåŠ¡å™¨çš„æºã€‚

- å½“ BIND é…ç½®ä¸ºä»æ—¶ï¼Œå®ƒä½¿ç”¨åŒºåŸŸä¼ è¾“æ–¹æ³•ä»ä¸»æœåŠ¡å™¨è·å–åŒºåŸŸæ•°æ®çš„å‰¯æœ¬ã€‚

- DNS åŸŸåè§£ææœåŠ¡å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®‰è£…éƒ¨ç½²æ—¶åŠ ä¸Š `chroot`ï¼ˆä¿—ç§°ç‰¢ç¬¼æœºåˆ¶ï¼‰æ‰©å±•åŒ…ï¼Œä»¥ä¾¿æœ‰æ•ˆåœ°é™åˆ¶ bind æœåŠ¡ä»…èƒ½å¯¹è‡ªèº«çš„é…ç½®æ–‡ä»¶è¿›è¡Œæ“ä½œï¼Œä»¥ç¡®ä¿æ•´ä¸ªæœåŠ¡å™¨çš„å®‰å…¨ã€‚

- bindÂ æœåŠ¡å®‰è£…ä¸é…ç½®ï¼š
  
  - å„æœåŠ¡å™¨èŠ‚ç‚¹è§’è‰²åˆ†å¸ƒï¼š
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/named-service-nodes.jpg)
  
  - å„æœåŠ¡å™¨èŠ‚ç‚¹ç‰©ç†æ‹“æ‰‘ç¤ºæ„ï¼š
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/named-service-arch.jpg)
    
    å¹¶éæ‰€æœ‰ DNS æƒå¨æœåŠ¡å™¨éƒ½å¿…é¡»æ˜¯å…¬å…±æœåŠ¡å™¨ã€‚å¦‚ï¼Œå¯èƒ½å†³å®šä»…ä½¿ç”¨ä¸» DNS æƒå¨æœåŠ¡å™¨æ¥ç®¡ç†åŒºåŸŸæ–‡ä»¶ï¼Œå¹¶å°†åŒºåŸŸä¿¡æ¯å‘å¸ƒåˆ°ä» DNS æƒå¨æœåŠ¡å™¨ã€‚ä¸»æœåŠ¡å™¨å¯ä»¥æ˜¯ç§æœ‰æœåŠ¡å™¨ï¼Œä½†ä»æœåŠ¡å™¨å°†æ˜¯é¢å‘å…¬å…±çš„ï¼Œä¸ºå¤–éƒ¨å®¢æˆ·ç«¯æä¾›æƒå¨åº”ç­”ã€‚è¿™å¯ä¿æŠ¤ä¸»æœåŠ¡å™¨å…å—æ”»å‡»ã€‚
    
    âœ¨ æ­¤æ¶æ„ä¸­ä»…ä½¿ç”¨ä¸»æœåŠ¡å™¨ä¸ä»æœåŠ¡å™¨ï¼Œæœªéƒ¨ç½²ç¼“å­˜åŸŸåæœåŠ¡å™¨ã€‚è‹¥ä½¿ç”¨ç¼“å­˜åŸŸåæœåŠ¡å™¨å¯å°†å…¶éƒ¨ç½²äºå®¢æˆ·ç«¯ä¸ä» DNS æƒå¨æœåŠ¡å™¨ä¹‹é—´ï¼Œå®ƒä¸€æ–¹é¢ç¼“å­˜å®¢æˆ·ç«¯çš„æŸ¥è¯¢è§£ææ¡ç›®ï¼Œå¦ä¸€æ–¹é¢å¯å°†æ¥è‡ªå®¢æˆ·ç«¯çš„ DNS æŸ¥è¯¢è¯·æ±‚è½¬å‘è‡³ä»æœåŠ¡å™¨ä¸Šã€‚å¯å‚è€ƒå¦‚ä¸‹åˆ†å¸ƒï¼š
    
    `client -> unbound-cache-nameserver -> slave-nameserver <-> master-nameserver`

- **ä¸» DNS æƒå¨æœåŠ¡å™¨éƒ¨ç½²ï¼š**
  
  1ï¸âƒ£ å®‰è£… bind ä¸ç›¸å…³è½¯ä»¶åŒ…ï¼š
  
  ```bash
  $ sudo yum install -y bind bind-utils
  ```
  
  RHEL 8 ä¸­çš„ bind è½¯ä»¶åŒ…é»˜è®¤å°†æœåŠ¡é…ç½®ä¸ºåŸºæœ¬çš„é€’å½’ç¼“å­˜åç§°æœåŠ¡å™¨ï¼Œå®ƒä¹Ÿè¢«é…ç½®ä¸º localhost ä»¥åŠç›¸å…³åŸŸå’Œåœ°å€çš„ä¸»æœåŠ¡å™¨ï¼Œä»¥ä» root åç§°æœåŠ¡å™¨å¸é™¤è´Ÿè½½ã€‚æ­¤é»˜è®¤é…ç½®è¿˜å°†è®¿é—®æƒé™ä»…é™äºæœ¬åœ°ä¸»æœºä¸Šçš„ç¨‹åºã€‚å®ƒä¾¦å¬ IPv4 å’Œ IPv6 ç¯å›æ¥å£ `127.0.0.1` å’Œ `::1` çš„ `53 UDP/TCP` ç«¯å£ä¸Šçš„è¿æ¥ã€‚
  
  2ï¸âƒ£ bind æœåŠ¡ç¨‹åºä¸­ä¸‰ä¸ªå…³é”®æ–‡ä»¶ï¼š
  
  - `/etc/named.conf` ä¸»é…ç½®æ–‡ä»¶ï¼š
    
    åŒ…å« `options`Â æ®µã€`logging`Â æ®µã€`zone`Â æ®µã€`include`Â æŒ‡ä»¤ï¼Œè¿˜å¯åŒ…å«å¯é€‰çš„ `view` æ®µã€‚Â 
  
  - `/etc/named.rfc1912.zones` åŒºåŸŸé…ç½®æ–‡ä»¶ï¼š
    
    - æ­£/åè§£è®°å½•æ¸…å•æ–‡ä»¶
    
    - å®šä¹‰äº†åŸŸåä¸ IP åœ°å€è§£æè§„åˆ™ä¿å­˜çš„æ–‡ä»¶ä½ç½®ä»¥åŠæœåŠ¡ç±»å‹ç­‰å†…å®¹ï¼Œè€Œæ²¡æœ‰åŒ…å«å…·ä½“çš„åŸŸåã€IP åœ°å€å¯¹åº”å…³ç³»ç­‰ä¿¡æ¯ã€‚
    
    - type ç±»å‹æœ‰ä¸‰ç§ï¼š`hint`ï¼ˆæ ¹åŒºåŸŸï¼‰ã€`master`ï¼ˆä¸»åŒºåŸŸï¼‰ã€`slave`ï¼ˆä»åŒºåŸŸï¼‰
    
    - å…¶ä¸­å¸¸ç”¨çš„ master å’Œ slave æŒ‡çš„å°±æ˜¯ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨ã€‚
    
    - å¯å°†è‡ªå®šä¹‰çš„ zoneÂ åŒºåŸŸæ·»åŠ åˆ°åŒºåŸŸé…ç½®æ–‡ä»¶çš„æœ€ä¸‹é¢ï¼Œä¹Ÿå¯å°†è¯¥æ–‡ä»¶ä¸­çš„åŸæœ‰ä¿¡æ¯å…¨éƒ¨æ¸…ç©ºï¼Œè€Œåªä¿ç•™è‡ªå·±çš„åŸŸåè§£æä¿¡æ¯ã€‚Â 
  
  - `/var/named/` ç›®å½•ï¼š
    
    - æ•°æ®é…ç½®æ–‡ä»¶ç›®å½•ï¼ˆæ­£/åè§£è®°å½•æ–‡ä»¶ï¼‰
    
    - è¯¥ç›®å½•ç”¨æ¥ä¿å­˜åŸŸåå’Œ IP åœ°å€çœŸå®å¯¹åº”å…³ç³»çš„æ•°æ®é…ç½®æ–‡ä»¶
    
    - /var/named/named.caÂ ä¿å­˜å…¨çƒ 13 ç»„æ ¹åŸŸåæœåŠ¡å™¨çš„ä¸»æœºåä¸ IP åœ°å€ã€‚
    
    - Linux ä¸­ bind æœåŠ¡çš„åç§°ä¸º `named`ã€‚
    
    > è‹¥å°†ä»åŒºåŸŸæ–‡ä»¶ä¿å­˜åœ¨ `/var/named/slaves` ä¸­ï¼Œé‚£ä¹ˆå½“ä»æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œå®ƒä¼šå°†è¯¥åŒºåŸŸçš„ç¼“å­˜ç‰ˆæœ¬ä¸ä¸»æœåŠ¡å™¨ä¸Šçš„å½“å‰ç‰ˆæœ¬è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ä¸ºæœ€æ–°çŠ¶æ€ï¼Œåˆ™ä½¿ç”¨å®ƒã€‚è‹¥åŒºåŸŸä¸æ˜¯æœ€æ–°çš„ï¼Œæˆ–è€…æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ named ä¼šæ‰§è¡ŒåŒºåŸŸä¼ é€ï¼Œå¹¶å°†ç»“æœç¼“å­˜åˆ°è¯¥æ–‡ä»¶ä¸­ã€‚
  
  3ï¸âƒ£ é…ç½® bind æœåŠ¡çš„ä¸»é…ç½®æ–‡ä»¶ï¼š
  
  ```bash
  $ sudo vim /etc/named.conf 
  ```
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/named-conf-demo.jpg)

  é€šè¿‡é…ç½®ä¸» DNS æœåŠ¡å™¨ /etc/named.conf æ–‡ä»¶æ¥å®ç°å½“ä¸» DNS æœåŠ¡å™¨ä¸Šçš„åŒºåŸŸå‘ç”Ÿæ›´æ”¹æ—¶é€šçŸ¥æ‰€æœ‰ä» DNS æœåŠ¡å™¨è¿›è¡ŒåŒºåŸŸæ›´æ–°ã€‚
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/named-conf-notify.jpg)
  
  4ï¸âƒ£ é…ç½® bind æœåŠ¡çš„åŒºåŸŸé…ç½®æ–‡ä»¶ï¼š
  
  ```bash
  $ sudo vim /etc/named.rfc1912.zones
  ```
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/named-zone-conf.png)
  
  5ï¸âƒ£ åˆ›å»ºåŒºåŸŸæ•°æ®é…ç½®æ–‡ä»¶ï¼š
  
  ```bash
  $ sudo cp -a /var/named/named.localhost /var/named/lab.example.com.zone
  $ sudo cp -a /var/named/named.lookback /var/named/10.197.11.arpa
  # æ‹·è´æ­£å‘ä¸åå‘è§£ææ–‡ä»¶æ¨¡æ¿ï¼Œå¹¶ä¿æŒåŸæ¥çš„æ‰€å±ç”¨æˆ·ä¸ç”¨æˆ·ç»„
  ```
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/var-named-zone-data-1.jpg)
  
  ```bash
  $ sudo vim /var/named/lab.example.com.zone
  ```
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/var-named-zone-data-2.jpg)
  
  ```bash
  $ sudo vim /var/named/10.197.11.arpa
  ```
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/var-named-zone-data-3.jpg)
  
  6ï¸âƒ£ é‡å¯ bind DNS æœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯åŠ¨ï¼š
  
  ```bash
  $ sudo named-checkconf
  # æ£€æŸ¥ä¸»é…ç½®æ–‡ä»¶ã€åŒºåŸŸé…ç½®æ–‡ä»¶ã€æ­£/åè§£è®°å½•æ–‡ä»¶çš„è¯­æ³•ï¼Œè‹¥å­˜åœ¨é”™è¯¯è¯¥æœåŠ¡å¯åŠ¨å¤±è´¥ã€‚
  $ sudo systemctl enable named.service
  $ sudo systemctl start named.service
  ```

- **ä» DNS æƒå¨æœåŠ¡å™¨éƒ¨ç½²ï¼š**
  
  1ï¸âƒ£ å®‰è£… bind ä¸ç›¸å…³è½¯ä»¶åŒ…ï¼š
  
  ```bash
  $ sudo yum install -y bind bind-utils
  ```
  
  2ï¸âƒ£ é…ç½® bind æœåŠ¡çš„ä¸»é…ç½®æ–‡ä»¶ï¼š
  
  ```bash
  $ sudo vim /etc/named.conf
  ```
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/named-conf-slave.png)
  
  3ï¸âƒ£ é…ç½® bind æœåŠ¡çš„åŒºåŸŸé…ç½®æ–‡ä»¶ï¼š
  
  ```bash
  $ sudo vim /etc/named.rfc1912.zones
  ```
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/named-zone-conf-slave.png)
  
  ```bash
  $ sudo systemctl enable named.service
  $ sudo systemctl start named.service
  # é‡å¯ bind DNS æœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
  ```

- **å®‰å…¨åŠ å¯†ä¼ è¾“ï¼š**
  
  - äº’è”ç½‘ä¸­çš„ç»å¤§å¤šæ•° DNS æœåŠ¡å™¨ï¼ˆè¶…è¿‡95%ï¼‰éƒ½æ˜¯åŸºäº Bind åŸŸåè§£ææœåŠ¡æ­å»ºçš„ï¼Œè€Œ bind æœåŠ¡ä¸ºäº†æä¾›å®‰å…¨çš„è§£ææœåŠ¡ï¼Œå·²ç»å¯¹ `TSIG`ï¼ˆRFC 2845ï¼‰åŠ å¯†æœºåˆ¶æä¾›äº†æ”¯æŒã€‚
  
  - TSIG ä¸»è¦æ˜¯åˆ©ç”¨äº†å¯†ç ç¼–ç çš„æ–¹å¼æ¥ä¿æŠ¤åŒºåŸŸä¿¡æ¯çš„ä¼ è¾“ï¼ˆZone Transferï¼‰ï¼Œå³ TSIG åŠ å¯†æœºåˆ¶ä¿è¯äº† DNS æœåŠ¡å™¨ä¹‹é—´ä¼ è¾“åŸŸååŒºåŸŸä¿¡æ¯çš„å®‰å…¨æ€§ã€‚
  
  - é…ç½®ä¸» DNS æœåŠ¡å™¨åŠ å¯†ä¼ è¾“ï¼š
    
    ```bash
    $ sudo yum install -y bind-chroot
    # å®‰è£… bind-chroot è½¯ä»¶åŒ…
    
    $ dnssec-keygen -a HMAC-MD5 -b 128 -n HOST master-slave
    # å½“å‰ç›®å½•ä¸­ç”Ÿæˆ dnssec å…¬ç§é’¥æ–‡ä»¶
    # ä½¿ç”¨ HMAC-MD5 ç®—æ³•åŠ å¯†ç”Ÿæˆåä¸º master-slave çš„ 128 ä½å¯†é’¥
    ```
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/named-master-sectrans-1.png)
    
    ```bash
    $ sudo vim /var/named/chroot/etc/transfer.key
    # åˆ›å»º dnssec å¯†é’¥éªŒè¯æ–‡ä»¶
    ```
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/named-master-sectrans-2.png)
    
    ```bash
    $ sudo chown root:named /var/named/chroot/etc/transfer.key
    $ sudo chmod 0640 /var/named/chroot/etc/transfer.key
    $ sudo ln /var/named/chroot/etc/transfer.key /etc/transfer.key
    # æ›´æ”¹ dnssec å¯†é’¥éªŒè¯æ–‡ä»¶çš„æ‰€æœ‰è€…ã€æ‰€å±ç»„ã€æƒé™åŠåˆ›å»ºç¡¬é“¾æ¥
    $ sudo ls -lh /var/named/chroot/etc/transfer.key
    ```
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/named-master-sectrans-3.png)
    
    ```bash
    $ sudo vim /etc/named.conf
    # æ·»åŠ å¦‚ä¸‹å‚æ•°å¼€å¯ bind æœåŠ¡çš„å¯†é’¥éªŒè¯åŠŸèƒ½
    ```
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/named-master-sectrans-4.png)
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/named-master-sectrans-5.png)
    
    ```bash
    $ sudo systemctl restart named.service
    # é‡å¯ bind æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ
    ```
  
  - é…ç½®ä» DNS æœåŠ¡å™¨åŠ å¯†ä¼ è¾“ï¼š
    
    ```bash
    $ sudo yum install -y bind-chroot
    # å®‰è£… bind-chroot è½¯ä»¶åŒ…
    
    $ sudo rm -f /var/named/slaves/*
    # åˆ é™¤åŸç¼“å­˜çš„ DNS è®°å½•æ–‡ä»¶
    $ sudo systemctl restart named.service
    # é‡å¯ bind æœåŠ¡
    # ç”±äºä¸» DNS æœåŠ¡å™¨å·²é…ç½®åŠ å¯†ä¼ è¾“ DNS è®°å½•ï¼Œå› æ­¤åœ¨è¯¥ç›®å½•ä¸­ä¸å†ç”Ÿæˆæ–°çš„ DNS è®°å½•ã€‚
    
    $ sudo vim /var/named/chroot/etc/transfer.key
    # åˆ›å»º dnssec å¯†é’¥éªŒè¯æ–‡ä»¶
    ```
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/named-slave-sectrans-1.png)
    
    ```bash
    $ sudo chown root:named /var/named/chroot/etc/transfer.key
    $ sudo chmod 0640 /var/named/chroot/etc/transfer.key
    $ sudo ln /var/named/chroot/etc/transfer.key /etc/transfer.key
    # æ›´æ”¹ dnssec å¯†é’¥éªŒè¯æ–‡ä»¶çš„æ‰€æœ‰è€…ã€æ‰€å±ç»„ã€æƒé™åŠåˆ›å»ºç¡¬é“¾æ¥
    
    $ sudo vim /etc/named.conf
    # æ·»åŠ å¦‚ä¸‹å‚æ•°å¼€å¯ bind æœåŠ¡çš„å¯†é’¥éªŒè¯åŠŸèƒ½
    ```
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/named-slave-sectrans-2.png)
    
    ```bash
    $ sudo systemctl restart named.service
    # é‡å¯ bind æœåŠ¡å³å¯åŠ å¯†ä¼ è¾“åŒæ­¥ DNS è®°å½•æ–‡ä»¶
    ```

- éªŒè¯ DNS è§£ææœåŠ¡ï¼š
  
  - ä½¿ç”¨ `dig`Â å‘½ä»¤éªŒè¯DNSæ­£å‘è§£æç»“æœï¼š
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dig-test-1.png)
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dig-test-2.png)
  
  - ä½¿ç”¨ `dig -x` å‘½ä»¤éªŒè¯ DNS åå‘è§£æç»“æœã€‚
  
  - ä¹Ÿå¯ä½¿ç”¨ `nslookup`Â å‘½ä»¤éªŒè¯ DNS æ­£å‘ä¸åå‘è§£æç»“æœã€‚
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/nslookup-test.jpg)

### dig å‘½ä»¤ä½¿ç”¨ç¤ºä¾‹ï¼š

- `bind-utils` è½¯ä»¶åŒ…æä¾› digã€hostã€nslookupÂ å‘½ä»¤å·¥å…·ã€‚å…¶ä¸­ dig å‘½ä»¤ä¸ºå¸¸ç”¨çš„ DNS æŸ¥è¯¢å·¥å…·ã€‚

- dig å‘½ä»¤è¾“å‡ºå…­æ®µä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dig-usage-1.png)
  
  status çŠ¶æ€é€šå¸¸åŒ…æ‹¬ï¼š
  
  - `NOERROR` çŠ¶æ€ï¼š
    
    è¡¨ç¤ºå·²æˆåŠŸè§£ææŸ¥è¯¢
  
  - `SERVFAIL` çŠ¶æ€ï¼š
    
    å¸¸è§åŸå› æ˜¯ DNS æœåŠ¡å™¨æ— æ³•ä¸æƒå¨åç§°æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ã€‚å¯èƒ½æ˜¯ç”±äºæƒå¨åç§°æœåŠ¡å™¨ä¸å¯ç”¨ã€‚è¿˜å¯èƒ½æ˜¯ç”±äºç½‘ç»œé—®é¢˜å¹²æ‰°äº† DNS æœåŠ¡å™¨ä¸æƒå¨åç§°æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ã€‚
  
  - `NXDOMAIN` çŠ¶æ€ï¼š
    
    1ï¸âƒ£ è¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°ä¸æŸ¥è¯¢çš„åç§°ç›¸å…³è”çš„è®°å½•ã€‚è‹¥æŸ¥è¯¢è¢«å®šå‘åˆ°ä¸€ä¸ªå¯¹è¯¥åç§°æ²¡æœ‰æƒå¨çš„æœåŠ¡å™¨ï¼Œé‚£ä¹ˆæœåŠ¡å™¨çš„ç¼“å­˜å¯èƒ½åŒ…å«åç§°çš„ <font color=red>**è´Ÿç¼“å­˜**</font>ï¼ˆè¯¥ç¼“å­˜å¯¹æ­£ç¡®æŸ¥è¯¢äº§ç”Ÿå¹²æ‰°ï¼‰ã€‚ç”¨æˆ·å¯ä»¥ç­‰å¾…æœåŠ¡å™¨ä½¿è¯¥åç§°çš„è´Ÿç¼“å­˜åˆ°æœŸï¼Œæˆ–è€…å‘æœåŠ¡å™¨ç®¡ç†å‘˜æäº¤è¯·æ±‚ï¼Œä»æœåŠ¡å™¨çš„ç¼“å­˜ä¸­æ¸…ç©ºåç§°ã€‚ä»ç¼“å­˜ä¸­åˆ é™¤åç§°åï¼ŒæœåŠ¡å™¨å°†æŸ¥è¯¢æƒå¨åç§°æœåŠ¡å™¨ä»¥æ¥æ”¶è¯¥åç§°çš„å½“å‰èµ„æºè®°å½•ã€‚å¦‚ï¼Œæƒå¨åç§°æœåŠ¡å™¨å·²æ›´æ–°è‡³æœ€æ–°çš„åç§°è§£æï¼Œä½†ç¼“å­˜åç§°æœåŠ¡å™¨çš„ TTL å°šæœ‰ä½™æœŸï¼Œå› æ­¤å¯æ¸…ç©ºç¼“å­˜å†è¿›è¡ŒæŸ¥è¯¢ï¼ŒåŒæ—¶å¯é™ä½ TTL æ—¶é—´è§£å†³æ­¤é—®é¢˜ã€‚
    
    2ï¸âƒ£ å¯èƒ½å‡ºç° NXDOMAIN è¿”å›ä»£ç çš„å¦ä¸€ç§æƒ…å†µæ˜¯åœ¨æŸ¥è¯¢åŒ…å« `orphaned CNAME` çš„ `CNAME` è®°å½•æ—¶ã€‚åœ¨ CNAME è®°å½•ä¸­ï¼Œè®°å½•å³ä¾§çš„åç§°ï¼ˆå³è§„èŒƒåç§°ï¼‰åº”æŒ‡å‘ä¸€ä¸ªåŒ…å« A æˆ– AAAA è®°å½•çš„åç§°ã€‚å¦‚æœè¿™äº›å…³è”çš„è®°å½•ä¸å­˜åœ¨æˆ–è€…ä¹‹åè¢«åˆ é™¤ï¼Œåˆ™ CNAME è®°å½•ä¸­çš„è§„èŒƒåç§°å°†å˜ä¸ºå­¤ç«‹ã€‚å‘ç”Ÿæ­¤æƒ…å†µæ—¶ï¼Œå¯¹ CNAME è®°å½•ä¸­æ‰€æœ‰è€…åç§°çš„æŸ¥è¯¢å°†ä¸å†å¯è§£æï¼Œå¹¶ä¸”å°†å¯¼è‡´ NXDOMAIN è¿”å›ä»£ç ã€‚
  
  - `REFUSED` çŠ¶æ€ï¼š
    
    è¡¨ç¤º DNS æœåŠ¡å™¨çš„æŸä¸ªç­–ç•¥é™åˆ¶é˜»æ­¢äº†å…¶å®¢æˆ·ç«¯çš„æŸ¥è¯¢ã€‚ç­–ç•¥é™åˆ¶é€šå¸¸æ˜¯åœ¨ DNS æœåŠ¡å™¨ä¸Šå®æ–½ï¼Œä»¥é™åˆ¶å“ªäº›å®¢æˆ·ç«¯å¯ä»¥è¿›è¡Œé€’å½’æŸ¥è¯¢å’ŒåŒºåŸŸä¼ è¾“è¯·æ±‚ã€‚å¯¼è‡´ REFUSED è¿”å›ä»£ç çš„ä¸€äº›å¸¸è§åŸå› æ˜¯å®¢æˆ·ç«¯é…ç½®ä¸ºæŸ¥è¯¢é”™è¯¯çš„ DNS æœåŠ¡å™¨ï¼Œæˆ–è€… DNS æœåŠ¡å™¨é…ç½®é”™è¯¯å¯¼è‡´æœ‰æ•ˆçš„å®¢æˆ·ç«¯è¯·æ±‚è¢«æ‹’ç»ï¼ˆå¦‚å‰æ–‡çš„ unbound ç¼“å­˜åç§°æœåŠ¡å™¨é…ç½®ï¼‰ã€‚
  
  ğŸ· flags æ ‡è®°çš„è¯´æ˜ï¼š
  
  - `aa` ä»£è¡¨æƒå¨åç§°æœåŠ¡å™¨ï¼Œè€Œæºè‡ªç¼“å­˜åç§°æœåŠ¡å™¨çš„å“åº”ä¸æ˜¯æƒå¨çš„ï¼Œå› æ­¤ä¸è®¾ç½® aa æ ‡å¿—ã€‚
  
  - åº”ç­”æ¥è‡ªç¼“å­˜çš„å¦ä¸€ä¸ªè¿¹è±¡æ˜¯åç»­æŸ¥è¯¢çš„å“åº”ä¸­èµ„æºè®°å½•çš„ TTL å€¼çš„å‡å°‘ã€‚ç¼“å­˜æ•°æ®çš„ TTL è¿ç»­å€’æ•°åˆ°è¿‡æœŸï¼Œè€Œæƒå¨æ•°æ®çš„ TTL å§‹ç»ˆä¸ºé™æ€ã€‚

- å¸¸ç”¨å‘½ä»¤ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š
  
  ```bash
  $ dig <domain_name>
  $ dig +short <domain_name>
  # åªæŸ¥è¯¢è¿”å›å¯¹åº”åŸŸåçš„ IP åœ°å€ï¼ˆA è®°å½•ä¸­çš„ IP åœ°å€ï¼‰
  ```
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dig-usage-2.png)
  
  ```bash
  $ dig +trace <domain_name> @<dnsserver_ip>
  # ä½¿ç”¨æŒ‡å®šçš„ DNS æœåŠ¡å™¨æŸ¥è¯¢è¿½è¸ªæ•´ä¸ª DNS åˆ†çº§æŸ¥è¯¢è¿‡ç¨‹ 
  ```
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dig-usage-3.png)
  
  ```bash
  $ dig [+short] ns com
  $ dig [+short] ns stackexchange.com
  # æŸ¥è¯¢ä¸åŒå±‚çº§åŸŸä¸­çš„ NS æœåŠ¡å™¨åŠå¯¹åº”çš„ A ä¸ AAAA è®°å½•
  ```
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dig-usage-4.png)
  
  ```bash
  $ dig +[short|trace] [a|ns|soa|cname|mx] <domain_name> @<dnsserver_ip>
  # æŒ‡å®š DNS æœåŠ¡å™¨é’ˆå¯¹ä¸åŒçš„è®°å½•ç±»å‹å¯¹åŸŸåè¿›è¡Œè¿½è¸ªæŸ¥è¯¢æˆ–åªè¿”å›ç®€è¦ç»“æœ
  # å…¶ä¸­åŸŸåå¯ä¸º comã€github.comã€www.baidu.com ç­‰ï¼ŒDNS æœåŠ¡å™¨å¯ä¸ºæœ¬åœ° DNS æœåŠ¡å™¨æˆ–
  # å…¬å…± DNS æœåŠ¡å™¨ã€‚ 
  ```

- ğŸ’¥ å…³äº DNS ä½¿ç”¨çš„åè®®ç±»å‹ï¼š
  
  å°½ç®¡ DNS å¤§å¤šæ•°ä½¿ç”¨ `UDP` åè®®ï¼Œä½†å½“å“åº”çš„å¤§å°è¶…è¿‡ `512` å­—èŠ‚ï¼ˆæ”¯æŒ DNS (`EDNS`) æ‰©å±•æœºåˆ¶çš„ DNS è§£æå™¨å’ŒæœåŠ¡å™¨ä¸º `4096` å­—èŠ‚ï¼‰æ—¶ï¼Œè§£æå™¨å¿…é¡»ä» UDP åˆ‡æ¢åˆ° TCPï¼Œå†é‡è¯•æŸ¥è¯¢ã€‚è‹¥å…è®¸ 53/UDP ç«¯å£ä¸Šçš„æµé‡ï¼Œä½†ä¸å…è®¸ 53/TCP ç«¯å£ä¸Šçš„æµé‡ï¼Œåˆ™åœ¨è§£æå™¨é‡åˆ°è¶…è¿‡å…¶å¯ä»¥é€šè¿‡ UDP å¤„ç†çš„å“åº”æ—¶ï¼Œå°†çœ‹åˆ°æˆªæ–­é€šçŸ¥ï¼Œåè·Ÿä¸»æœºæ— æ³•è®¿é—®çš„æŠ¥é”™ã€‚
  
  ```bash
  $ dig A labhost1.example.com @dns.example.com
    ;; Truncated, retrying in TCP mode.
    ;; Connection to 172.25.1.11#53(172.25.1.11) for labhost1.example.com failed: host unreachable.
  ```
  
  å°† `tcp` æˆ– `vc` é€‰é¡¹ä¸ dig é…åˆä½¿ç”¨ï¼Œä»¥å¸®åŠ©ç¡®å®š DNS æŸ¥è¯¢æ˜¯å¦å¯ä»¥é€šè¿‡ TCP æˆåŠŸè¿›è¡Œã€‚è¿™äº›é€‰é¡¹å¼ºåˆ¶ dig ä½¿ç”¨ TCPï¼Œè€Œéè¡¨ç°å¦‚ä¸‹é»˜è®¤è¡Œä¸ºï¼šé¦–å…ˆä½¿ç”¨ UDPï¼Œä»…å½“é‡åˆ°è¾ƒå¤§å“åº”æ—¶æ‰å›é€€ä¸ºä½¿ç”¨ TCPã€‚
  
  ```bash
  $ dig +tcp A workstation.lab.example.com @172.25.250.254
  # å¼ºåˆ¶ä½¿ç”¨ TCP åè®®æŸ¥è¯¢æŒ‡å®šä¸»æœºçš„ A è®°å½•
  ```

### host å‘½ä»¤ä½¿ç”¨ç¤ºä¾‹ï¼š

- host å‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•ä¸ dig å‘½ä»¤éå¸¸ç±»ä¼¼ï¼Œå¯è§†ä¸º dig å‘½ä»¤çš„ç®€åŒ–ç‰ˆã€‚

- å¦‚ä¸‹æ‰€ç¤ºï¼š
  
  ```bash
  $ host <domain_name>
  # æŸ¥çœ‹ DNS æ­£å‘è§£æè®°å½•
  $ host <ip_address>
  # æŸ¥çœ‹ DNS åå‘è§£æè®°å½•ï¼Œç±»ä¼¼ dig -x å‘½ä»¤ã€‚
  ```
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/host-usage.png)

### nslookup å‘½ä»¤ä½¿ç”¨ç¤ºä¾‹ï¼š

- nslookup å‘½ä»¤æœ‰äº¤äº’å¼å’Œéäº¤äº’å¼ä¸¤ç§å·¥ä½œæ¨¡å¼ã€‚

- åœ¨å‘½ä»¤è¡Œä¸­ç›´æ¥è¾“å…¥ nslookupï¼Œæ— éœ€è¾“å…¥ä»»ä½•å‚æ•°å³è¿›å…¥äº¤äº’æ¨¡å¼ï¼Œç”± `>` æç¤ºã€‚

- äº¤äº’æ¨¡å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/nslookup-usage-1.png)
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/nslookup-usage-2.png)
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/nslookup-usage-3.png)

- éäº¤äº’æ¨¡å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
  
  ```bash
  $ nslookup -type=soa <domain_name>
  # æŸ¥çœ‹ç›¸åº”åŸŸåçš„ SOA è®°å½•ï¼Œä¸ dig soa å‘½ä»¤ç±»ä¼¼ã€‚
  ```
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/nslookup-usage-4.png)
  
  ```bash
  $ nslookup -type=ns <domain_name>
  # æŸ¥çœ‹ç›¸åº”åŸŸåçš„ NS è®°å½•ï¼Œä¸ dig ns å‘½ä»¤ç±»ä¼¼ã€‚ 
  ```
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/nslookup-usage-5.png)
  
  ```bash
  $ nslookup -type=a <domain_name>
  # æŸ¥çœ‹ç›¸åº”åŸŸåçš„ A è®°å½•ï¼Œä¸ dig å‘½ä»¤æˆ– dig a å‘½ä»¤ç±»ä¼¼ã€‚
  ```
  
  ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/nslookup-usage-6.png)

### DNS å®‰å…¨é—®é¢˜ï¼š

- åŸŸåæŠ¢æ³¨ï¼š
  
  æœ‰äº›é»„ç‰›ä¼šæ‰¹é‡æŠ¢æ³¨å¤§é‡åŸŸåï¼Œç„¶åè½¬èº«é«˜ä»·å–ç»™é‚£äº›å¯¹åŸŸåæ„Ÿå…´è¶£çš„äººï¼Œè°‹å–æš´åˆ©ã€‚

- DNS ç¼“å­˜æ±¡æŸ“ï¼š
  
  ä¸­é—´ DNS æœåŠ¡å™¨å°†ä¸Šçº§æœåŠ¡å™¨è¿”å›ç»“æœè¿›è¡Œä¿®æ”¹ï¼Œç»™å®¢æˆ·ç«¯ä¸€ä¸ªæ”¹å˜äº†ï¼ˆæ±¡æŸ“ï¼‰çš„ä¿¡æ¯ã€‚

- DNS åŠ«æŒï¼š
  
  - ä¸Â DNS ç¼“å­˜æ±¡æŸ“æ¯”è¾ƒç±»ä¼¼ï¼Œä¸è¿‡è¿™ç§å¯ä»¥è¢«å¤–éƒ¨ç¬¬ä¸‰è€…åŠ«æŒè¿›è¡Œæ¶æ„ä¿®æ”¹ã€‚
  
  - æœ‰äº›æ¶æ„çš„åŸŸåæœåŠ¡å™¨æ•…æ„æ›´æ”¹ä¸€äº›åŸŸåçš„è§£æç»“æœï¼Œå°†ç”¨æˆ·å¼•å‘ä¸€ä¸ªé”™è¯¯çš„ç›®æ ‡åœ°å€ï¼Œè¿™ç§ç§°ä¸º DNS åŠ«æŒï¼Œä¸»è¦ç”¨æ¥é˜»æ­¢ç”¨æˆ·è®¿é—®æŸäº›ç‰¹å®šçš„ç½‘ç«™ï¼Œæˆ–è€…æ˜¯å°†ç”¨æˆ·å¼•å¯¼åˆ°å¹¿å‘Šé¡µé¢ã€‚
  
  - å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dns-hijack.png)

- DNS æ¬ºéª—ï¼š
  
  - ä½¿ç”¨å‡çš„ DNS åº”ç­”æ¥æ¬ºéª—ç”¨æˆ·ï¼Œä½¿å…¶ç›¸ä¿¡è¯¥å‡åœ°å€ï¼Œå¹¶ä¸”æŠ›å¼ƒçœŸæ­£çš„ DNS åº”ç­”ã€‚
  
  - åœ¨ä¸€å°ä¸»æœºå‘å‡º DNS è¯·æ±‚åï¼Œå®ƒå°±å¼€å§‹ç­‰å¾…åº”ç­”ï¼Œå¦‚æœæ­¤æ—¶æœ‰ä¸€ä¸ªçœ‹èµ·æ¥æ­£ç¡®ï¼ˆæ‹¥æœ‰å’Œ DNS è¯·æ±‚ä¸€æ ·çš„åºåˆ—å·ï¼‰çš„åº”ç­”åŒ…ï¼Œå®ƒå°±ä¼šä¿¡ä»¥ä¸ºçœŸï¼Œå¹¶ä¸”ä¸¢å¼ƒç¨æ™šä¸€ç‚¹åˆ°è¾¾çš„åº”ç­”ã€‚
  
  - å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
    
    ![](https://github.com/Alberthua-Perl/tech-docs/blob/master/images/dns/dns-cheat.png)
  
  - é€šå¸¸å¯é…ç½® bindã€unbound ç¼“å­˜åç§°æœåŠ¡å™¨çš„ DNSSEC éªŒè¯é¢„é˜² DNS æ¬ºéª—çš„å‘ç”Ÿã€‚

- DNS æ”¾å¤§æ”»å‡»ï¼š
  
  ä¸€ç§ `DDoS` æ”»å‡»ï¼Œåˆ©ç”¨ DNS å›å¤åŒ…æ¯”è¯·æ±‚åŒ…å¤§çš„ç‰¹ç‚¹ï¼Œæ”¾å¤§æµé‡ï¼Œä¼ªé€ è¯·æ±‚åŒ…çš„æº IP åœ°å€ä¸ºå—å®³è€… IPï¼Œå°†åº”ç­”åŒ…çš„æµé‡å¼•å…¥å—å®³è€…çš„æœåŠ¡å™¨ã€‚

- ç³»ç»Ÿä¸Šè¿è¡Œçš„ DNS æœåŠ¡å­˜åœ¨æ¼æ´ï¼Œå¯¼è‡´è¢«é»‘å®¢è·å–æƒé™ï¼Œä»è€Œç¯¡æ”¹ DNS ä¿¡æ¯ã€‚

- DNS è®¾ç½®ä¸å½“ï¼Œå¯¼è‡´æ³„æ¼ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œæä¾›ç»™é»‘å®¢è¿›ä¸€æ­¥æ”»å‡»æä¾›æœ‰åŠ›ä¿¡æ¯ã€‚

### å‚è€ƒé“¾æ¥ï¼š

- [ä½¿ç”¨ nsswitch æ§åˆ¶ Linux DNS è§£æé¡ºåº](https://www.cnblogs.com/shengulong/p/7019260.html)
- [Linux åº”ç”¨ - ä½¿ç”¨ nscd ä½œä¸ºæœ¬åœ° DNS ç¼“å­˜](https://blog.csdn.net/qq_35550345/article/details/107045573?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_v2~rank_aggregation-1-107045573.pc_agg_rank_aggregation&utm_term=linux+%E6%9C%AC%E5%9C%B0dns%E7%BC%93%E5%AD%98%E6%97%B6%E9%97%B4&spm=1000.2123.3001.4430)
- [8 ä¸ªé—®é¢˜å½»åº•æé€ DNS åè®®](https://mp.weixin.qq.com/s?__biz=MzI1OTY2MzMxOQ==&mid=2247488895&idx=1&sn=41b86262b7e7a689fcb30e4f9f7a6ab4&chksm=ea7421c7dd03a8d1ca18194f3b23b64d6bb020597d5979e322b3ac349102d1786ddadbd88dca&mpshare=1&srcid=&sharer_sharetime=1592995451255&sharer_shareid=da47a1ec8f737b150ddf73eced1d76b6&from=timeline&scene=2&subscene=1&clicktime=1592996648&enterid=1592996648&ascene=2&devicetype=android-28&version=27000f51&nettype=WIFI&abtest_cookie=AAACAA%3D%3D&lang=zh_CN&exportkey=AZaUKR5o%2BgsYr2%2B%2By%2FBAcso%3D&pass_ticket=YnXHtAKfkz6t4LIK%2BVqP%2BmSSHxZrJFJ49y%2F3zM6ki4q%2FGl2BK6PNtO%2FD9F9DvJTk&wx_header=1)
- [DNS åŸç†å…¥é—¨](http://www.ruanyifeng.com/blog/2016/06/dns.html)
- [ä½¿ç”¨ Bind æä¾›åŸŸåè§£ææœåŠ¡](https://www.linuxprobe.com/chapter-13.html)
- [CentOS 7 å®‰è£…é…ç½®æœ¬åœ° DNSï¼ˆBINDï¼‰æœåŠ¡å™¨ï¼ˆMaster-Slaveï¼‰](https://www.kclouder.cn/centos-7-dns-bind/)
- [DNS åŸŸåæœåŠ¡Bindï¼ˆä¸­ï¼‰- Bind é…ç½®æ–‡ä»¶](https://blog.csdn.net/ysdaniel/article/details/6994109)
- [Linux DNS ä¹‹ nslookup å‘½ä»¤](https://cloud.tencent.com/developer/article/1083201)
- [4.5. Securing DNS Traffic with DNSSEC](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/security_guide/index#sec-Securing_DNS_Traffic_with_DNSSEC)
- [é€šè¿‡å‘ DNS æœåŠ¡å‘é€ SRV æŸ¥è¯¢è¯·æ±‚è·å– kubernetes é›†ç¾¤å†…æ‰€æœ‰ Service ä¿¡æ¯](https://mozillazg.com/2021/11/security-use-dns-srv-to-get-all-service-info.html#)
